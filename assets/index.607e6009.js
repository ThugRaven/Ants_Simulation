var Ae=Object.defineProperty;var Te=(s,t,e)=>t in s?Ae(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var l=(s,t,e)=>(Te(s,typeof t!="symbol"?t+"":t,e),e);const we=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerpolicy&&(o.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?o.credentials="include":n.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(n){if(n.ep)return;n.ep=!0;const o=e(n);fetch(n.href,o)}};we();const Vt={WIDTH:1600*3,HEIGHT:1200*3};var V=(s=>(s[s.TO_HOME=0]="TO_HOME",s[s.TO_FOOD=1]="TO_FOOD",s))(V||{});const yt={TO_HOME:[255,0,0],TO_FOOD:[43,255,0]},c={WIDTH:16,HEIGHT:16,SIZE:16},Kt=2e-4,k={COLONY_RADIUS:50,COLONY_STARTING_ANTS:25,COLONY_MAX_ANTS:250,COLONY_MAX_FOOD:12500,ANT_CREATION_PERIOD:.15,ANT_COST:30,ANT_REFILL_FOOD_AMOUNT:.25};var f=(s=>(s[s.TO_HOME=0]="TO_HOME",s[s.TO_FOOD=1]="TO_FOOD",s[s.REFILL=2]="REFILL",s))(f||{});const a={IMG_WIDTH:24,IMG_HEIGHT:34,WANDER_DISPLACE_RANGE:.5,WANDER_POINT_MAGNITUDE:100,WANDER_POINT_RADIUS:50,PERCEPTION_RADIUS:80,PERCEPTION_START_ANGLE:7/6*Math.PI,PERCEPTION_END_ANGLE:11/6*Math.PI,PERCEPTION_POINTS_HORIZONTAL:8,PERCEPTION_POINTS_VERTICAL:5,MARKER_PERIOD:.15,MARKER_DEFAULT_INTENSITY:1,AUTONOMY_MAX:300,AUTONOMY_REFILL:150,FOOD_SIZE:16},E={SIZE:15,PICK_AMOUNT:2},bt=2,Pe=4,gt=c.SIZE,$={MIN_SIZE:1,MAX_SIZE:75,STEP:1};function C(s,t,e,i,n=!0,o=!1){s.beginPath(),s.arc(t,e,i,0,Math.PI*2),n&&s.fill(),o&&s.stroke()}function W(s,t,e,i,n){s.beginPath(),s.moveTo(t,e),s.lineTo(i,n),s.stroke(),s.closePath()}function ot(s,t){return Math.random()*(t-s)+s}function T(s,t,e){return s=!s,s?(t.style.display="block",e==null||e.classList.add("border-green-500"),e==null||e.classList.remove("border-red-500")):(t.style.display="none",e==null||e.classList.add("border-red-500"),e==null||e.classList.remove("border-green-500")),s}function dt(s,t){return s=!s,s?(t.classList.add("border-green-500"),t.classList.remove("border-red-500")):(t.classList.add("border-red-500"),t.classList.remove("border-green-500")),s}class S{constructor(t,e,i){l(this,"x");l(this,"y");l(this,"z");this.x=t||0,this.y=e||0,this.z=i||0}set(t,e,i){return t instanceof S?(this.x=t.x||0,this.y=t.y||0,this.z=t.z||0,this):t instanceof Array?(this.x=t[0]||0,this.y=t[1]||0,this.z=t[2]||0,this):(this.x=t||0,this.y=e||0,this.z=i||0,this)}copy(){return new S(this.x,this.y,this.z)}add(t,e,i){return t instanceof S?(this.x+=t.x||0,this.y+=t.y||0,this.z+=t.z||0,this):t instanceof Array?(this.x+=t[0]||0,this.y+=t[1]||0,this.z+=t[2]||0,this):(this.x+=t||0,this.y+=e||0,this.z+=i||0,this)}sub(t,e,i){return t instanceof S?(this.x-=t.x||0,this.y-=t.y||0,this.z-=t.z||0,this):t instanceof Array?(this.x-=t[0]||0,this.y-=t[1]||0,this.z-=t[2]||0,this):(this.x-=t||0,this.y-=e||0,this.z-=i||0,this)}mult(t,e,i){if(t instanceof S)return Number.isFinite(t.x)&&Number.isFinite(t.y)&&Number.isFinite(t.z)&&typeof t.x=="number"&&typeof t.y=="number"&&typeof t.z=="number"?(this.x*=t.x,this.y*=t.y,this.z*=t.z):console.warn("Vector.mult:","x contains components that are either undefined or not finite numbers"),this;if(t instanceof Array)return t.every(o=>Number.isFinite(o))&&t.every(o=>typeof o=="number")?t.length===1?(this.x*=t[0],this.y*=t[0],this.z*=t[0]):t.length===2?(this.x*=t[0],this.y*=t[1]):t.length===3&&(this.x*=t[0],this.y*=t[1],this.z*=t[2]):console.warn("Vector.mult:","x contains elements that are either undefined or not finite numbers"),this;const n=[...arguments];return n.every(o=>Number.isFinite(o))&&n.every(o=>typeof o=="number")?(arguments.length===1&&(this.x*=t,this.y*=t,this.z*=t),arguments.length===2&&(this.x*=t,this.y*=e||0),arguments.length===3&&(this.x*=t,this.y*=e||0,this.z*=i||0)):console.warn("Vector.mult:","x, y, or z arguments are either undefined or not a finite number"),this}div(t,e,i){if(t instanceof S){if(Number.isFinite(t.x)&&Number.isFinite(t.y)&&Number.isFinite(t.z)&&typeof t.x=="number"&&typeof t.y=="number"&&typeof t.z=="number"){if(t.x===0||t.y===0||t.z===0)return console.warn("Vector.div:","divide by 0"),this;this.x/=t.x,this.y/=t.y,this.z/=t.z}else console.warn("Vector.div:","x contains components that are either undefined or not finite numbers");return this}if(t instanceof Array){if(t.every(o=>Number.isFinite(o))&&t.every(o=>typeof o=="number")){if(t.some(o=>o===0))return console.warn("Vector.div:","divide by 0"),this;t.length===1?(this.x/=t[0],this.y/=t[0],this.z/=t[0]):t.length===2?(this.x/=t[0],this.y/=t[1]):t.length===3&&(this.x/=t[0],this.y/=t[1],this.z/=t[2])}else console.warn("Vector.div:","x contains components that are either undefined or not finite numbers");return this}const n=[...arguments];if(n.every(o=>Number.isFinite(o))&&n.every(o=>typeof o=="number")){if(n.some(o=>o===0))return console.warn("Vector.div:","divide by 0"),this;arguments.length===1&&(this.x/=t,this.y/=t,this.z/=t),arguments.length===2&&(this.x/=t,this.y/=e||0),arguments.length===3&&(this.x/=t,this.y/=e||0,this.z/=i||0)}else console.warn("Vector.div:","x, y, or z arguments are either undefined or not a finite number");return this}mag(){return Math.sqrt(this.magSq())}magSq(){const t=this.x,e=this.y,i=this.z;return t*t+e*e+i*i}dist(t){return t.copy().sub(this).mag()}normalize(){const t=this.mag();return t!==0&&this.mult(1/t),this}limit(t){const e=this.magSq();return e>t*t&&this.div(Math.sqrt(e)).mult(t),this}setMag(t){return this.normalize().mult(t)}heading(){return Math.atan2(this.y,this.x)}setHeading(t){let e=this.mag();return this.x=e*Math.cos(t),this.y=e*Math.sin(t),this}rotate(t){let e=this.heading()+t;const i=this.mag();return this.x=Math.cos(e)*i,this.y=Math.sin(e)*i,this}equals(t,e,i){let n,o,r;return t instanceof S?(n=t.x||0,o=t.y||0,r=t.z||0):t instanceof Array?(n=t[0]||0,o=t[1]||0,r=t[2]||0):(n=t||0,o=e||0,r=i||0),this.x===n&&this.y===o&&this.z===r}}function K(s,t,e){return new S(s,t,e)}class jt{constructor(t,e,i,n,o){l(this,"ctx");l(this,"antImageInstance");l(this,"antFoodImageInstance");l(this,"antIcon");l(this,"id");l(this,"pos");l(this,"vel");l(this,"acc");l(this,"maxSpeed");l(this,"maxForce");l(this,"state");l(this,"debug");l(this,"wanderTheta");l(this,"perceptionDraw");l(this,"internalClock");l(this,"markerClock");l(this,"isDead");l(this,"freedomCoef");l(this,"foodAmount");l(this,"maxAutonomy");this.ctx=t,this.antImageInstance=e,this.antFoodImageInstance=i,this.antIcon=n,this.id=o.id,this.pos=K(o.pos.x,o.pos.y),this.vel=K(0,0),this.acc=K(0,0),this.maxSpeed=4,this.maxForce=.25,this.state=f.TO_FOOD,this.debug=o.debug||!1,this.wanderTheta=ot(0,Math.PI*2),this.perceptionDraw=new Set,this.internalClock=0,this.markerClock=ot(0,a.MARKER_PERIOD),this.isDead=!1,this.freedomCoef=ot(.01,.1),this.foodAmount=0,this.maxAutonomy=a.AUTONOMY_MAX-ot(0,50)}seek(t){this.debug&&(this.ctx.strokeStyle="white",W(this.ctx,t.x,t.y,this.pos.x,this.pos.y));let e=t.copy().sub(this.pos);e.setMag(this.maxSpeed),e.sub(this.vel),e.limit(this.maxForce),this.applyForce(e)}wander(){let t=this.vel.copy();t.setMag(a.WANDER_POINT_MAGNITUDE),t.add(this.pos);let e=a.WANDER_POINT_RADIUS;this.debug&&(this.ctx.fillStyle="red",C(this.ctx,t.x,t.y,4),this.ctx.strokeStyle="white",C(this.ctx,t.x,t.y,e,!1,!0),W(this.ctx,this.pos.x,this.pos.y,t.x,t.y));let i=this.wanderTheta+this.vel.heading(),n=e*Math.cos(i),o=e*Math.sin(i);t.add(n,o),this.debug&&(this.ctx.fillStyle="green",C(this.ctx,t.x,t.y,8),W(this.ctx,this.pos.x,this.pos.y,t.x,t.y));let r=t.sub(this.pos);r.setMag(this.maxForce),r.limit(this.maxForce),this.applyForce(r);let m=a.WANDER_DISPLACE_RANGE;this.wanderTheta+=ot(-m,m)}applyForce(t){this.acc.add(t)}update(t){this.internalClock+=t,this.internalClock>=a.AUTONOMY_REFILL&&this.state===f.TO_FOOD&&(this.state=f.REFILL),this.internalClock>=this.maxAutonomy&&(this.isDead=!0),this.vel.add(this.acc),this.vel.limit(this.maxSpeed),this.pos.add(this.vel),this.acc.set(0,0)}draw(){this.ctx.save(),this.ctx.translate(this.pos.x,this.pos.y),this.ctx.rotate(this.vel.heading()+Math.PI/2);let t=-a.IMG_WIDTH/2,e=-a.IMG_HEIGHT/2;if(this.state===f.TO_HOME&&this.ctx.drawImage(this.antFoodImageInstance,-a.FOOD_SIZE/2,e-a.FOOD_SIZE/2),this.ctx.drawImage(this.antImageInstance,t,e),this.debug){this.ctx.strokeStyle="#FF0000",this.ctx.lineWidth=2,this.ctx.strokeRect(t,e,a.IMG_WIDTH,a.IMG_HEIGHT),this.ctx.fillStyle="red",C(this.ctx,0,0,4),this.ctx.beginPath(),this.ctx.arc(0,0,a.PERCEPTION_RADIUS,a.PERCEPTION_START_ANGLE,a.PERCEPTION_END_ANGLE),this.ctx.stroke(),this.ctx.strokeStyle="white",this.ctx.beginPath(),this.ctx.arc(0,0,a.PERCEPTION_RADIUS,a.PERCEPTION_END_ANGLE,a.PERCEPTION_START_ANGLE),this.ctx.stroke();let i=a.PERCEPTION_START_ANGLE,n=a.PERCEPTION_END_ANGLE,o=a.PERCEPTION_RADIUS*Math.cos(i),r=a.PERCEPTION_RADIUS*Math.sin(i),m=a.PERCEPTION_RADIUS*Math.cos(n),y=a.PERCEPTION_RADIUS*Math.sin(n);this.ctx.strokeStyle="red",W(this.ctx,0,0,o,r),W(this.ctx,0,0,m,y);let p=(a.PERCEPTION_END_ANGLE-a.PERCEPTION_START_ANGLE)/(a.PERCEPTION_POINTS_HORIZONTAL-1),tt=a.PERCEPTION_RADIUS/a.PERCEPTION_POINTS_VERTICAL;for(let L=0;L<a.PERCEPTION_POINTS_HORIZONTAL;L++)for(let _=1;_<=a.PERCEPTION_POINTS_VERTICAL;_++){let D=p*L+a.PERCEPTION_START_ANGLE,et=tt*_*Math.cos(D),st=tt*_*Math.sin(D);this.perceptionDraw.has(_*a.PERCEPTION_POINTS_VERTICAL+L)?(this.ctx.strokeStyle="white",this.ctx.fillStyle="white"):(this.ctx.strokeStyle="red",this.ctx.fillStyle="green"),C(this.ctx,et,st,4),_===a.PERCEPTION_POINTS_VERTICAL&&W(this.ctx,0,0,et,st)}}this.ctx.restore(),this.debug&&(this.ctx.fillStyle="white",C(this.ctx,this.pos.x,this.pos.y,3))}search(t,e){this.debug&&(this.perceptionDraw=new Set);let i=this.vel.copy();i.setMag(a.IMG_HEIGHT/2),i.add(this.pos);let n=t.getCellFromCoordsSafe(i.x,i.y),o=t.getCellFromCoordsSafe(this.pos.x,this.pos.y);if(o==null||o.addDensity(),n&&n.food.quantity>0&&(this.state===f.TO_FOOD||this.state===f.REFILL)){this.state=f.TO_HOME,this.foodAmount=n.pick(),this.vel.setHeading(this.vel.heading()+Math.PI),this.internalClock=0;return}if(o&&o.colony&&(this.state===f.REFILL||this.state===f.TO_HOME)){if(this.state===f.TO_HOME&&(this.vel.setHeading(this.vel.heading()+Math.PI),e.addFood(this.foodAmount)),this.state===f.REFILL&&!e.useFood(k.ANT_REFILL_FOOD_AMOUNT))return;this.state=f.TO_FOOD,this.internalClock=0;return}if(Math.random()<this.freedomCoef)return;let r=(a.PERCEPTION_END_ANGLE-a.PERCEPTION_START_ANGLE)/(a.PERCEPTION_POINTS_HORIZONTAL-1),m=a.PERCEPTION_RADIUS/a.PERCEPTION_POINTS_VERTICAL,y=a.PERCEPTION_POINTS_VERTICAL+1,p=null,tt=0,L=null,_=this.vel.heading(),D=-a.IMG_WIDTH/2,et=Math.PI/4+_+Math.PI,st=-Math.PI/4+_+Math.PI,Ee=D*Math.cos(et),pe=D*Math.sin(et),Ce=D*Math.cos(st),Oe=D*Math.sin(st),Pt=this.pos.copy().add(Ee,pe),_t=this.pos.copy().add(Ce,Oe),xt=t.getCellFromCoordsSafe(Pt.x,Pt.y),Yt=t.getCellFromCoordsSafe(_t.x,_t.y);if(xt&&xt.wall===1||Yt&&Yt.wall===1){let O=(xt?Pt:_t).sub(this.pos);O.sub(this.vel),O.mult(-1),this.applyForce(O);return}for(let it=0;it<a.PERCEPTION_POINTS_HORIZONTAL;it++)for(let O=1;O<=a.PERCEPTION_POINTS_VERTICAL;O++){let Xt=r*it+a.PERCEPTION_START_ANGLE+_+Math.PI/2,Se=m*O*Math.cos(Xt),Me=m*O*Math.sin(Xt),q=this.pos.copy().add(Se,Me),G=t.getCellFromCoordsSafe(q.x,q.y);if(G){if(G.wall===1&&O===1){let nt=q.sub(this.pos);nt.setMag(this.maxSpeed),nt.sub(this.vel),nt.limit(this.maxForce),this.debug,nt.mult(-1),this.applyForce(nt);break}if(G.colony&&(this.state===f.REFILL||this.state===f.TO_HOME)){this.seek(q);return}if(G.food.quantity>0&&(this.state===f.TO_FOOD||this.state===f.REFILL)){this.debug&&this.perceptionDraw.add(O*a.PERCEPTION_POINTS_VERTICAL+it),O<y&&(y=O,p=q);break}let mt=0;this.state===f.TO_HOME||this.state===f.REFILL?mt=G.marker.intensity[0]:(this.state===f.TO_FOOD||this.state===f.REFILL)&&(mt=G.marker.intensity[1]),mt>tt&&(tt=mt,L=q)}}if(p){this.seek(p);return}if(L){this.seek(L);return}this.wander()}addMarker(t,e){if(this.markerClock+=e,this.markerClock>=a.MARKER_PERIOD){let[i,n]=t.getCellCoords(this.pos.x,this.pos.y);if(!t.checkCoords(i,n))return;let o=a.MARKER_DEFAULT_INTENSITY*Math.exp(-.15*this.internalClock),r=-1;switch(this.state){case f.TO_HOME:r=V.TO_FOOD;break;case f.TO_FOOD:r=V.TO_HOME;break;case f.REFILL:r=V.TO_HOME;break}t.addMarker(i,n,r,o),this.markerClock=0}}}class _e{constructor(t){l(this,"id");l(this,"x");l(this,"y");l(this,"startingAntsCount");l(this,"maxAntsCount");l(this,"ants");l(this,"totalAnts");l(this,"colonyColor");l(this,"antIcon");l(this,"antImageInstance");l(this,"antFoodImageInstance");l(this,"antId");l(this,"isRunning");l(this,"isDrawingAnts");l(this,"isDebugMode");l(this,"colonyClock");l(this,"antsCtx");l(this,"selectedAnt");l(this,"food");l(this,"totalFood");l(this,"maxFood");this.id=t.id,this.x=t.pos.x,this.y=t.pos.y,this.startingAntsCount=k.COLONY_STARTING_ANTS,this.maxAntsCount=k.COLONY_MAX_ANTS,this.ants=[],this.totalAnts=0,this.colonyColor=t.colonyColor||[255,255,255],this.antIcon=null,this.antImageInstance=null,this.antFoodImageInstance=null,this.antId=0,this.isRunning=!1,this.isDrawingAnts=!0,this.isDebugMode=!1,this.colonyClock=0,this.antsCtx=null,this.selectedAnt=null,this.food=0,this.totalFood=0,this.maxFood=k.COLONY_MAX_FOOD}initialize(t,e,i,n,o){this.antIcon=t,this.antImageInstance=e,this.antFoodImageInstance=i,this.antsCtx=n;for(let m=0;m<this.startingAntsCount;m++){let y=new jt(n,e,i,t,{id:this.antId+1,pos:{x:this.x,y:this.y}});this.ants.push(y),this.antId++,this.totalAnts++}let r=Math.floor(k.COLONY_RADIUS/c.SIZE);for(let m=0;m<r;m++){let y=o.getCellFromCoordsSafe(this.x-r/2*c.SIZE+m*c.SIZE,this.y),p=o.getCellFromCoordsSafe(this.x,this.y-r/2*c.SIZE+m*c.SIZE);y&&p&&(y.colony=!0,p.colony=!0)}}updateAndDrawAnts(t,e){let i=!1;for(let n=0;n<this.ants.length;n++)this.isRunning&&(this.ants[n].search(t,this),this.ants[n].update(e),this.ants[n].addMarker(t,e),this.ants[n].isDead&&(i=!0)),this.isDrawingAnts&&this.ants[n].draw(),i&&(console.log("Removed ant: ",this.ants[n]),this.ants.splice(n,1),i=!1)}updateColony(t){!this.isRunning||(this.colonyClock+=t,this.colonyClock>=k.ANT_CREATION_PERIOD&&this.ants.length<this.maxAntsCount&&this.useFood(k.ANT_COST)&&(this.createAnt(),this.colonyClock=0))}createAnt(){if(this.ants.length<this.maxAntsCount&&this.antIcon&&this.antImageInstance&&this.antFoodImageInstance&&this.antsCtx){let t=new jt(this.antsCtx,this.antImageInstance,this.antFoodImageInstance,this.antIcon,{id:this.antId+1,pos:{x:this.x,y:this.y}});this.ants.push(t),this.antId++,this.totalAnts++,this.isDebugMode&&console.log("Created ant: ",t)}else this.isDebugMode&&console.log("Can't create new ant - max count reached")}selectAnt(t){if(this.ants.length<=0)return null;let e=null,i=1/0,n=a.IMG_HEIGHT/2;for(const o of this.ants){let r=o.pos.dist(t);r<i&&r<n&&(i=r,e=o)}return this.selectedAnt=e,e}removeAnt(){if(this.selectedAnt==null||this.ants.length<=0)return!1;let t=this.ants.findIndex(e=>e.id===this.selectedAnt.id);return t!=-1?(this.ants.splice(t,1),this.selectedAnt=null,!0):!1}toggleAntDebug(){if(this.ants.length>0)for(const t of this.ants)this.selectedAnt&&t.id===this.selectedAnt.id?t.debug=this.isDebugMode:t.debug=!1}drawColony(t){t.fillStyle=`rgb(${this.colonyColor[0]}, ${this.colonyColor[1]}, ${this.colonyColor[2]})`,C(t,this.x,this.y,k.COLONY_RADIUS)}addFood(t){this.food=Math.min(this.food+t,this.maxFood),this.totalFood+=t}useFood(t){return this.food>=t?(this.food-=t,!0):!1}}class ne{constructor(t){l(this,"width");l(this,"height");this.width=t.width,this.height=t.height}createInstance(t){let e=document.createElement("canvas");e.width=this.width,e.height=this.height,console.log(`Created canvas image instance with size: ${this.width} x ${this.height}`);let i=e.getContext("2d");return i&&t(i),e}}class xe{constructor(t){l(this,"measurementArray");l(this,"sampleSize");l(this,"isMeasuring");l(this,"modes");l(this,"mode");this.measurementArray=new Map,this.sampleSize=60,this.isMeasuring=!0,this.modes=[],this.mode=0,this.getModes(t),this.createMeasurementArray(t)}getModes(t){for(const e of t)this.modes.push(e.mode)}changeMode(){this.mode==this.modes.length-1?(this.isMeasuring=!1,this.mode=-1):(this.isMeasuring=!0,this.mode++),this.toggleDisplayVisibility()}toggleDisplayVisibility(){for(const t of this.measurementArray.values()){if(!t.element)return;this.isMeasuring&&t.mode<=this.mode?t.element.style.display="block":t.element.style.display="none"}}createMeasurementArray(t){for(const e of t)for(const i of e.stats)this.measurementArray.set(i.name,{performanceArray:[],title:i.title,mode:e.mode,index:0})}createPerformanceDisplay(t){let e=[];for(const[i,n]of this.measurementArray){let o=document.createElement("span");o.dataset[i.toString()]="",o.title=n.title,this.isMeasuring&&n.mode<=this.mode?o.style.display="block":o.style.display="none",n.element=t.appendChild(o),e.push(n.element)}return e}startMeasurement(t){let e=this.measurementArray.get(t);e&&e.mode<=this.mode&&(e.startTime=performance.now())}endMeasurement(t){let e=this.measurementArray.get(t);e&&e.startTime&&e.mode<=this.mode&&(e.performanceArray[e.index]=performance.now()-e.startTime)}setPerformance(t,e){let i=this.measurementArray.get(t);i&&i.mode<=this.mode&&(i.performanceArray[i.index]=e)}update(){let t=new Map;for(const e of this.measurementArray.keys())t.set(e,0);for(const[e,i]of this.measurementArray)for(let n=0;n<i.performanceArray.length;n++)t.set(e,t.get(e)+i.performanceArray[n]);for(const[e,i]of this.measurementArray){if(i.performanceArray.length===0)break;t.set(e,t.get(e)/i.performanceArray.length),i.mode<=this.mode&&(i.index++,i.index===this.sampleSize&&(i.index=0))}return t}}class B{constructor(t,e){l(this,"canvas");l(this,"width");l(this,"height");l(this,"cellSize");this.canvas=t,this.width=e.width,this.height=e.height,this.cellSize=e.cellSize}create(){return this.canvas.width=this.width,this.canvas.height=this.height,console.log(`Created canvas with size: ${this.width} x ${this.height}`),this.canvas.getContext("2d")}}function be(s){let t=Math.floor(s.width/s.cellSize),e=Math.floor(s.height/s.cellSize);t%2===0&&t--,e%2===0&&e--;let i=t*s.cellSize,n=e*s.cellSize;return console.log(`Calculate sizes:
${s.width==i?i:`${s.width} -> ${i}`} x ${s.height==n?n:`${s.height} -> ${n}`}`),[i,n]}class Fe{constructor(t){l(this,"quantity");l(this,"changed");this.quantity=t,this.changed=!0}draw(t,e,i){t.clearRect(e*E.SIZE,i*E.SIZE,E.SIZE,E.SIZE);let n=e*E.SIZE+E.SIZE/2,o=i*E.SIZE+E.SIZE/2;t.fillStyle=`hsl(120, 40%, 43%, ${this.quantity/100})`,C(t,n,o,E.SIZE/2,!0),this.changed=!1}pick(){if(this.changed=!0,this.quantity===0)return 0;let t=0;return this.quantity<E.PICK_AMOUNT?t=this.quantity:t=E.PICK_AMOUNT,this.quantity=Math.max(this.quantity-E.PICK_AMOUNT,0),t}}class Re{constructor(t){l(this,"intensity");this.intensity=t}draw(t,e,i){let n=new S().set(yt.TO_HOME.slice()),o=new S().set(yt.TO_FOOD.slice()),r=n.mult(this.intensity[0]),m=o.mult(this.intensity[1]),y=r.add(m);y=new S().set(Math.round(Math.min(y.x,255)),Math.round(Math.min(y.y,255)),Math.round(Math.min(y.z,255))),t.fillStyle=`rgb(${y.x}, ${y.y}, ${y.z})`,t.fillRect(e,i,1,1)}getMixedColor(){let[t,e,i]=yt.TO_HOME,[n,o,r]=yt.TO_FOOD,m=[this.intensity[0]*t,this.intensity[0]*e,this.intensity[0]*i],y=[this.intensity[1]*n,this.intensity[1]*o,this.intensity[1]*r],p=[m[0]+y[0],m[1]+y[1],m[2]+y[2]];return p=[Math.round(Math.min(p[0],255)),Math.round(Math.min(p[1],255)),Math.round(Math.min(p[2],255))],p}update(){this.intensity[0]>.01?this.intensity[0]-=Kt:this.intensity[0]=0,this.intensity[1]>.01?this.intensity[1]-=Kt:this.intensity[1]=0}}class Ne{constructor(){l(this,"marker");l(this,"food");l(this,"wall");l(this,"density");l(this,"colony");this.marker=new Re([0,0]),this.food=new Fe(0),this.wall=0,this.density=0,this.colony=!1}update(){this.marker.update()}pick(){return this.food.pick()}drawWall(t,e,i){t.fillRect(e,i,1,1)}addDensity(){this.density++}}class Le{constructor(t){l(this,"width");l(this,"height");l(this,"cellSize");l(this,"cells");this.width=t.width,this.height=t.height,this.cellSize=t.cellSize,this.cells=[];for(let e=0;e<this.width*this.height;e++)this.cells.push(new Ne)}initializeBorderWalls(){for(let t=0;t<this.width;t++){let e=this.cells[this.getIndexFromCoords(t,0)],i=this.cells[this.getIndexFromCoords(t,this.height-1)];e.wall=1,i.wall=1}for(let t=1;t<this.height-1;t++){let e=this.cells[this.getIndexFromCoords(0,t)],i=this.cells[this.getIndexFromCoords(this.width-1,t)];e.wall=1,i.wall=1}}update(){for(const t of this.cells)this.updateCell(t)}updateCell(t){t.marker.update(),t.density>.01?t.density*=.99:t.density=0}addMarker(t,e,i,n){let o=this.cells[this.getIndexFromCoords(t,e)];i===V.TO_HOME?o.marker.intensity[0]=Math.min(1,Math.max(o.marker.intensity[0],n)):i===V.TO_FOOD&&(o.marker.intensity[1]=Math.min(1,Math.max(o.marker.intensity[1],n)))}addFood(t,e,i){let n=this.getIndexFromCoords(t,e);if(n>this.cells.length||n<0)return;let o=this.cells[n];o.food.quantity=Math.min(o.food.quantity+i,100),o.food.changed=!0}drawMarkers(t,e,i=!0){for(let n=0;n<e.data.length;n+=4){let o=this.cells[n/4],r=o.marker.getMixedColor();e.data[n+0]=r[0],e.data[n+1]=r[1],e.data[n+2]=r[2],e.data[n+3]=255,i&&this.updateCell(o)}t.putImageData(e,0,0)}drawFood(t){for(let e=0;e<this.cells.length;e++)if(this.cells[e].food.changed){let[i,n]=this.getCoordsFromIndex(e);this.cells[e].food.draw(t,i,n)}}drawWalls(t){t.fillStyle="rgb(163, 163, 163)";for(let e=0;e<this.width;e++)for(let i=0;i<this.height;i++){let n=this.cells[this.getIndexFromCoords(e,i)];n.wall===1&&n.drawWall(t,e,i)}}drawDensity(t,e,i=!0){for(let n=0;n<e.data.length;n+=4){let o=this.cells[n/4],r=o.density;e.data[n+0]=4*r,e.data[n+1]=r,e.data[n+2]=r,e.data[n+3]=255,i&&this.updateCell(o)}t.putImageData(e,0,0)}isOnFood(t,e){return this.cells[this.getIndexFromCoords(t,e)].food.quantity>0}getIndexFromCoords(t,e){return t+e*this.width}getCoordsFromIndex(t){let e=t%this.width,i=Math.floor(t/this.width);return[e,i]}getCellCoords(t,e){let i=Math.floor(t/c.SIZE),n=Math.floor(e/c.SIZE);return[i,n]}getCellFromCoords(t,e,i=!1){return i||([t,e]=this.getCellCoords(t,e)),this.cells[this.getIndexFromCoords(t,e)]}getCellFromCoordsSafe(t,e){let[i,n]=this.getCellCoords(t,e);return this.checkCoords(i,n)?this.getCellFromCoords(i,n,!0):null}checkCoords(t,e){return t>-1&&t<this.width&&e>-1&&e<this.height}}const v=document.getElementById("canvas-container"),ke=document.getElementById("camera-container"),ve=document.getElementById("btn-fullscreen"),De=document.getElementById("btn-pan"),ze=document.getElementById("canvas"),oe=document.getElementById("canvas-markers"),le=document.getElementById("canvas-food"),He=document.getElementById("canvas-colony"),ae=document.getElementById("canvas-walls"),ut=document.getElementById("canvas-edit"),ft=document.getElementById("canvas-edit-preview"),Jt=document.getElementById("antIcon"),pt=document.getElementById("btn-ant-panel"),qt=document.getElementById("antPanel"),Ze=document.querySelector("[data-id]"),$e=document.querySelector("[data-pos]"),Be=document.querySelector("[data-vel]"),qe=document.querySelector("[data-state]"),Qt=document.querySelector("[data-lifespan-preview]"),Ge=document.querySelector("[data-lifespan]"),kt=document.getElementById("btn-track"),We=document.getElementById("btn-remove"),vt=document.getElementById("btn-cell-panel"),re=document.getElementById("cellPanel"),Ue=document.querySelector("[data-cell-preview]"),Ye=document.querySelector("[data-intensity-home]"),Xe=document.querySelector("[data-intensity-food]"),Ve=document.querySelector("[data-cell-food]"),Ke=document.querySelector("[data-density]"),Dt=document.getElementById("btn-colony-panel"),he=document.getElementById("colonyPanel"),je=document.querySelector("[data-colony-preview]"),Je=document.querySelector("[data-colony-pop]"),Qe=document.querySelector("[data-colony-food]"),ts=document.querySelector("[data-pause]"),ce=document.getElementById("btn-play"),de=document.getElementById("btn-pause"),zt=document.getElementById("btn-edit-mode"),ue=document.getElementById("editPanel"),te=document.querySelector("[data-brush-preview]"),es=document.querySelector("[data-brush-size]"),z=document.getElementById("brushSizeInput"),Ct=document.getElementById("btn-wall-brush"),Ht=document.getElementById("btn-food-brush"),ss=document.getElementById("btn-save"),is=document.getElementById("btn-controls"),ns=document.getElementById("btn-close-controls"),fe=document.getElementById("controlsPanel"),os=document.querySelector("[data-performance-display]");let F=!1,at=!0,rt=!1,H=!1,Et=!1,N=!1,Zt=!1,$t=!1,R=!1,Z=!1,Ot=!1,ht=!1,b=!1,ct=!1,Ft=0,I=new xe([{mode:0,stats:[{name:"fps",title:"Frames per second"},{name:"ms",title:"Milliseconds to render a frame"}]},{mode:1,stats:[{name:"clear",title:"Milliseconds to clear the screen"},{name:"grid",title:"Milliseconds to draw markers/density and update cells"},{name:"food",title:"Milliseconds to draw food"},{name:"ants",title:"Milliseconds to draw and update ants"},{name:"panels",title:"Milliseconds to update info panels"},{name:"all",title:"Milliseconds needed for main loop"}]}]),[ls,Rt,as,rs,hs,cs,ds,us]=I.createPerformanceDisplay(os),J=v.getBoundingClientRect().top,Tt=0,wt=0,h=1,U=!1,St=!1,Nt=0,Y={x:0,y:0},u={x:0,y:0},A=5,[w,P]=be({width:Vt.WIDTH,height:Vt.HEIGHT,cellSize:c.SIZE}),fs=new B(oe,{width:w/c.SIZE,height:P/c.SIZE,cellSize:1});oe.style.transform=`scale(${c.SIZE})`;let M=fs.create(),ms=new B(le,{width:w/(c.SIZE/E.SIZE),height:P/(c.SIZE/E.SIZE),cellSize:c.SIZE/E.SIZE});le.style.transform=`scale(${c.SIZE/E.SIZE})`;let Mt=ms.create(),ys=new B(ze,{width:w,height:P,cellSize:c.SIZE}),X=ys.create(),gs=new ne({width:a.IMG_WIDTH,height:a.IMG_HEIGHT}),Is=new ne({width:a.FOOD_SIZE,height:a.FOOD_SIZE}),Es=new B(He,{width:w,height:P,cellSize:c.SIZE}),Bt=Es.create(),ps=new B(ae,{width:w/c.SIZE,height:P/c.SIZE,cellSize:1});ae.style.transform=`scale(${c.SIZE})`;let j=ps.create(),Cs=new B(ut,{width:w/c.SIZE,height:P/c.SIZE,cellSize:1});ut.style.transform=`scale(${c.SIZE})`;let x=Cs.create(),Os=new B(ft,{width:w/c.SIZE,height:P/c.SIZE,cellSize:1});ft.style.transform=`scale(${c.SIZE})`;let lt=Os.create(),d=new Le({width:w/c.SIZE,height:P/c.SIZE,cellSize:1}),At=M==null?void 0:M.createImageData(d.width,d.height),ee=M==null?void 0:M.createImageData(d.width,d.height),g=new _e({id:1,pos:{x:w/2,y:P/2}});window.addEventListener("keydown",s=>{switch(s.code){case"Space":Wt();break;case"KeyM":As();break;case"KeyN":Ts();break;case"KeyA":Ps();break;case"KeyD":ws();break;case"KeyT":ye();break;case"KeyC":Ut();break;case"Delete":ge();break;case"KeyF":I.changeMode();break;case"ArrowUp":It(0,gt);break;case"ArrowDown":It(0,-gt);break;case"ArrowLeft":It(gt,0);break;case"ArrowRight":It(-gt,0);break;case"Minus":ie(!1);break;case"Equal":ie(!0);break;case"Comma":se(-$.STEP);break;case"Period":se($.STEP);break}});v.addEventListener("mousemove",s=>{Tt=s.pageX,wt=s.pageY-J});v.addEventListener("click",()=>{if(St){St=!1;return}_s(),H&&me()});v.addEventListener("contextmenu",s=>{if(s.preventDefault(),N)return;let t=K(Math.floor((Tt/h-u.x)/c.SIZE),Math.floor((wt/h-u.y)/c.SIZE));H&&console.log(`Placed food at: ${t.x}:${t.y}`),d.addFood(t.x,t.y,10)});v.addEventListener("wheel",s=>{Ls(s)});ve.addEventListener("click",()=>{Ut()});kt.addEventListener("click",()=>{ye()});We.addEventListener("click",()=>{ge()});ce.addEventListener("click",()=>{Wt()});de.addEventListener("click",()=>{Wt()});Dt.addEventListener("click",()=>{Ot=T(Ot,he,Dt)});Ot=T(Ot,he,Dt);vt.addEventListener("click",()=>{ht=T(ht,re,vt)});pt.addEventListener("click",()=>{b=T(b,qt,pt)});is.addEventListener("click",()=>{ct=T(ct,fe)});ns.addEventListener("click",()=>{ct=!0,ct=T(ct,fe)});zt.addEventListener("click",()=>{N=T(N,ue,zt),N?(ut.style.display="block",ft.style.display="block"):(ut.style.display="none",ft.style.display="none")});Ct.addEventListener("click",()=>{R=dt(R,Ct),R&&(Z=!0,Z=dt(R,Ht))});Ht.addEventListener("click",()=>{Z=dt(Z,Ht),Z&&(R=!0,R=dt(Z,Ct))});ss.addEventListener("click",()=>{if(x&&j){let s=x.getImageData(0,0,d.width,d.height);j.clearRect(0,0,d.width,d.height);for(let t=0;t<s.data.length;t+=4){let e=d.cells[t/4],i=s.data[t+0],n=s.data[t+1],o=s.data[t+2],r=s.data[t+3];n<=160&&n>0&&n>i&&n>o?e.wall!==1?(e.food.quantity=Math.round(100*(r/255)),e.food.changed=!0):e.wall=1:i>10&&n>10&&o>10&&i===n&&n===o?(e.wall=1,e.food.quantity=0,e.food.changed=!0):r>0&&(e.food.quantity=0,e.food.changed=!0,e.wall=0)}d.initializeBorderWalls(),d.drawWalls(j),x.clearRect(0,0,d.width,d.height),N=T(N,ue,zt),ut.style.display="none",ft.style.display="none"}});z.addEventListener("input",()=>{A=parseInt(z.value),Gt()});function Ss(){z.min=$.MIN_SIZE.toString(),z.max=$.MAX_SIZE.toString(),z.step=$.STEP.toString(),z.value=A.toString()}function Gt(){te.style.width=`${A}px`,te.style.height=`${A}px`,es.textContent=`${A} px`}function se(s){A=Math.min($.MAX_SIZE,Math.max($.MIN_SIZE,A+s)),z.value=A.toString(),Gt()}Ss();Gt();R=dt(R,Ct);Ms();Ns();Ut();window.requestAnimationFrame(Ie);function Ms(){if(!(M==null||Mt==null||X==null||Bt==null||j==null||x==null||lt==null)){if(At&&(d.drawMarkers(M,At),d.drawFood(Mt)),Jt){let s=new XMLSerializer().serializeToString(Jt),t=btoa(s),i="data:image/svg+xml;base64,"+t,n=new Image;n.src=i,n.onload=()=>{let o=gs.createInstance(m=>{m.drawImage(n,0,0)}),r=Is.createInstance(m=>{let y=a.FOOD_SIZE/2;m.fillStyle="hsl(120, 40%, 43%)",C(m,y,y,a.FOOD_SIZE/2)});g.initialize(n,o,r,X,d)}}g.drawColony(Bt),d.initializeBorderWalls(),d.drawWalls(j)}}function Wt(){F=!F,g.isRunning=F,ts.style.display=F?"none":"block",ce.style.display=F?"none":"flex",de.style.display=F?"flex":"none"}function As(){at=!at,at&&(rt=!1)}function Ts(){rt=!rt,rt&&(at=!1)}function ws(){H=!H,g.isDebugMode=H,me(),H&&(ht=!1),ht=T(ht,re,vt)}function me(){g.toggleAntDebug()}function ye(){g.selectedAnt!=null&&(Et=!Et,Et&&(h=3),kt.classList.toggle("border-green-500"),kt.classList.toggle("border-red-500"))}function Lt(){De.classList.toggle("bg-neutral-600")}function Ps(){g.isDrawingAnts=!g.isDrawingAnts}function _s(){let s=K(Tt/h-u.x,wt/h-u.y);g.selectAnt(s),g.selectedAnt?b=!1:b=!0,b=T(b,qt,pt)}function ge(){g.removeAnt()?b=!0:b=!1,b=T(b,qt,pt)}function xs(){let s=g.selectedAnt;if(!s)return;Ze.textContent=s.id.toString(),$e.textContent=`${s.pos.x.toFixed(2)} : ${s.pos.y.toFixed(2)}`,Be.textContent=`${s.vel.x.toFixed(2)} : ${s.vel.y.toFixed(2)}`;let t="";switch(s.state){case f.TO_HOME:t="To Home";break;case f.TO_FOOD:t="To Food";break;case f.REFILL:t="Refill";break}qe.textContent=t;let e=a.AUTONOMY_REFILL/s.maxAutonomy,i=s.internalClock/s.maxAutonomy;Qt.style.setProperty("--left",`${e*100}%`),Qt.style.setProperty("--width",`${i*100}%`),Ge.textContent=`${s.internalClock.toFixed(2)} | ${s.maxAutonomy.toFixed(2)}`}function bs(s,t){let e=d.getCellFromCoordsSafe(s,t);if(!e)return;Ye.textContent=e.marker.intensity[0].toFixed(2),Xe.textContent=e.marker.intensity[1].toFixed(2),Ve.textContent=e.food.quantity.toString(),Ke.textContent=e.density.toFixed(2);let i=e.marker.getMixedColor();Ue.style.backgroundColor=`rgb(${i[0]}, ${i[1]}, ${i[2]})`}function Fs(){if(!g)return;Je.textContent=`${g.ants.length} | ${g.totalAnts}`,Qe.textContent=`${g.food.toFixed(2)} | ${g.totalFood}`;let s=g.colonyColor;je.style.backgroundColor=`rgb(${s[0]}, ${s[1]}, ${s[2]})`}function Rs(){let s=I.update();ls.textContent=`${Math.round(s.get("fps")*100)/100} fps`,Rt.textContent=`${Math.round(s.get("ms")*100)/100} ms`,as.textContent=`${Math.round(s.get("clear")*100)/100} ms`,rs.textContent=`${Math.round(s.get("grid")*100)/100} ms`,hs.textContent=`${Math.round(s.get("food")*100)/100} ms`,cs.textContent=`${Math.round(s.get("ants")*100)/100} ms`,ds.textContent=`${Math.round(s.get("panels")*100)/100} ms`,us.textContent=`${Math.round(s.get("all")*100)/100} ms`,s.get("ms")>16.7?Rt.classList.add("text-red-500"):Rt.classList.remove("text-red-500")}function Ns(){v.addEventListener("mousedown",s=>{if(clearTimeout(Nt),s.buttons==bt&&N)$t=!0;else if(s.buttons==bt)return;if(s.buttons==Pe)U=!0,St=!1,Lt(),document.body.classList.add("cursor-grabbing"),Y.x=s.clientX/h-u.x,Y.y=(s.clientY-J)/h-u.y;else{if(N){Zt=!0;return}U=!1,Nt=setTimeout(()=>{U=!0,St=!0,Lt(),document.body.classList.add("cursor-grabbing"),Y.x=s.clientX/h-u.x,Y.y=(s.clientY-J)/h-u.y},100)}}),v.addEventListener("mousemove",s=>{!U||s.buttons==bt||ks(s)}),v.addEventListener("mouseup",()=>{clearTimeout(Nt),Zt=!1,$t=!1,U&&(U=!1,Lt(),document.body.classList.remove("cursor-grabbing"))})}function Ls(s){let t={x:0,y:0};t.x=s.clientX/h-u.x,t.y=(s.clientY-J)/h-u.y,h*=.999**s.deltaY,h=Math.min(Math.max(.15,h),16),u.x=s.clientX/h-t.x,u.y=(s.clientY-J)/h-t.y,Q()}function ks(s){u.x=s.clientX/h-Y.x,u.y=(s.clientY-J)/h-Y.y,Q()}function It(s,t){u.x+=s,u.y+=t,Q()}function ie(s){let t={x:0,y:0};t.x=window.innerWidth/2/h-u.x,t.y=window.innerWidth/2/h-u.y,h*=.999**(s?-100:100),h=Math.min(Math.max(.15,h),16),u.x=window.innerWidth/2/h-t.x,u.y=window.innerWidth/2/h-t.y,Q()}function Ut(){let s={x:window.innerWidth/2-w/2,y:window.innerHeight/2-P/2};h=1,u.x=s.x,u.y=s.y,Q()}function vs(s,t){let e={x:window.innerWidth/2/h-s,y:window.innerHeight/2/h-t};u.x=e.x,u.y=e.y,Q()}function Q(){ke.style.transform=`scale(${h}) translate(${u.x}px, ${u.y}px)`}function Ie(s){if(M==null||Mt==null||X==null||Bt==null||j==null||x==null||lt==null)return;window.requestAnimationFrame(Ie),I.startMeasurement("all");const t=(s-Ft)/1e3;I.isMeasuring&&(I.setPerformance("fps",1/t),I.setPerformance("ms",s-Ft)),I.startMeasurement("clear"),X.clearRect(0,0,w,P),M.clearRect(0,0,d.width,d.height),I.endMeasurement("clear"),I.startMeasurement("grid"),at&&At?d.drawMarkers(M,At,F):rt&&ee?d.drawDensity(M,ee,F):F&&d.update(),I.endMeasurement("grid"),I.startMeasurement("food"),d.drawFood(Mt),I.endMeasurement("food");let e=K(Tt/h-u.x,wt/h-u.y);if(N){lt.clearRect(0,0,d.width,d.height),lt.fillStyle="grey";let i=d.getCellCoords(e.x,e.y);C(lt,i[0],i[1],A),$t?(x.fillStyle="black",C(x,i[0],i[1],A)):Zt&&(R?x.fillStyle="rgb(163, 163, 163)":Z&&(x.fillStyle="rgb(66, 153, 66, 0.25)"),C(x,i[0],i[1],A))}g.updateColony(t),I.startMeasurement("ants"),g.updateAndDrawAnts(d,t),I.endMeasurement("ants"),I.startMeasurement("panels"),xs(),Et&&g.selectedAnt&&vs(g.selectedAnt.pos.x,g.selectedAnt.pos.y),H&&(X.fillStyle="red",C(X,e.x,e.y,4),bs(e.x,e.y)),Fs(),I.endMeasurement("panels"),I.isMeasuring&&(I.endMeasurement("all"),Rs()),Ft=s}
