var Ae=Object.defineProperty;var Te=(i,t,e)=>t in i?Ae(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var o=(i,t,e)=>(Te(i,typeof t!="symbol"?t+"":t,e),e);const Pe=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerpolicy&&(l.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?l.credentials="include":n.crossorigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(n){if(n.ep)return;n.ep=!0;const l=e(n);fetch(n.href,l)}};Pe();const Vt={WIDTH:1600*3,HEIGHT:1200*3};var V=(i=>(i[i.TO_HOME=0]="TO_HOME",i[i.TO_FOOD=1]="TO_FOOD",i))(V||{});const mt={TO_HOME:[255,0,0],TO_FOOD:[43,255,0]},h={WIDTH:16,HEIGHT:16,SIZE:16},Kt=2e-4,L={COLONY_RADIUS:50,COLONY_STARTING_ANTS:25,COLONY_MAX_ANTS:250,COLONY_MAX_FOOD:12500,ANT_CREATION_PERIOD:.15,ANT_COST:30,ANT_REFILL_FOOD_AMOUNT:.25};var f=(i=>(i[i.TO_HOME=0]="TO_HOME",i[i.TO_FOOD=1]="TO_FOOD",i[i.REFILL=2]="REFILL",i))(f||{});const a={IMG_WIDTH:24,IMG_HEIGHT:34,WANDER_DISPLACE_RANGE:.5,WANDER_POINT_MAGNITUDE:100,WANDER_POINT_RADIUS:50,PERCEPTION_RADIUS:96,PERCEPTION_START_ANGLE:7/6*Math.PI,PERCEPTION_END_ANGLE:11/6*Math.PI,PERCEPTION_POINTS_HORIZONTAL:12,PERCEPTION_POINTS_VERTICAL:5,MARKER_PERIOD:.15,MARKER_DEFAULT_INTENSITY:1,AUTONOMY_MAX:300,AUTONOMY_REFILL:150},I={SIZE:15,PICK_AMOUNT:2},Mt=2,we=4,gt=h.SIZE,B={MIN_SIZE:1,MAX_SIZE:75,STEP:1};function p(i,t,e,s,n=!0,l=!1){i.beginPath(),i.arc(t,e,s,0,Math.PI*2),n&&i.fill(),l&&i.stroke()}function U(i,t,e,s,n){i.beginPath(),i.moveTo(t,e),i.lineTo(s,n),i.stroke(),i.closePath()}function nt(i,t){return Math.random()*(t-i)+i}function w(i,t,e){return i=!i,i?(t.style.display="block",e==null||e.classList.add("border-green-500"),e==null||e.classList.remove("border-red-500")):(t.style.display="none",e==null||e.classList.add("border-red-500"),e==null||e.classList.remove("border-green-500")),i}function dt(i,t){return i=!i,i?(t.classList.add("border-green-500"),t.classList.remove("border-red-500")):(t.classList.add("border-red-500"),t.classList.remove("border-green-500")),i}class C{constructor(t,e,s){o(this,"x");o(this,"y");o(this,"z");this.x=t||0,this.y=e||0,this.z=s||0}set(t,e,s){return t instanceof C?(this.x=t.x||0,this.y=t.y||0,this.z=t.z||0,this):t instanceof Array?(this.x=t[0]||0,this.y=t[1]||0,this.z=t[2]||0,this):(this.x=t||0,this.y=e||0,this.z=s||0,this)}copy(){return new C(this.x,this.y,this.z)}add(t,e,s){return t instanceof C?(this.x+=t.x||0,this.y+=t.y||0,this.z+=t.z||0,this):t instanceof Array?(this.x+=t[0]||0,this.y+=t[1]||0,this.z+=t[2]||0,this):(this.x+=t||0,this.y+=e||0,this.z+=s||0,this)}sub(t,e,s){return t instanceof C?(this.x-=t.x||0,this.y-=t.y||0,this.z-=t.z||0,this):t instanceof Array?(this.x-=t[0]||0,this.y-=t[1]||0,this.z-=t[2]||0,this):(this.x-=t||0,this.y-=e||0,this.z-=s||0,this)}mult(t,e,s){if(t instanceof C)return Number.isFinite(t.x)&&Number.isFinite(t.y)&&Number.isFinite(t.z)&&typeof t.x=="number"&&typeof t.y=="number"&&typeof t.z=="number"?(this.x*=t.x,this.y*=t.y,this.z*=t.z):console.warn("Vector.mult:","x contains components that are either undefined or not finite numbers"),this;if(t instanceof Array)return t.every(l=>Number.isFinite(l))&&t.every(l=>typeof l=="number")?t.length===1?(this.x*=t[0],this.y*=t[0],this.z*=t[0]):t.length===2?(this.x*=t[0],this.y*=t[1]):t.length===3&&(this.x*=t[0],this.y*=t[1],this.z*=t[2]):console.warn("Vector.mult:","x contains elements that are either undefined or not finite numbers"),this;const n=[...arguments];return n.every(l=>Number.isFinite(l))&&n.every(l=>typeof l=="number")?(arguments.length===1&&(this.x*=t,this.y*=t,this.z*=t),arguments.length===2&&(this.x*=t,this.y*=e||0),arguments.length===3&&(this.x*=t,this.y*=e||0,this.z*=s||0)):console.warn("Vector.mult:","x, y, or z arguments are either undefined or not a finite number"),this}div(t,e,s){if(t instanceof C){if(Number.isFinite(t.x)&&Number.isFinite(t.y)&&Number.isFinite(t.z)&&typeof t.x=="number"&&typeof t.y=="number"&&typeof t.z=="number"){if(t.x===0||t.y===0||t.z===0)return console.warn("Vector.div:","divide by 0"),this;this.x/=t.x,this.y/=t.y,this.z/=t.z}else console.warn("Vector.div:","x contains components that are either undefined or not finite numbers");return this}if(t instanceof Array){if(t.every(l=>Number.isFinite(l))&&t.every(l=>typeof l=="number")){if(t.some(l=>l===0))return console.warn("Vector.div:","divide by 0"),this;t.length===1?(this.x/=t[0],this.y/=t[0],this.z/=t[0]):t.length===2?(this.x/=t[0],this.y/=t[1]):t.length===3&&(this.x/=t[0],this.y/=t[1],this.z/=t[2])}else console.warn("Vector.div:","x contains components that are either undefined or not finite numbers");return this}const n=[...arguments];if(n.every(l=>Number.isFinite(l))&&n.every(l=>typeof l=="number")){if(n.some(l=>l===0))return console.warn("Vector.div:","divide by 0"),this;arguments.length===1&&(this.x/=t,this.y/=t,this.z/=t),arguments.length===2&&(this.x/=t,this.y/=e||0),arguments.length===3&&(this.x/=t,this.y/=e||0,this.z/=s||0)}else console.warn("Vector.div:","x, y, or z arguments are either undefined or not a finite number");return this}mag(){return Math.sqrt(this.magSq())}magSq(){const t=this.x,e=this.y,s=this.z;return t*t+e*e+s*s}dist(t){return t.copy().sub(this).mag()}normalize(){const t=this.mag();return t!==0&&this.mult(1/t),this}limit(t){const e=this.magSq();return e>t*t&&this.div(Math.sqrt(e)).mult(t),this}setMag(t){return this.normalize().mult(t)}heading(){return Math.atan2(this.y,this.x)}setHeading(t){let e=this.mag();return this.x=e*Math.cos(t),this.y=e*Math.sin(t),this}rotate(t){let e=this.heading()+t;const s=this.mag();return this.x=Math.cos(e)*s,this.y=Math.sin(e)*s,this}equals(t,e,s){let n,l,r;return t instanceof C?(n=t.x||0,l=t.y||0,r=t.z||0):t instanceof Array?(n=t[0]||0,l=t[1]||0,r=t[2]||0):(n=t||0,l=e||0,r=s||0),this.x===n&&this.y===l&&this.z===r}}function K(i,t,e){return new C(i,t,e)}class jt{constructor(t,e,s){o(this,"ctx");o(this,"antIcon");o(this,"id");o(this,"pos");o(this,"vel");o(this,"acc");o(this,"maxSpeed");o(this,"maxForce");o(this,"state");o(this,"debug");o(this,"wanderTheta");o(this,"perceptionDraw");o(this,"internalClock");o(this,"markerClock");o(this,"isDead");o(this,"freedomCoef");o(this,"foodAmount");o(this,"maxAutonomy");this.ctx=t,this.antIcon=e,this.id=s.id,this.pos=K(s.pos.x,s.pos.y),this.vel=K(0,0),this.acc=K(0,0),this.maxSpeed=4,this.maxForce=.25,this.state=f.TO_FOOD,this.debug=s.debug||!1,this.wanderTheta=nt(0,Math.PI*2),this.perceptionDraw=new Set,this.internalClock=0,this.markerClock=nt(0,a.MARKER_PERIOD),this.isDead=!1,this.freedomCoef=nt(.01,.1),this.foodAmount=0,this.maxAutonomy=a.AUTONOMY_MAX-nt(0,50)}seek(t){this.debug&&(this.ctx.strokeStyle="white",U(this.ctx,t.x,t.y,this.pos.x,this.pos.y));let e=t.copy().sub(this.pos);e.setMag(this.maxSpeed),e.sub(this.vel),e.limit(this.maxForce),this.applyForce(e)}wander(){let t=this.vel.copy();t.setMag(a.WANDER_POINT_MAGNITUDE),t.add(this.pos);let e=a.WANDER_POINT_RADIUS;this.debug&&(this.ctx.fillStyle="red",p(this.ctx,t.x,t.y,4),this.ctx.strokeStyle="white",p(this.ctx,t.x,t.y,e,!1,!0),U(this.ctx,this.pos.x,this.pos.y,t.x,t.y));let s=this.wanderTheta+this.vel.heading(),n=e*Math.cos(s),l=e*Math.sin(s);t.add(n,l),this.ctx.fillStyle="green",this.debug&&(p(this.ctx,t.x,t.y,8),U(this.ctx,this.pos.x,this.pos.y,t.x,t.y));let r=t.sub(this.pos);r.setMag(this.maxForce),r.limit(this.maxForce),this.applyForce(r);let m=a.WANDER_DISPLACE_RANGE;this.wanderTheta+=nt(-m,m)}applyForce(t){this.acc.add(t)}update(t){this.internalClock+=t,this.internalClock>=a.AUTONOMY_REFILL&&this.state===f.TO_FOOD&&(this.state=f.REFILL),this.internalClock>=this.maxAutonomy&&(this.isDead=!0),this.vel.add(this.acc),this.vel.limit(this.maxSpeed),this.pos.add(this.vel),this.acc.set(0,0)}draw(){this.ctx.save(),this.ctx.translate(this.pos.x,this.pos.y),this.ctx.rotate(this.vel.heading()+Math.PI/2);let t=-a.IMG_WIDTH/2,e=-a.IMG_HEIGHT/2;if(this.state===f.TO_HOME&&(this.ctx.fillStyle="green",p(this.ctx,0,e,10)),this.ctx.drawImage(this.antIcon,t,e,a.IMG_WIDTH,a.IMG_HEIGHT),this.debug){this.ctx.strokeStyle="#FF0000",this.ctx.lineWidth=2,this.ctx.strokeRect(t,e,a.IMG_WIDTH,a.IMG_HEIGHT),this.ctx.fillStyle="red",p(this.ctx,0,0,4),this.ctx.beginPath(),this.ctx.arc(0,0,a.PERCEPTION_RADIUS,a.PERCEPTION_START_ANGLE,a.PERCEPTION_END_ANGLE),this.ctx.stroke(),this.ctx.strokeStyle="white",this.ctx.beginPath(),this.ctx.arc(0,0,a.PERCEPTION_RADIUS,a.PERCEPTION_END_ANGLE,a.PERCEPTION_START_ANGLE),this.ctx.stroke();let s=a.PERCEPTION_START_ANGLE,n=a.PERCEPTION_END_ANGLE,l=a.PERCEPTION_RADIUS*Math.cos(s),r=a.PERCEPTION_RADIUS*Math.sin(s),m=a.PERCEPTION_RADIUS*Math.cos(n),g=a.PERCEPTION_RADIUS*Math.sin(n);this.ctx.strokeStyle="red",U(this.ctx,0,0,l,r),U(this.ctx,0,0,m,g);let T=(a.PERCEPTION_END_ANGLE-a.PERCEPTION_START_ANGLE)/(a.PERCEPTION_POINTS_HORIZONTAL-1),tt=a.PERCEPTION_RADIUS/a.PERCEPTION_POINTS_VERTICAL;for(let F=0;F<a.PERCEPTION_POINTS_HORIZONTAL;F++)for(let x=1;x<=a.PERCEPTION_POINTS_VERTICAL;x++){let k=T*F+a.PERCEPTION_START_ANGLE,et=tt*x*Math.cos(k),it=tt*x*Math.sin(k);this.perceptionDraw.has(x*a.PERCEPTION_POINTS_VERTICAL+F)?(this.ctx.strokeStyle="white",this.ctx.fillStyle="white"):(this.ctx.strokeStyle="red",this.ctx.fillStyle="green"),p(this.ctx,et,it,4),x===a.PERCEPTION_POINTS_VERTICAL&&U(this.ctx,0,0,et,it)}}this.ctx.restore(),this.debug&&(this.ctx.fillStyle="white",p(this.ctx,this.pos.x,this.pos.y,3))}search(t,e){this.debug&&(this.perceptionDraw=new Set);let s=this.vel.copy();s.setMag(a.IMG_HEIGHT/2),s.add(this.pos);let n=t.getCellFromCoordsSafe(s.x,s.y),l=t.getCellFromCoordsSafe(this.pos.x,this.pos.y);if(l==null||l.addDensity(),n&&n.food.quantity>0&&(this.state===f.TO_FOOD||this.state===f.REFILL)){this.state=f.TO_HOME,this.foodAmount=n.pick(),this.vel.setHeading(this.vel.heading()+Math.PI),this.internalClock=0;return}if(l&&l.colony&&(this.state===f.REFILL||this.state===f.TO_HOME)){if(this.state===f.TO_HOME&&(this.vel.setHeading(this.vel.heading()+Math.PI),e.addFood(this.foodAmount)),this.state===f.REFILL&&!e.useFood(L.ANT_REFILL_FOOD_AMOUNT))return;this.state=f.TO_FOOD,this.internalClock=0;return}if(Math.random()<this.freedomCoef)return;let r=(a.PERCEPTION_END_ANGLE-a.PERCEPTION_START_ANGLE)/(a.PERCEPTION_POINTS_HORIZONTAL-1),m=a.PERCEPTION_RADIUS/a.PERCEPTION_POINTS_VERTICAL,g=a.PERCEPTION_POINTS_VERTICAL+1,T=null,tt=0,F=null,x=this.vel.heading(),k=-a.IMG_WIDTH/2,et=Math.PI/4+x+Math.PI,it=-Math.PI/4+x+Math.PI,Ie=k*Math.cos(et),Ee=k*Math.sin(et),pe=k*Math.cos(it),Ce=k*Math.sin(it),wt=this.pos.copy().add(Ie,Ee),xt=this.pos.copy().add(pe,Ce),_t=t.getCellFromCoordsSafe(wt.x,wt.y),Yt=t.getCellFromCoordsSafe(xt.x,xt.y);if(_t&&_t.wall===1||Yt&&Yt.wall===1){let E=(_t?wt:xt).sub(this.pos);E.sub(this.vel),E.mult(-1),this.applyForce(E);return}for(let q=0;q<a.PERCEPTION_POINTS_HORIZONTAL;q++)for(let E=1;E<=a.PERCEPTION_POINTS_VERTICAL;E++){let Xt=r*q+a.PERCEPTION_START_ANGLE+x+Math.PI/2,Se=m*E*Math.cos(Xt),Oe=m*E*Math.sin(Xt),G=this.pos.copy().add(Se,Oe),W=t.getCellFromCoordsSafe(G.x,G.y);if(W){if(W.wall===1&&E===1){let st=G.sub(this.pos);st.setMag(this.maxSpeed),st.sub(this.vel),st.limit(this.maxForce),this.debug,st.mult(-1),this.applyForce(st);break}if(W.colony&&(this.state===f.REFILL||this.state===f.TO_HOME)){this.seek(G);return}if(W.food.quantity>0&&(this.state===f.TO_FOOD||this.state===f.REFILL)){this.debug&&(this.perceptionDraw.add(E*a.PERCEPTION_POINTS_VERTICAL+q),console.log(`food: x:${q}, y:${E}`)),E<g&&(g=E,T=G);break}let yt=0;this.state===f.TO_HOME||this.state===f.REFILL?yt=W.marker.intensity[0]:(this.state===f.TO_FOOD||this.state===f.REFILL)&&(yt=W.marker.intensity[1]),yt>tt&&(tt=yt,F=G)}}if(T){this.seek(T);return}if(F){this.seek(F);return}this.wander()}addMarker(t,e){if(this.markerClock+=e,this.markerClock>=a.MARKER_PERIOD){let[s,n]=t.getCellCoords(this.pos.x,this.pos.y);if(!t.checkCoords(s,n))return;let l=a.MARKER_DEFAULT_INTENSITY*Math.exp(-.15*this.internalClock),r=-1;switch(this.state){case f.TO_HOME:r=V.TO_FOOD;break;case f.TO_FOOD:r=V.TO_HOME;break;case f.REFILL:r=V.TO_HOME;break}t.addMarker(s,n,r,l),this.markerClock=0}}}class xe{constructor(t){o(this,"id");o(this,"x");o(this,"y");o(this,"startingAntsCount");o(this,"maxAntsCount");o(this,"ants");o(this,"totalAnts");o(this,"colonyColor");o(this,"antIcon");o(this,"antId");o(this,"isRunning");o(this,"isDrawingAnts");o(this,"isDebugMode");o(this,"colonyClock");o(this,"antCtx");o(this,"selectedAnt");o(this,"food");o(this,"totalFood");o(this,"maxFood");this.id=t.id,this.x=t.pos.x,this.y=t.pos.y,this.startingAntsCount=L.COLONY_STARTING_ANTS,this.maxAntsCount=L.COLONY_MAX_ANTS,this.ants=[],this.totalAnts=0,this.colonyColor=t.colonyColor||[255,255,255],this.antIcon=null,this.antId=0,this.isRunning=!1,this.isDrawingAnts=!0,this.isDebugMode=!1,this.colonyClock=0,this.antCtx=null,this.selectedAnt=null,this.food=0,this.totalFood=0,this.maxFood=L.COLONY_MAX_FOOD}initialize(t,e,s){this.antIcon=t,this.antCtx=e;for(let l=0;l<this.startingAntsCount;l++){let r=new jt(this.antCtx,t,{id:this.antId+1,pos:{x:this.x,y:this.y}});this.ants.push(r),this.antId++,this.totalAnts++}let n=Math.floor(L.COLONY_RADIUS/h.SIZE);for(let l=0;l<n;l++){let r=s.getCellFromCoordsSafe(this.x-n/2*h.SIZE+l*h.SIZE,this.y),m=s.getCellFromCoordsSafe(this.x,this.y-n/2*h.SIZE+l*h.SIZE);r&&m&&(r.colony=!0,m.colony=!0)}}updateAndDrawAnts(t,e){let s=!1;for(let n=0;n<this.ants.length;n++)this.isRunning&&(this.ants[n].search(t,this),this.ants[n].update(e),this.ants[n].addMarker(t,e),this.ants[n].isDead&&(s=!0)),this.isDrawingAnts&&this.ants[n].draw(),s&&(console.log("Removed ant: ",this.ants[n]),this.ants.splice(n,1),s=!1)}updateColony(t){!this.isRunning||(this.colonyClock+=t,this.colonyClock>=L.ANT_CREATION_PERIOD&&this.ants.length<this.maxAntsCount&&this.useFood(L.ANT_COST)&&(this.createAnt(),this.colonyClock=0))}createAnt(){if(this.ants.length<this.maxAntsCount&&this.antIcon&&this.antCtx){let t=new jt(this.antCtx,this.antIcon,{id:this.antId+1,pos:{x:this.x,y:this.y}});this.ants.push(t),this.antId++,this.totalAnts++,this.isDebugMode&&console.log("Created ant: ",t)}else this.isDebugMode&&console.log("Can't create new ant - max count reached")}selectAnt(t){if(this.ants.length<=0)return null;let e=null,s=1/0,n=a.IMG_HEIGHT/2;for(const l of this.ants){let r=l.pos.dist(t);r<s&&r<n&&(s=r,e=l)}return this.selectedAnt=e,e}removeAnt(){if(this.selectedAnt==null||this.ants.length<=0)return!1;let t=this.ants.findIndex(e=>e.id===this.selectedAnt.id);return t!=-1?(this.ants.splice(t,1),this.selectedAnt=null,!0):!1}toggleAntDebug(){if(this.ants.length>0)for(const t of this.ants)this.selectedAnt&&t.id===this.selectedAnt.id?t.debug=this.isDebugMode:t.debug=!1}drawColony(t){t.fillStyle=`rgb(${this.colonyColor[0]}, ${this.colonyColor[1]}, ${this.colonyColor[2]})`,p(t,this.x,this.y,L.COLONY_RADIUS)}addFood(t){this.food=Math.min(this.food+t,this.maxFood),this.totalFood+=t}useFood(t){return this.food>=t?(this.food-=t,!0):!1}}class _e{constructor(){o(this,"fpsArray");o(this,"msArray");o(this,"index");o(this,"sampleSize");this.fpsArray=[],this.msArray=[],this.index=0,this.sampleSize=60}update(t,e){let s=0,n=0;this.fpsArray[this.index]=Math.round(t),this.msArray[this.index]=Math.round(e);for(let l=0;l<this.fpsArray.length;l++)s+=this.fpsArray[l],n+=this.msArray[l];return s/=this.fpsArray.length,n/=this.msArray.length,this.index++,this.index===this.sampleSize&&(this.index=0),[s,n]}}class ${constructor(t,e){o(this,"canvas");o(this,"width");o(this,"height");o(this,"cellSize");this.canvas=t,this.width=e.width,this.height=e.height,this.cellSize=e.cellSize}create(){return this.canvas.width=this.width,this.canvas.height=this.height,console.log(`Created canvas with size: ${this.width} x ${this.height}`),this.canvas.getContext("2d")}}function Me(i){let t=Math.floor(i.width/i.cellSize),e=Math.floor(i.height/i.cellSize);t%2===0&&t--,e%2===0&&e--;let s=t*i.cellSize,n=e*i.cellSize;return console.log(`Calculate sizes:
${i.width==s?s:`${i.width} -> ${s}`} x ${i.height==n?n:`${i.height} -> ${n}`}`),[s,n]}class be{constructor(t){o(this,"quantity");this.quantity=t}draw(t,e,s){let n=e*I.SIZE+I.SIZE/2,l=s*I.SIZE+I.SIZE/2;t.fillStyle=`hsl(120, 40%, 43%, ${this.quantity/100})`,p(t,n,l,I.SIZE/2,!0)}pick(){let t=this.quantity-I.PICK_AMOUNT;return this.quantity=Math.max(this.quantity-I.PICK_AMOUNT,0),t<0?0:I.PICK_AMOUNT}}class Re{constructor(t){o(this,"intensity");this.intensity=t}draw(t,e,s){let n=new C().set(mt.TO_HOME.slice()),l=new C().set(mt.TO_FOOD.slice()),r=n.mult(this.intensity[0]),m=l.mult(this.intensity[1]),g=r.add(m);g=new C().set(Math.round(Math.min(g.x,255)),Math.round(Math.min(g.y,255)),Math.round(Math.min(g.z,255))),t.fillStyle=`rgb(${g.x}, ${g.y}, ${g.z})`,t.fillRect(e,s,1,1)}getMixedColor(){let[t,e,s]=mt.TO_HOME,[n,l,r]=mt.TO_FOOD,m=[this.intensity[0]*t,this.intensity[0]*e,this.intensity[0]*s],g=[this.intensity[1]*n,this.intensity[1]*l,this.intensity[1]*r],T=[m[0]+g[0],m[1]+g[1],m[2]+g[2]];return T=[Math.round(Math.min(T[0],255)),Math.round(Math.min(T[1],255)),Math.round(Math.min(T[2],255))],T}update(){this.intensity[0]>.01?this.intensity[0]-=Kt:this.intensity[0]=0,this.intensity[1]>.01?this.intensity[1]-=Kt:this.intensity[1]=0}}class Ne{constructor(){o(this,"marker");o(this,"food");o(this,"wall");o(this,"density");o(this,"colony");this.marker=new Re([0,0]),this.food=new be(0),this.wall=0,this.density=0,this.colony=!1}update(){this.marker.update()}pick(){return this.food.pick()}drawWall(t,e,s){t.fillRect(e,s,1,1)}addDensity(){this.density++}}class Fe{constructor(t){o(this,"width");o(this,"height");o(this,"cellSize");o(this,"cells");this.width=t.width,this.height=t.height,this.cellSize=t.cellSize,this.cells=[];for(let e=0;e<this.width*this.height;e++)this.cells.push(new Ne)}initializeBorderWalls(){for(let t=0;t<this.width;t++){let e=this.cells[this.getIndexFromCoords(t,0)],s=this.cells[this.getIndexFromCoords(t,this.height-1)];e.wall=1,s.wall=1}for(let t=1;t<this.height-1;t++){let e=this.cells[this.getIndexFromCoords(0,t)],s=this.cells[this.getIndexFromCoords(this.width-1,t)];e.wall=1,s.wall=1}}update(){for(const t of this.cells)this.updateCell(t)}updateCell(t){t.marker.update(),t.density>.01?t.density*=.99:t.density=0}addMarker(t,e,s,n){let l=this.cells[this.getIndexFromCoords(t,e)];s===V.TO_HOME?l.marker.intensity[0]=Math.min(1,Math.max(l.marker.intensity[0],n)):s===V.TO_FOOD&&(l.marker.intensity[1]=Math.min(1,Math.max(l.marker.intensity[1],n)))}addFood(t,e,s){let n=this.getIndexFromCoords(t,e);if(n>this.cells.length||n<0)return;let l=this.cells[n];l.food.quantity=Math.min(l.food.quantity+s,100)}drawMarkers(t,e,s=!0){for(let n=0;n<e.data.length;n+=4){let l=this.cells[n/4],r=l.marker.getMixedColor();e.data[n+0]=r[0],e.data[n+1]=r[1],e.data[n+2]=r[2],e.data[n+3]=255,s&&this.updateCell(l)}t.putImageData(e,0,0)}drawFood(t){for(let e=0;e<this.width;e++)for(let s=0;s<this.height;s++){let n=this.cells[this.getIndexFromCoords(e,s)];n.food.quantity>0&&n.food.draw(t,e,s)}}drawWalls(t){t.fillStyle="rgb(163, 163, 163)";for(let e=0;e<this.width;e++)for(let s=0;s<this.height;s++){let n=this.cells[this.getIndexFromCoords(e,s)];n.wall===1&&n.drawWall(t,e,s)}}drawDensity(t,e,s=!0){for(let n=0;n<e.data.length;n+=4){let l=this.cells[n/4],r=l.density;e.data[n+0]=4*r,e.data[n+1]=r,e.data[n+2]=r,e.data[n+3]=255,s&&this.updateCell(l)}t.putImageData(e,0,0)}isOnFood(t,e){return this.cells[this.getIndexFromCoords(t,e)].food.quantity>0}getIndexFromCoords(t,e){return t+e*this.width}getCellCoords(t,e){let s=Math.floor(t/h.SIZE),n=Math.floor(e/h.SIZE);return[s,n]}getCellFromCoords(t,e,s=!1){return s||([t,e]=this.getCellCoords(t,e)),this.cells[this.getIndexFromCoords(t,e)]}getCellFromCoordsSafe(t,e){let[s,n]=this.getCellCoords(t,e);return this.checkCoords(s,n)?this.getCellFromCoords(s,n,!0):null}checkCoords(t,e){return t>-1&&t<this.width&&e>-1&&e<this.height}}const v=document.getElementById("canvas-container"),Le=document.getElementById("camera-container"),ve=document.getElementById("btn-fullscreen"),ke=document.getElementById("btn-pan"),De=document.getElementById("canvas"),ne=document.getElementById("canvas-markers"),le=document.getElementById("canvas-food"),ze=document.getElementById("canvas-colony"),oe=document.getElementById("canvas-walls"),ut=document.getElementById("canvas-edit"),ft=document.getElementById("canvas-edit-preview"),Jt=document.getElementById("antIcon"),pt=document.getElementById("btn-ant-panel"),qt=document.getElementById("antPanel"),He=document.querySelector("[data-id]"),Ze=document.querySelector("[data-pos]"),Be=document.querySelector("[data-vel]"),$e=document.querySelector("[data-state]"),Qt=document.querySelector("[data-lifespan-preview]"),qe=document.querySelector("[data-lifespan]"),Lt=document.getElementById("btn-track"),Ge=document.getElementById("btn-remove"),vt=document.getElementById("btn-cell-panel"),ae=document.getElementById("cellPanel"),We=document.querySelector("[data-cell-preview]"),Ue=document.querySelector("[data-intensity-home]"),Ye=document.querySelector("[data-intensity-food]"),Xe=document.querySelector("[data-cell-food]"),Ve=document.querySelector("[data-density]"),kt=document.getElementById("btn-colony-panel"),re=document.getElementById("colonyPanel"),Ke=document.querySelector("[data-colony-preview]"),je=document.querySelector("[data-colony-pop]"),Je=document.querySelector("[data-colony-food]"),Qe=document.querySelector("[data-pause]"),he=document.getElementById("btn-play"),ce=document.getElementById("btn-pause"),Dt=document.getElementById("btn-edit-mode"),de=document.getElementById("editPanel"),te=document.querySelector("[data-brush-preview]"),ti=document.querySelector("[data-brush-size]"),D=document.getElementById("brushSizeInput"),Ct=document.getElementById("btn-wall-brush"),zt=document.getElementById("btn-food-brush"),ei=document.getElementById("btn-save"),ii=document.getElementById("btn-controls"),si=document.getElementById("btn-close-controls"),ue=document.getElementById("controlsPanel"),ni=document.querySelector("[data-fps]"),bt=document.querySelector("[data-ms]");let b=!1,ot=!0,at=!1,z=!1,Et=!1,N=!1,Ht=!1,Zt=!1,R=!1,H=!1,Bt=!0,St=!1,rt=!1,M=!1,ht=!1,Rt=0,li=new _e,J=v.getBoundingClientRect().top,Tt=0,Pt=0,c=1,Y=!1,Ot=!1,Nt=0,X={x:0,y:0},u={x:0,y:0},P=5,[O,A]=Me({width:Vt.WIDTH,height:Vt.HEIGHT,cellSize:h.SIZE}),oi=new $(ne,{width:O/h.SIZE,height:A/h.SIZE,cellSize:1});ne.style.transform=`scale(${h.SIZE})`;let S=oi.create(),ai=new $(le,{width:O/(h.SIZE/I.SIZE),height:A/(h.SIZE/I.SIZE),cellSize:h.SIZE/I.SIZE});le.style.transform=`scale(${h.SIZE/I.SIZE})`;let ct=ai.create(),ri=new $(De,{width:O,height:A,cellSize:h.SIZE}),Z=ri.create(),hi=new $(ze,{width:O,height:A,cellSize:h.SIZE}),$t=hi.create(),ci=new $(oe,{width:O/h.SIZE,height:A/h.SIZE,cellSize:1});oe.style.transform=`scale(${h.SIZE})`;let j=ci.create(),di=new $(ut,{width:O/h.SIZE,height:A/h.SIZE,cellSize:1});ut.style.transform=`scale(${h.SIZE})`;let _=di.create(),ui=new $(ft,{width:O/h.SIZE,height:A/h.SIZE,cellSize:1});ft.style.transform=`scale(${h.SIZE})`;let lt=ui.create(),d=new Fe({width:O/h.SIZE,height:A/h.SIZE,cellSize:1}),At=S==null?void 0:S.createImageData(d.width,d.height),ee=S==null?void 0:S.createImageData(d.width,d.height),y=new xe({id:1,pos:{x:O/2,y:A/2}});window.addEventListener("keydown",i=>{switch(i.code){case"Space":Wt();break;case"KeyM":mi();break;case"KeyN":gi();break;case"KeyA":Ei();break;case"KeyD":Ii();break;case"KeyT":ye();break;case"KeyC":Ut();break;case"Delete":me();break;case"KeyF":Bt=!Bt;break;case"ArrowUp":It(0,gt);break;case"ArrowDown":It(0,-gt);break;case"ArrowLeft":It(gt,0);break;case"ArrowRight":It(-gt,0);break;case"Minus":se(!1);break;case"Equal":se(!0);break;case"Comma":ie(-B.STEP);break;case"Period":ie(B.STEP);break}});v.addEventListener("mousemove",i=>{Tt=i.pageX,Pt=i.pageY-J});v.addEventListener("click",()=>{if(Ot){Ot=!1;return}pi(),z&&fe()});v.addEventListener("contextmenu",i=>{if(i.preventDefault(),N)return;let t=K(Math.floor((Tt/c-u.x)/h.SIZE),Math.floor((Pt/c-u.y)/h.SIZE));z&&console.log(`Placed food at: ${t.x}:${t.y}`),d.addFood(t.x,t.y,10)});v.addEventListener("wheel",i=>{Pi(i)});ve.addEventListener("click",()=>{Ut()});Lt.addEventListener("click",()=>{ye()});Ge.addEventListener("click",()=>{me()});he.addEventListener("click",()=>{Wt()});ce.addEventListener("click",()=>{Wt()});kt.addEventListener("click",()=>{St=w(St,re,kt)});St=w(St,re,kt);vt.addEventListener("click",()=>{rt=w(rt,ae,vt)});pt.addEventListener("click",()=>{M=w(M,qt,pt)});ii.addEventListener("click",()=>{ht=w(ht,ue)});si.addEventListener("click",()=>{ht=!0,ht=w(ht,ue)});Dt.addEventListener("click",()=>{N=w(N,de,Dt),N?(ut.style.display="block",ft.style.display="block"):(ut.style.display="none",ft.style.display="none")});Ct.addEventListener("click",()=>{R=dt(R,Ct),R&&(H=!0,H=dt(R,zt))});zt.addEventListener("click",()=>{H=dt(H,zt),H&&(R=!0,R=dt(H,Ct))});ei.addEventListener("click",()=>{if(_&&j){let i=_.getImageData(0,0,d.width,d.height);j.clearRect(0,0,d.width,d.height);for(let t=0;t<i.data.length;t+=4){let e=d.cells[t/4],s=i.data[t+0],n=i.data[t+1],l=i.data[t+2],r=i.data[t+3];n<=160&&n>0&&n>s&&n>l?e.wall!==1?e.food.quantity=Math.round(100*(r/255)):e.wall=1:s>10&&n>10&&l>10&&s===n&&n===l?(e.wall=1,e.food.quantity=0):r>0&&(e.food.quantity=0,e.wall=0)}d.initializeBorderWalls(),d.drawWalls(j),_.clearRect(0,0,d.width,d.height),N=w(N,de,Dt),ut.style.display="none",ft.style.display="none"}});D.addEventListener("input",()=>{P=parseInt(D.value),Gt()});function fi(){D.min=B.MIN_SIZE.toString(),D.max=B.MAX_SIZE.toString(),D.step=B.STEP.toString(),D.value=P.toString()}function Gt(){te.style.width=`${P}px`,te.style.height=`${P}px`,ti.textContent=`${P} px`}function ie(i){P=Math.min(B.MAX_SIZE,Math.max(B.MIN_SIZE,P+i)),D.value=P.toString(),Gt()}fi();Gt();R=dt(R,Ct);yi();Ti();Ut();window.requestAnimationFrame(ge);function yi(){if(!(S==null||ct==null||Z==null||$t==null||j==null||_==null||lt==null)){if(At&&(d.drawMarkers(S,At),d.drawFood(ct)),Jt){let i=new XMLSerializer().serializeToString(Jt),t=btoa(i),s="data:image/svg+xml;base64,"+t,n=new Image;n.src=s,n.onload=()=>{Z.drawImage(n,100,50,24,34),y.initialize(n,Z,d)}}y.drawColony($t),d.initializeBorderWalls(),d.drawWalls(j)}}function Wt(){b=!b,y.isRunning=b,Qe.style.display=b?"none":"block",he.style.display=b?"none":"flex",ce.style.display=b?"flex":"none"}function mi(){ot=!ot,ot&&(at=!1)}function gi(){at=!at,at&&(ot=!1)}function Ii(){z=!z,y.isDebugMode=z,fe(),z&&(rt=!1),rt=w(rt,ae,vt)}function fe(){y.toggleAntDebug()}function ye(){y.selectedAnt!=null&&(Et=!Et,Et&&(c=3),Lt.classList.toggle("border-green-500"),Lt.classList.toggle("border-red-500"))}function Ft(){ke.classList.toggle("bg-neutral-600")}function Ei(){y.isDrawingAnts=!y.isDrawingAnts}function pi(){let i=K(Tt/c-u.x,Pt/c-u.y);y.selectAnt(i),y.selectedAnt?M=!1:M=!0,M=w(M,qt,pt)}function me(){y.removeAnt()?M=!0:M=!1,M=w(M,qt,pt)}function Ci(){let i=y.selectedAnt;if(!i)return;He.textContent=i.id.toString(),Ze.textContent=`${i.pos.x.toFixed(2)} : ${i.pos.y.toFixed(2)}`,Be.textContent=`${i.vel.x.toFixed(2)} : ${i.vel.y.toFixed(2)}`;let t="";switch(i.state){case f.TO_HOME:t="To Home";break;case f.TO_FOOD:t="To Food";break;case f.REFILL:t="Refill";break}$e.textContent=t;let e=a.AUTONOMY_REFILL/i.maxAutonomy,s=i.internalClock/i.maxAutonomy;Qt.style.setProperty("--left",`${e*100}%`),Qt.style.setProperty("--width",`${s*100}%`),qe.textContent=`${i.internalClock.toFixed(2)} | ${i.maxAutonomy.toFixed(2)}`}function Si(i,t){let e=d.getCellFromCoordsSafe(i,t);if(!e)return;Ue.textContent=e.marker.intensity[0].toFixed(2),Ye.textContent=e.marker.intensity[1].toFixed(2),Xe.textContent=e.food.quantity.toString(),Ve.textContent=e.density.toFixed(2);let s=e.marker.getMixedColor();We.style.backgroundColor=`rgb(${s[0]}, ${s[1]}, ${s[2]})`}function Oi(){if(!y)return;je.textContent=`${y.ants.length} | ${y.totalAnts}`,Je.textContent=`${y.food.toFixed(2)} | ${y.totalFood}`;let i=y.colonyColor;Ke.style.backgroundColor=`rgb(${i[0]}, ${i[1]}, ${i[2]})`}function Ai(i,t){let[e,s]=li.update(i,t);ni.textContent=`${Math.round(e*100)/100} fps`,bt.textContent=`${Math.round(s*100)/100} ms`,s>16.7?bt.classList.add("text-red-500"):bt.classList.remove("text-red-500")}function Ti(){v.addEventListener("mousedown",i=>{if(clearTimeout(Nt),i.buttons==Mt&&N)Zt=!0;else if(i.buttons==Mt)return;if(i.buttons==we)Y=!0,Ot=!1,Ft(),document.body.classList.add("cursor-grabbing"),X.x=i.clientX/c-u.x,X.y=(i.clientY-J)/c-u.y;else{if(N){Ht=!0;return}Y=!1,Nt=setTimeout(()=>{Y=!0,Ot=!0,Ft(),document.body.classList.add("cursor-grabbing"),X.x=i.clientX/c-u.x,X.y=(i.clientY-J)/c-u.y},100)}}),v.addEventListener("mousemove",i=>{!Y||i.buttons==Mt||wi(i)}),v.addEventListener("mouseup",()=>{clearTimeout(Nt),Ht=!1,Zt=!1,Y&&(Y=!1,Ft(),document.body.classList.remove("cursor-grabbing"))})}function Pi(i){let t={x:0,y:0};t.x=i.clientX/c-u.x,t.y=(i.clientY-J)/c-u.y,c*=.999**i.deltaY,c=Math.min(Math.max(.15,c),16),u.x=i.clientX/c-t.x,u.y=(i.clientY-J)/c-t.y,Q()}function wi(i){u.x=i.clientX/c-X.x,u.y=(i.clientY-J)/c-X.y,Q()}function It(i,t){u.x+=i,u.y+=t,Q()}function se(i){let t={x:0,y:0};t.x=window.innerWidth/2/c-u.x,t.y=window.innerWidth/2/c-u.y,c*=.999**(i?-100:100),c=Math.min(Math.max(.15,c),16),u.x=window.innerWidth/2/c-t.x,u.y=window.innerWidth/2/c-t.y,Q()}function Ut(){let i={x:window.innerWidth/2-O/2,y:window.innerHeight/2-A/2};c=1,u.x=i.x,u.y=i.y,Q()}function xi(i,t){let e={x:window.innerWidth/2/c-i,y:window.innerHeight/2/c-t};u.x=e.x,u.y=e.y,Q()}function Q(){Le.style.transform=`scale(${c}) translate(${u.x}px, ${u.y}px)`}function ge(i){if(S==null||ct==null||Z==null||$t==null||j==null||_==null||lt==null)return;window.requestAnimationFrame(ge);const t=(i-Rt)/1e3;Bt&&Ai(1/t,i-Rt),Z.clearRect(0,0,O,A),S.clearRect(0,0,d.width,d.height),ct.clearRect(0,0,O/(h.SIZE/I.SIZE),A/(h.SIZE/I.SIZE)),ot&&At?d.drawMarkers(S,At,b):at&&ee?d.drawDensity(S,ee,b):b&&d.update(),d.drawFood(ct);let e=K(Tt/c-u.x,Pt/c-u.y);if(N){lt.clearRect(0,0,d.width,d.height),lt.fillStyle="grey";let s=d.getCellCoords(e.x,e.y);p(lt,s[0],s[1],P),Zt?(_.fillStyle="black",p(_,s[0],s[1],P)):Ht&&(R?_.fillStyle="rgb(163, 163, 163)":H&&(_.fillStyle="rgb(66, 153, 66, 0.25)"),p(_,s[0],s[1],P))}y.updateColony(t),y.updateAndDrawAnts(d,t),Ci(),Et&&y.selectedAnt&&xi(y.selectedAnt.pos.x,y.selectedAnt.pos.y),z&&(Z.fillStyle="red",p(Z,e.x,e.y,4),Si(e.x,e.y)),Oi(),Rt=i}
