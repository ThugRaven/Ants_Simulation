var dn=Object.defineProperty;var hn=(s,t,e)=>t in s?dn(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var a=(s,t,e)=>(hn(s,typeof t!="symbol"?t+"":t,e),e);const un=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerpolicy&&(o.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?o.credentials="include":i.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}};un();const me={WIDTH:1600*3,HEIGHT:1200*3},ft={FILL_RATIO:.47,FILL_RATIO_FOOD:.37,THRESHOLD:50,THRESHOLD_FOOD:20,BORDER_SIZE:5};var ct=(s=>(s[s.TO_HOME=0]="TO_HOME",s[s.TO_FOOD=1]="TO_FOOD",s))(ct||{});const ye={TO_HOME:[255,0,0],TO_FOOD:[43,255,0]},u={WIDTH:16,HEIGHT:16,SIZE:16},ge=2e-4/10,B={COLONY_RADIUS:3,COLONY_STARTING_ANTS:50,COLONY_MAX_ANTS:5e3,COLONY_MAX_FOOD:3e5,ANT_CREATION_PERIOD:.15,ANT_COST:30,ANT_REFILL_FOOD_AMOUNT:.25};var p=(s=>(s[s.TO_HOME=0]="TO_HOME",s[s.TO_FOOD=1]="TO_FOOD",s[s.REFILL=2]="REFILL",s))(p||{});const I={IMG_WIDTH:24,IMG_HEIGHT:34,DIRECTION_NOISE_RANGE:Math.PI*.05,WANDER_DISPLACE_RANGE:.5,WANDER_POINT_MAGNITUDE:100,WANDER_POINT_RADIUS:50,PERCEPTION_RADIUS:80,PERCEPTION_START_ANGLE:7/6*Math.PI,PERCEPTION_END_ANGLE:11/6*Math.PI,PERCEPTION_POINTS_HORIZONTAL:8,PERCEPTION_POINTS_VERTICAL:5,DIRECTION_PERIOD:.25,MARKER_PERIOD:.15,MARKER_DEFAULT_INTENSITY:1,AUTONOMY_MAX:300,AUTONOMY_REFILL:150,FOOD_SIZE:16},Ie=.005,x={SIZE:15,PICK_AMOUNT:2},Bt=2,fn=4,Ot=u.SIZE,X={MIN_SIZE:1,MAX_SIZE:75,STEP:1};class V{constructor(t,e,n){a(this,"x");a(this,"y");a(this,"z");this.x=t||0,this.y=e||0,this.z=n||0}set(t,e,n){return t instanceof V?(this.x=t.x||0,this.y=t.y||0,this.z=t.z||0,this):t instanceof Array?(this.x=t[0]||0,this.y=t[1]||0,this.z=t[2]||0,this):(this.x=t||0,this.y=e||0,this.z=n||0,this)}copy(){return new V(this.x,this.y,this.z)}add(t,e,n){return t instanceof V?(this.x+=t.x||0,this.y+=t.y||0,this.z+=t.z||0,this):t instanceof Array?(this.x+=t[0]||0,this.y+=t[1]||0,this.z+=t[2]||0,this):(this.x+=t||0,this.y+=e||0,this.z+=n||0,this)}sub(t,e,n){return t instanceof V?(this.x-=t.x||0,this.y-=t.y||0,this.z-=t.z||0,this):t instanceof Array?(this.x-=t[0]||0,this.y-=t[1]||0,this.z-=t[2]||0,this):(this.x-=t||0,this.y-=e||0,this.z-=n||0,this)}multSimple(t){return this.x*=t,this.y*=t,this.z*=t,this}mult(t,e,n){if(t instanceof V)return Number.isFinite(t.x)&&Number.isFinite(t.y)&&Number.isFinite(t.z)&&typeof t.x=="number"&&typeof t.y=="number"&&typeof t.z=="number"?(this.x*=t.x,this.y*=t.y,this.z*=t.z):console.warn("Vector.mult:","x contains components that are either undefined or not finite numbers"),this;if(t instanceof Array)return t.every(o=>Number.isFinite(o))&&t.every(o=>typeof o=="number")?t.length===1?(this.x*=t[0],this.y*=t[0],this.z*=t[0]):t.length===2?(this.x*=t[0],this.y*=t[1]):t.length===3&&(this.x*=t[0],this.y*=t[1],this.z*=t[2]):console.warn("Vector.mult:","x contains elements that are either undefined or not finite numbers"),this;const i=[...arguments];return i.every(o=>Number.isFinite(o))&&i.every(o=>typeof o=="number")?(arguments.length===1&&(this.x*=t,this.y*=t,this.z*=t),arguments.length===2&&(this.x*=t,this.y*=e||0),arguments.length===3&&(this.x*=t,this.y*=e||0,this.z*=n||0)):console.warn("Vector.mult:","x, y, or z arguments are either undefined or not a finite number"),this}div(t,e,n){if(t instanceof V){if(Number.isFinite(t.x)&&Number.isFinite(t.y)&&Number.isFinite(t.z)&&typeof t.x=="number"&&typeof t.y=="number"&&typeof t.z=="number"){if(t.x===0||t.y===0||t.z===0)return console.warn("Vector.div:","divide by 0"),this;this.x/=t.x,this.y/=t.y,this.z/=t.z}else console.warn("Vector.div:","x contains components that are either undefined or not finite numbers");return this}if(t instanceof Array){if(t.every(o=>Number.isFinite(o))&&t.every(o=>typeof o=="number")){if(t.some(o=>o===0))return console.warn("Vector.div:","divide by 0"),this;t.length===1?(this.x/=t[0],this.y/=t[0],this.z/=t[0]):t.length===2?(this.x/=t[0],this.y/=t[1]):t.length===3&&(this.x/=t[0],this.y/=t[1],this.z/=t[2])}else console.warn("Vector.div:","x contains components that are either undefined or not finite numbers");return this}const i=[...arguments];if(i.every(o=>Number.isFinite(o))&&i.every(o=>typeof o=="number")){if(i.some(o=>o===0))return console.warn("Vector.div:","divide by 0"),this;arguments.length===1&&(this.x/=t,this.y/=t,this.z/=t),arguments.length===2&&(this.x/=t,this.y/=e||0),arguments.length===3&&(this.x/=t,this.y/=e||0,this.z/=n||0)}else console.warn("Vector.div:","x, y, or z arguments are either undefined or not a finite number");return this}mag(){return Math.sqrt(this.magSq())}magSq(){const t=this.x,e=this.y,n=this.z;return t*t+e*e+n*n}dot(t,e,n){return this.x*(t||0)+this.y*(e||0)+this.z*(n||0)}dist(t){return t.copy().sub(this).mag()}normalize(){const t=this.mag();return t!==0&&(this.x*=1/t,this.y*=1/t,this.z*=1/t),this}limit(t){const e=this.magSq();return e>t*t&&(this.x/=Math.sqrt(e),this.y/=Math.sqrt(e),this.z/=Math.sqrt(e),this.x*=t,this.y*=t,this.z*=t),this}setMag(t){const e=this.normalize();return e.x*=t,e.y*=t,e.z*=t,e}heading(){return Math.atan2(this.y,this.x)}setHeading(t){let e=this.mag();return this.x=e*Math.cos(t),this.y=e*Math.sin(t),this}rotate(t){let e=this.heading()+t;const n=this.mag();return this.x=Math.cos(e)*n,this.y=Math.sin(e)*n,this}equals(t,e,n){let i,o,r;return t instanceof V?(i=t.x||0,o=t.y||0,r=t.z||0):t instanceof Array?(i=t[0]||0,o=t[1]||0,r=t[2]||0):(i=t||0,o=e||0,r=n||0),this.x===i&&this.y===o&&this.z===r}}function W(s,t,e){return new V(s,t,e)}class mn{constructor(t,e=10){a(this,"angle");a(this,"targetAngle");a(this,"rotationSpeed");a(this,"vector");a(this,"targetVector");this.angle=t,this.targetAngle=t,this.rotationSpeed=e,this.vector=W(),this.targetVector=W(),this.updateVector(),this.targetVector=this.vector.copy()}update(t){this.updateVector();const e=W(-this.vector.y,this.vector.x),n=this.targetVector.copy().dot(e.x,e.y);this.angle+=this.rotationSpeed*n*t}setDirectionImmediate(t){this.targetVector=t.copy(),this.vector=t.copy(),this.angle=t.heading(),this.targetAngle=this.angle}setDirectionAngle(t){this.targetAngle=t,this.updateTargetVector()}setAndAddDirectionAngle(t){this.targetAngle+=t,this.updateTargetVector()}addImmediate(t){this.setAndAddDirectionAngle(t),this.angle=this.targetAngle,this.updateVector()}getVec(){return this.vector}updateVector(){this.vector.x=Math.cos(this.angle),this.vector.y=Math.sin(this.angle)}updateTargetVector(){this.targetVector.x=Math.cos(this.targetAngle),this.targetVector.y=Math.sin(this.targetAngle)}}function G(s,t,e,n,i=!0,o=!1){s.beginPath(),s.arc(t,e,n,0,Math.PI*2),i&&s.fill(),o&&s.stroke()}function z(s,t){return Math.random()*(t-s)+s}function w(s,t,e){return s=!s,s?(t.style.display="block",e==null||e.classList.add("border-green-500"),e==null||e.classList.remove("border-red-500")):(t.style.display="none",e==null||e.classList.add("border-red-500"),e==null||e.classList.remove("border-green-500")),s}function M(s,t){return s=!s,s?(t.classList.add("border-green-500"),t.classList.remove("border-red-500")):(t.classList.add("border-red-500"),t.classList.remove("border-green-500")),s}function dt(s=!1,t=""){const n=new URL(window.location.href).searchParams.get("seed");if(s&&n!=null)return n;if(s)return"";{const i=Math.random().toString(36).slice(2,7);return t!=""?t:i}}class $t{constructor(t,e,n,i,o){a(this,"ctx");a(this,"antImageInstance");a(this,"antFoodImageInstance");a(this,"antIcon");a(this,"id");a(this,"pos");a(this,"direction");a(this,"maxSpeed");a(this,"state");a(this,"debug");a(this,"internalClock");a(this,"markerPeriod");a(this,"markerClock");a(this,"markerIntensityClock");a(this,"directionPeriod");a(this,"directionClock");a(this,"isDead");a(this,"freedomCoef");a(this,"foodAmount");a(this,"maxAutonomy");a(this,"hits");a(this,"foundCell");this.ctx=t,this.antImageInstance=e,this.antFoodImageInstance=n,this.antIcon=i,this.id=o.id,this.pos=W(o.pos.x,o.pos.y),this.direction=new mn(z(-Math.PI*2,Math.PI*2)),this.maxSpeed=2,this.state=p.TO_FOOD,this.debug=o.debug||!1,this.internalClock=0,this.markerPeriod=I.MARKER_PERIOD+z(-I.MARKER_PERIOD*.25,I.MARKER_PERIOD*.25),this.markerClock=z(0,I.MARKER_PERIOD),this.markerIntensityClock=0,this.directionPeriod=I.DIRECTION_PERIOD+z(-I.DIRECTION_PERIOD*.25,I.DIRECTION_PERIOD*.25),this.directionClock=z(0,I.DIRECTION_PERIOD),this.isDead=!1,this.freedomCoef=z(.01,.1),this.foodAmount=0,this.maxAutonomy=I.AUTONOMY_MAX-z(0,50),this.hits=0,this.foundCell=!1}updatePosition(t){const e=this.direction.getVec(),n=t.rayCast(this.pos.copy(),this.direction.vector.heading(),I.IMG_HEIGHT/2+this.maxSpeed);if(n!=null&&n.cell){const i=e.copy();this.hits>16?i.setHeading(i.heading()+Math.PI/2):this.hits>8?(i.x*=n.normal.x!=0?1:-1,i.y*=n.normal.y!=0?1:-1):(i.x*=n.normal.x!=0?-1:1,i.y*=n.normal.y!=0?-1:1),this.hits+=4,this.direction.setDirectionImmediate(i)}else this.hits=Math.max(0,this.hits-1),this.pos.add(e.multSimple(this.maxSpeed))}find(t){if(this.directionClock>=this.directionPeriod){this.directionClock=0;let e=0,n=1,i=this.direction.getVec(),o=null;const r=i.heading();for(let l=0;l<32;l++){const f=z(-Math.PI*.3333333333333333,Math.PI*.3333333333333333),g=z(u.SIZE*3,u.SIZE*12),E=r+f,C=W(Math.cos(E),Math.sin(E)),Y=t.rayCast(this.pos.copy(),E,g);if(Y!=null&&Y.cell)continue;const j=this.pos.copy().add(C.multSimple(g)),O=t.getCellFromCoordsSafe(j.x,j.y);if(O&&this.debug&&(O.density=[O.density[0],O.density[1],100]),!O)continue;if(O.food.quantity>0&&this.state===p.TO_FOOD||this.state===p.TO_HOME&&O.colony){i=C,this.direction.setDirectionAngle(i.heading()),this.foundCell=!0;return}const ut=O.dist*O.dist,at=O.getIntensity(this.state)*ut;at>e&&(e=at,i=C,o=O),at<n&&(n=at)}if(e==n){this.foundCell=!1;return}e?(o&&this.debug&&(o.density=[0,100,0]),this.direction.setDirectionAngle(i.heading()),this.foundCell=!0):this.foundCell=!1}}update(t,e,n){this.internalClock+=e,this.markerIntensityClock+=e,this.directionClock+=e,this.internalClock>=I.AUTONOMY_REFILL&&this.state===p.TO_FOOD&&(this.state=p.REFILL),this.internalClock>=this.maxAutonomy&&(this.isDead=!0),this.direction.update(e),this.foundCell?this.direction.setAndAddDirectionAngle(z(-I.DIRECTION_NOISE_RANGE/5,I.DIRECTION_NOISE_RANGE/5)):this.direction.setAndAddDirectionAngle(z(-I.DIRECTION_NOISE_RANGE,I.DIRECTION_NOISE_RANGE)),this.updatePosition(t);const i=t.getCellFromCoordsSafe(this.pos.x,this.pos.y);if(i==null||i.addDensity(this.state===p.TO_HOME,this.state===p.REFILL),i&&i.food.quantity>0&&(this.state===p.TO_FOOD||this.state===p.REFILL)){this.state=p.TO_HOME,this.foodAmount=i.pick(),this.direction.addImmediate(Math.PI),this.internalClock=0,this.markerIntensityClock=0;return}if(i&&i.food.quantity>0&&this.state===p.TO_HOME&&(this.markerIntensityClock=0),i&&i.colony&&this.state===p.TO_FOOD&&(this.markerIntensityClock=0),i&&i.colony&&(this.state===p.REFILL||this.state===p.TO_HOME)){if(this.state===p.TO_HOME&&(this.direction.addImmediate(Math.PI),n.addFood(this.foodAmount)),this.state===p.REFILL&&!n.useFood(B.ANT_REFILL_FOOD_AMOUNT))return;this.state=p.TO_FOOD,this.internalClock=0,this.markerIntensityClock=0;return}}draw(){this.ctx.translate(this.pos.x,this.pos.y),this.ctx.rotate(this.direction.vector.heading()+Math.PI/2);const t=-I.IMG_WIDTH/2,e=-I.IMG_HEIGHT/2;this.state===p.TO_HOME&&this.ctx.drawImage(this.antFoodImageInstance,-I.FOOD_SIZE/2,e-I.FOOD_SIZE/2),this.ctx.drawImage(this.antImageInstance,t,e),this.debug&&(this.ctx.strokeStyle="#FF0000",this.ctx.lineWidth=2,this.ctx.strokeRect(t,e,I.IMG_WIDTH,I.IMG_HEIGHT),this.ctx.fillStyle="red",G(this.ctx,0,0,4)),this.debug&&(this.ctx.fillStyle="white",G(this.ctx,this.pos.x,this.pos.y,3)),this.ctx.resetTransform()}addMarker(t,e){if(this.markerClock+=e,this.markerClock>=this.markerPeriod){const[n,i]=t.getCellCoords(this.pos.x,this.pos.y);if(!t.checkCoords(n,i))return;const o=I.MARKER_DEFAULT_INTENSITY*Math.exp(-.15*this.markerIntensityClock);if(o<.01){this.markerClock=0;return}let r=-1;switch(this.state){case p.TO_HOME:r=ct.TO_FOOD;break;case p.TO_FOOD:r=ct.TO_HOME;break;case p.REFILL:r=ct.TO_HOME;break}t.addMarker(n,i,r,o),this.markerClock=0}}}class yn{constructor(t){a(this,"id");a(this,"x");a(this,"y");a(this,"startingAntsCount");a(this,"maxAntsCount");a(this,"ants");a(this,"totalAnts");a(this,"colonyColor");a(this,"antIcon");a(this,"antImageInstance");a(this,"antFoodImageInstance");a(this,"antId");a(this,"isRunning");a(this,"isDrawingAnts");a(this,"isDebugMode");a(this,"colonyClock");a(this,"antsCtx");a(this,"selectedAnt");a(this,"food");a(this,"totalFood");a(this,"maxFood");this.id=t.id,this.x=t.pos.x,this.y=t.pos.y,this.startingAntsCount=B.COLONY_STARTING_ANTS,this.maxAntsCount=B.COLONY_MAX_ANTS,this.ants=[],this.totalAnts=0,this.colonyColor=t.colonyColor||[255,255,255],this.antIcon=null,this.antImageInstance=null,this.antFoodImageInstance=null,this.antId=0,this.isRunning=!1,this.isDrawingAnts=!1,this.isDebugMode=!1,this.colonyClock=0,this.antsCtx=null,this.selectedAnt=null,this.food=0,this.totalFood=0,this.maxFood=B.COLONY_MAX_FOOD}initialize(t,e,n,i,o){this.antIcon=t,this.antImageInstance=e,this.antFoodImageInstance=n,this.antsCtx=i;for(let r=0;r<this.startingAntsCount;r++){const l=new $t(i,e,n,t,{id:this.antId+1,pos:{x:this.x,y:this.y}});this.ants.push(l),this.antId++,this.totalAnts++}this.drawAndFillMidpointCircle(o,this.x,this.y,B.COLONY_RADIUS)}reset(t){if(!(!this.antsCtx||!this.antImageInstance||!this.antFoodImageInstance||!this.antIcon)){this.ants=[],this.antId=0,this.totalAnts=0,this.colonyClock=0,this.food=0,this.totalFood=0;for(let e=0;e<this.startingAntsCount;e++){const n=new $t(this.antsCtx,this.antImageInstance,this.antFoodImageInstance,this.antIcon,{id:this.antId+1,pos:{x:this.x,y:this.y}});this.ants.push(n),this.antId++,this.totalAnts++}this.drawAndFillMidpointCircle(t,this.x,this.y,B.COLONY_RADIUS)}}drawMidpointCircle(t,e,n,i){let o=i,r=0,l=1-i;if(this.drawSymmetricPoints(t,e,n,o,r),i>0)for(;o>r;)r++,l<=0?l=l+2*r+1:(o--,l=l+2*r-2*o+1),this.drawSymmetricPoints(t,e,n,o,r)}drawSymmetricPoints(t,e,n,i,o){i*=u.SIZE,o*=u.SIZE;const r=t.getCellFromCoordsSafe(e+i,n+o);r&&(r.colony=!0);const l=t.getCellFromCoordsSafe(e-i,n+o);l&&(l.colony=!0);const f=t.getCellFromCoordsSafe(e+i,n-o);f&&(f.colony=!0);const g=t.getCellFromCoordsSafe(e-i,n-o);g&&(g.colony=!0);const E=t.getCellFromCoordsSafe(e+o,n+i);E&&(E.colony=!0);const C=t.getCellFromCoordsSafe(e-o,n+i);C&&(C.colony=!0);const Y=t.getCellFromCoordsSafe(e+o,n-i);Y&&(Y.colony=!0);const j=t.getCellFromCoordsSafe(e-o,n-i);j&&(j.colony=!0)}drawAndFillMidpointCircle(t,e,n,i){let o=i,r=0,l=1-i;if(this.drawAndFillSymmetricLines(t,e,n,o,r),i>0)for(;o>r;)r++,l<=0?l=l+2*r+1:(o--,l=l+2*r-2*o+1),this.drawAndFillSymmetricLines(t,e,n,o,r)}drawAndFillSymmetricLines(t,e,n,i,o){i*=u.SIZE,o*=u.SIZE,this.drawHorizontalLine(t,e-i,e+i,n+o),this.drawHorizontalLine(t,e-i,e+i,n-o),this.drawHorizontalLine(t,e-o,e+o,n+i),this.drawHorizontalLine(t,e-o,e+o,n-i)}drawHorizontalLine(t,e,n,i){for(let o=e;o<=n;o++){const r=t.getCellFromCoordsSafe(o,i);r&&(r.colony=!0)}}updateAndDrawAnts(t,e,n=!0){let i=!1;for(let o=0;o<this.ants.length;o++){this.isRunning&&(this.ants[o].find(t),this.ants[o].update(t,e,this),this.ants[o].addMarker(t,e),this.ants[o].isDead&&(i=!0));let r=!1;if(n){const l={x:I.IMG_HEIGHT*c,y:I.IMG_HEIGHT*c},f=(je+l.x)/c,g=(Qe-N+l.y)/c,E=h.x-f/2,C=h.y-N/2/c-g/2;this.ants[o].pos.x>=E&&this.ants[o].pos.x<=E+f&&this.ants[o].pos.y>=C&&this.ants[o].pos.y<=C+g&&(r=!0),this.isDrawingAnts&&r&&this.ants[o].draw()}i&&(console.log("Removed ant: ",this.ants[o]),this.ants.splice(o,1),i=!1)}}updateColony(t){!this.isRunning||(this.colonyClock+=t,this.colonyClock>=B.ANT_CREATION_PERIOD&&this.ants.length<this.maxAntsCount&&this.useFood(B.ANT_COST)&&(this.createAnt(),this.colonyClock=0))}createAnt(t=!1){if((this.ants.length<this.maxAntsCount||t)&&this.antIcon&&this.antImageInstance&&this.antFoodImageInstance&&this.antsCtx){const e=new $t(this.antsCtx,this.antImageInstance,this.antFoodImageInstance,this.antIcon,{id:this.antId+1,pos:{x:this.x,y:this.y}});this.ants.push(e),this.antId++,this.totalAnts++,this.isDebugMode&&console.log("Created ant: ",e)}else this.isDebugMode&&console.log("Can't create new ant - max count reached")}selectAnt(t){if(this.ants.length<=0)return null;let e=null,n=1/0;const i=I.IMG_HEIGHT/2;for(const o of this.ants){const r=o.pos.dist(t);r<n&&r<i&&(n=r,e=o)}return this.selectedAnt=e,e}removeAnt(){if(this.selectedAnt==null||this.ants.length<=0)return!1;const t=this.ants.findIndex(e=>{var n;return e.id===((n=this.selectedAnt)==null?void 0:n.id)});return t!=-1?(this.ants.splice(t,1),this.selectedAnt=null,!0):!1}toggleAntDebug(){if(this.ants.length>0)for(const t of this.ants)this.selectedAnt&&t.id===this.selectedAnt.id?t.debug=this.isDebugMode:t.debug=!1}drawColony(t){t.fillStyle=`rgb(${this.colonyColor[0]}, ${this.colonyColor[1]}, ${this.colonyColor[2]})`,G(t,this.x,this.y,B.COLONY_RADIUS*u.SIZE+u.SIZE/2)}addFood(t){this.food=Math.min(this.food+t,this.maxFood),this.totalFood+=t}useFood(t){return this.food>=t?(this.food-=t,!0):!1}}class Ze{constructor(t){a(this,"width");a(this,"height");this.width=t.width,this.height=t.height}createInstance(t){const e=document.createElement("canvas");e.width=this.width,e.height=this.height,console.log(`Created canvas image instance with size: ${this.width} x ${this.height}`);const n=e.getContext("2d");return n&&t(n,e),e}}class gn{constructor(t){a(this,"measurementArray");a(this,"sampleSize");a(this,"isMeasuring");a(this,"modes");a(this,"mode");this.measurementArray=new Map,this.sampleSize=60,this.isMeasuring=!0,this.modes=[],this.mode=0,this.getModes(t),this.createMeasurementArray(t)}getModes(t){for(const e of t)this.modes.push(e.mode)}changeMode(){this.mode==this.modes.length-1?(this.isMeasuring=!1,this.mode=-1):(this.isMeasuring=!0,this.mode++),this.toggleDisplayVisibility()}toggleDisplayVisibility(){for(const t of this.measurementArray.values()){if(!t.element)return;this.isMeasuring&&t.mode<=this.mode?t.element.style.display="block":t.element.style.display="none"}}createMeasurementArray(t){for(const e of t)for(const n of e.stats)this.measurementArray.set(n.name,{performanceArray:[],title:n.title,mode:e.mode,index:0})}createPerformanceDisplay(t){const e=[];for(const[n,i]of this.measurementArray){const o=document.createElement("span");o.dataset[n.toString()]="",o.title=i.title,this.isMeasuring&&i.mode<=this.mode?o.style.display="block":o.style.display="none",i.element=t.appendChild(o),e.push(i.element)}return e}startMeasurement(t){const e=this.measurementArray.get(t);e&&e.mode<=this.mode&&(e.startTime=performance.now())}endMeasurement(t){const e=this.measurementArray.get(t);e&&e.startTime&&e.mode<=this.mode&&(e.performanceArray[e.index]=performance.now()-e.startTime)}setPerformance(t,e){const n=this.measurementArray.get(t);n&&n.mode<=this.mode&&(n.performanceArray[n.index]=e)}update(){const t=new Map;for(const e of this.measurementArray.keys())t.set(e,0);for(const[e,n]of this.measurementArray)for(let i=0;i<n.performanceArray.length;i++)t.set(e,t.get(e)+n.performanceArray[i]);for(const[e,n]of this.measurementArray){if(n.performanceArray.length===0)break;t.set(e,t.get(e)/n.performanceArray.length),n.mode<=this.mode&&(n.index++,n.index===this.sampleSize&&(n.index=0))}return t}}class In{calculateDistances(t){for(let e=0;e<t.width;e++)for(let n=0;n<t.height;n++){const i=t.cells[t.getIndexFromCoords(e,n)];i.wall?i.dist=this.getMinDistance(e,n,t,!1,10):i.dist=this.getMinDistance(e,n,t,!0,3)}}calculateFoodDistances(t){for(let e=0;e<t.width;e++)for(let n=0;n<t.height;n++){const i=t.cells[t.getIndexFromCoords(e,n)];if(i.food.quantity>0){const o=Math.round(this.getMinDistance(e,n,t,!1,3,!0)*100);i.food.quantity=o,i.food.changed=!0}}}getMinDistance(t,e,n,i,o,r=!1){let l=o;for(let f=-o;f<=o;f++)for(let g=-o;g<=o;g++){const E=n.cells[n.getIndexFromCoords(t+f,e+g)];if(E){if(r){if(E.food.quantity==0&&!E.wall){const C=W(f,g).mag();C<l&&(l=C)}}else if(E.wall&&i||!E.wall&&!i){const C=W(f,g).mag();C<l&&(l=C)}}}return l=Math.min(1,l/o)}}class st{constructor(t,e){a(this,"canvas");a(this,"width");a(this,"height");a(this,"cellSize");this.canvas=t,this.width=e.width,this.height=e.height,this.cellSize=e.cellSize}create(){return this.canvas.width=this.width,this.canvas.height=this.height,console.log(`Created canvas with size: ${this.width} x ${this.height}`),this.canvas.getContext("2d")}}function En(s){let t=Math.floor(s.width/s.cellSize),e=Math.floor(s.height/s.cellSize);t%2===0&&t--,e%2===0&&e--;const n=t*s.cellSize,i=e*s.cellSize;return console.log(`Calculate sizes:
${s.width==n?n:`${s.width} -> ${n}`} x ${s.height==i?i:`${s.height} -> ${i}`}`),[n,i]}class pn{constructor(t){a(this,"quantity");a(this,"changed");this.quantity=t,this.changed=!0}draw(t,e,n){t.clearRect(e*x.SIZE,n*x.SIZE,x.SIZE,x.SIZE);const i=e*x.SIZE+x.SIZE/2,o=n*x.SIZE+x.SIZE/2;t.fillStyle=`hsl(120, 40%, 43%, ${this.quantity/100})`,G(t,i,o,x.SIZE/2,!0),this.changed=!1}pick(){if(this.changed=!0,this.quantity===0)return 0;let t=0;return this.quantity<x.PICK_AMOUNT?t=this.quantity:t=x.PICK_AMOUNT,this.quantity=Math.max(this.quantity-x.PICK_AMOUNT,0),t}}class wn{constructor(t){a(this,"intensity");this.intensity=t}getToHomeIntensity(){return this.intensity[0]}getToFoodIntensity(){return this.intensity[1]}getMixedColor(){if(this.intensity[0]===0&&this.intensity[1]===0)return[0,0,0];const[t,e,n]=ye.TO_HOME,[i,o,r]=ye.TO_FOOD,l=[this.intensity[0]*t,this.intensity[0]*e,this.intensity[0]*n];if(this.intensity[1]===0)return[Math.round(l[0]),Math.round(l[1]),Math.round(l[2])];const f=[this.intensity[1]*i,this.intensity[1]*o,this.intensity[1]*r];if(this.intensity[0]===0)return[Math.round(f[0]),Math.round(f[1]),Math.round(f[2])];let g=[l[0]+f[0],l[1]+f[1],l[2]+f[2]];return g=[Math.round(Math.min(g[0],255)),Math.round(Math.min(g[1],255)),Math.round(Math.min(g[2],255))],g}update(){this.intensity[0]>.01?this.intensity[0]-=ge:this.intensity[0]=0,this.intensity[1]>.01?this.intensity[1]-=ge:this.intensity[1]=0}}class Ee{constructor(){a(this,"marker");a(this,"food");a(this,"wall");a(this,"density");a(this,"colony");a(this,"dist");a(this,"minIntensity");this.marker=new wn([0,0]),this.food=new pn(0),this.wall=0,this.density=[0,0,0],this.colony=!1,this.dist=0,this.minIntensity=.1}update(){this.marker.update()}pick(){return this.food.pick()}drawWall(t,e,n,i){if(i){const o=Math.min(1,1-this.dist+.15);t.fillStyle=`rgb(${163*o}, ${163*o}, ${163*o})`}t.fillRect(e,n,1,1)}addDensity(t=!1,e=!1){!t&&!e?this.density[0]++:e?this.density[2]++:this.density[1]++}getIntensity(t){return Math.max(this.minIntensity,t===p.TO_FOOD?this.marker.getToFoodIntensity():t===p.TO_HOME?this.marker.getToHomeIntensity():Math.max(this.marker.getToFoodIntensity(),this.marker.getToHomeIntensity()))}}class Cn{constructor(t){a(this,"width");a(this,"height");a(this,"cellSize");a(this,"cells");this.width=t.width,this.height=t.height,this.cellSize=t.cellSize,this.cells=[];for(let e=0;e<this.width*this.height;e++)this.cells.push(new Ee)}reset(){this.cells=[];for(let t=0;t<this.width*this.height;t++)this.cells.push(new Ee)}addBorderWalls(){const t=ft.BORDER_SIZE;for(let e=0;e<this.width;e++)for(let n=0;n<t;n++){const i=this.cells[this.getIndexFromCoords(e,n)],o=this.cells[this.getIndexFromCoords(e,this.height-n-1)];i.wall=1,o.wall=1}for(let e=0;e<t;e++)for(let n=0;n<this.height;n++){const i=this.cells[this.getIndexFromCoords(e,n)],o=this.cells[this.getIndexFromCoords(this.width-e-1,n)];i.wall=1,o.wall=1}}generateWalls(t){for(let e=0;e<this.width;e++)for(let n=0;n<this.height;n++)this.cells[this.getIndexFromCoords(e,n)].wall=t[e][n]?1:0}generateFood(t){for(let e=0;e<this.width;e++)for(let n=0;n<this.height;n++)this.cells[this.getIndexFromCoords(e,n)].food.quantity=t[e][n],this.cells[this.getIndexFromCoords(e,n)].food.changed=!0}update(){for(const t of this.cells)this.updateCell(t)}updateCell(t){t.marker.update();for(let e=0;e<3;e++)t.density[e]>.01?t.density[e]*=.99:t.density[e]=0}addMarker(t,e,n,i){const o=this.cells[this.getIndexFromCoords(t,e)];n===ct.TO_HOME?o.marker.intensity[0]=Math.min(1,Math.max(o.marker.getToHomeIntensity(),i)):n===ct.TO_FOOD&&(o.marker.intensity[1]=Math.min(1,Math.max(o.marker.getToFoodIntensity(),i)))}addFood(t,e,n){const i=this.getIndexFromCoords(t,e);if(i>this.cells.length||i<0)return;const o=this.cells[i];o.food.quantity=Math.min(o.food.quantity+n,100),o.food.changed=!0}drawMarkers(t,e,n=!0){for(let i=0;i<e.data.length;i+=4){const o=this.cells[i/4];e.data[i+0]=o.marker.getToHomeIntensity()*255,e.data[i+1]=o.marker.getToFoodIntensity()*255,e.data[i+2]=0,e.data[i+3]=255,n&&this.updateCell(o)}t.putImageData(e,0,0)}drawFood(t){for(let e=0;e<this.cells.length;e++)if(this.cells[e].food.changed){const[n,i]=this.getCoordsFromIndex(e);this.cells[e].food.draw(t,n,i)}}drawWalls(t,e=!0){t.fillStyle="rgb(163, 163, 163)";for(let n=0;n<this.width;n++)for(let i=0;i<this.height;i++){const o=this.cells[this.getIndexFromCoords(n,i)];o.wall===1&&o.drawWall(t,n,i,e)}}drawDensity(t,e,n=!0,i=!1){for(let o=0;o<e.data.length;o+=4){const r=this.cells[o/4],l=r.density;if(i)e.data[o+0]=4*l[0],e.data[o+1]=4*l[1],e.data[o+2]=4*l[2],e.data[o+3]=255;else{const f=l[0]+l[1]+l[2];e.data[o+0]=4*f,e.data[o+1]=f,e.data[o+2]=f,e.data[o+3]=255}n&&this.updateCell(r)}t.putImageData(e,0,0)}isOnFood(t,e){return this.cells[this.getIndexFromCoords(t,e)].food.quantity>0}getIndexFromCoords(t,e){return t+e*this.width}getCoordsFromIndex(t){const e=t%this.width,n=Math.floor(t/this.width);return[e,n]}getCellCoords(t,e){const n=Math.floor(t/u.SIZE),i=Math.floor(e/u.SIZE);return[n,i]}getCellFromCoords(t,e,n=!1){return n||([t,e]=this.getCellCoords(t,e)),this.cells[this.getIndexFromCoords(t,e)]}getCellFromCoordsSafe(t,e){const[n,i]=this.getCellCoords(t,e);return this.checkCoords(n,i)?this.getCellFromCoords(n,i,!0):null}checkCoords(t,e){return t>-1&&t<this.width&&e>-1&&e<this.height}rayCast(t,e,n){const i=n*Math.cos(e),o=n*Math.sin(e),r=t.copy();r.x+=i,r.y+=o;const l=r.copy().sub(t).normalize(),f={x:Math.sqrt(1+l.y/l.x*(l.y/l.x)),y:Math.sqrt(1+l.x/l.y*(l.x/l.y))},g={x:t.x,y:t.y},E={x:0,y:0},C={x:0,y:0};l.x<0?(C.x=-1,E.x=(t.x-Math.round(g.x))*f.x):(C.x=1,E.x=(Math.round(g.x+1)-t.x)*f.x),l.y<0?(C.y=-1,E.y=(t.y-Math.round(g.y))*f.y):(C.y=1,E.y=(Math.round(g.y+1)-t.y)*f.y);const Y={maxWidth:this.width*u.SIZE,maxHeight:this.height*u.SIZE};let j=!1,O=0;for(;!j&&O<n&&(E.x<E.y?(g.x+=C.x,O=E.x,E.x+=f.x):(g.y+=C.y,O=E.y,E.y+=f.y),!(g.x<0||g.x>=Y.maxWidth||g.y<0||g.y>=Y.maxHeight));){const ut=this.getCellFromCoords(g.x,g.y);if(ut&&ut.wall==1){j=!0;const at={x:E.x<E.y?1:0,y:E.y<E.x?1:0};return{cell:ut,distance:O,normal:at,intersection:t.add(l.mult(O)),rayEnd:r}}}return null}}function Mn(){return new Worker("/Ants_Simulation/assets/mapWorker.58459cd4.js",{type:"module"})}const Q=document.getElementById("canvas-container"),An=document.getElementById("camera-container"),Sn=document.getElementById("btn-fullscreen"),On=document.getElementById("btn-pan"),xn=document.getElementById("canvas"),Be=document.getElementById("canvas-markers"),$e=document.getElementById("canvas-food"),bn=document.getElementById("canvas-colony"),We=document.getElementById("canvas-walls"),Et=document.getElementById("canvas-edit"),pt=document.getElementById("canvas-edit-preview"),pe=document.getElementById("antIcon"),Dt=document.getElementById("btn-ant-panel"),re=document.getElementById("antPanel"),we=document.querySelector("[data-id]"),Ce=document.querySelector("[data-pos]"),Me=document.querySelector("[data-vel]"),Ae=document.querySelector("[data-state]"),Wt=document.querySelector("[data-lifespan-preview]"),Se=document.querySelector("[data-lifespan]"),Oe=document.querySelector("[data-marker-preview]"),xe=document.querySelector("[data-marker]"),jt=document.getElementById("btn-track"),Fn=document.getElementById("btn-remove"),Qt=document.getElementById("btn-cell-panel"),Ye=document.getElementById("cellPanel"),be=document.querySelector("[data-cell-preview]"),Fe=document.querySelector("[data-coords]"),ke=document.querySelector("[data-intensity-home]"),Te=document.querySelector("[data-intensity-food]"),De=document.querySelector("[data-cell-food]"),_e=document.querySelector("[data-density]"),Le=document.querySelector("[data-dist]"),ve=document.querySelector("[data-colony]"),Jt=document.getElementById("btn-colony-panel"),Ve=document.getElementById("colonyPanel"),Re=document.querySelector("[data-colony-preview]"),Pe=document.querySelector("[data-colony-pop]"),Ne=document.querySelector("[data-colony-food]"),ze=document.querySelector("[data-pause]"),Ue=document.getElementById("btn-play"),Ge=document.getElementById("btn-pause"),le=document.getElementById("btn-edit-mode"),Ke=document.getElementById("editPanel"),He=document.querySelector("[data-brush-preview]"),kn=document.querySelector("[data-brush-size]"),Tn=document.getElementById("brush-size-minus"),Dn=document.getElementById("brush-size-plus"),J=document.getElementById("brushSizeInput"),zt=document.getElementById("btn-wall-brush"),ce=document.getElementById("btn-food-brush"),_n=document.getElementById("btn-save"),Ln=document.getElementById("btn-controls"),vn=document.getElementById("btn-close-controls"),Ht=document.getElementById("controlsPanel"),Rn=document.querySelector("[data-performance-display]"),it=document.getElementById("mapPanel"),Pn=document.getElementById("btn-close-map"),Nn=document.getElementById("btn-cancel-map"),zn=document.getElementById("btn-map-panel"),Hn=document.getElementById("btn-generate-seed"),qn=document.getElementById("btn-generate-save-map"),Zn=document.getElementById("map-form"),ht=document.getElementById("map-seed"),wt=document.getElementById("btn-ants-layer"),Ct=document.getElementById("btn-density-layer"),Mt=document.getElementById("btn-density-all-layer"),At=document.getElementById("btn-markers-layer"),gt=document.getElementById("confirmDialog"),Bn=document.getElementById("btn-cancel"),$n=document.getElementById("btn-confirm"),Xe=new Mn;Xe.onmessage=s=>{var t;if(console.log(`Worker said : ${s.data.action}`),s.data.action=="GENERATE_PARTIAL"&&b&&(b.clearRect(0,0,d.width,d.height),d.generateWalls(s.data.map),d.drawWalls(b,!1)),s.data.action=="GENERATE"){const e=s.data.seed,n=new URL(window.location.href);e&&(n.searchParams.set("seed",e),window.history.pushState({path:n.href},"",n.href)),ht.value=(t=new URL(window.location.href).searchParams.get("seed"))!=null?t:"",b&&St&&(b.clearRect(0,0,d.width,d.height),d.generateWalls(s.data.map),console.log("calculate"),oe.calculateDistances(d),console.log("draw"),d.drawWalls(b),d.generateFood(s.data.foodMap),oe.calculateFoodDistances(d)),ne=!1}};let R=!1,et=!0,_=!1,L=!1,kt=!1,tt=!1,Tt=!1,F=!1,te=!1,ee=!1,H=!1,U=!1,Yt=!1,_t=!0,de=!1,ne=!1,Lt=!1,It=!1,K=!1,q=!1,A=!1,v=!1,Vt=0;const S=new gn([{mode:0,stats:[{name:"fps",title:"Frames per second"},{name:"ms",title:"Milliseconds to render a frame"}]},{mode:1,stats:[{name:"clear",title:"Milliseconds to clear the screen"},{name:"grid",title:"Milliseconds to draw markers/density and update cells"},{name:"food",title:"Milliseconds to draw food"},{name:"ants",title:"Milliseconds to draw and update ants"},{name:"panels",title:"Milliseconds to update info panels"},{name:"all",title:"Milliseconds needed for main loop"}]}]),[Wn,Ut,Yn,Vn,Un,Gn,Kn,Xn]=S.createPerformanceDisplay(Rn),N=Q.getBoundingClientRect().top;let qt=0,Zt=0,c=1,rt=!1,vt=!1,Gt=0;const $={x:0,y:0},y={x:0,y:0},h={x:0,y:0};let xt=0,se=!1,Z=5;const jn=new URL(window.location.href),Kt=jn.searchParams.get("seed");let mt=Kt!=null?Kt:"";ht.value=mt;let je=window.innerWidth,Qe=window.innerHeight;window.addEventListener("resize",()=>{je=window.innerWidth,Qe=window.innerHeight;const s={x:0,y:0};s.x=window.innerWidth/2/c-y.x,s.y=window.innerHeight/2/c-y.y,y.x=window.innerWidth/2/c-s.x,y.y=window.innerHeight/2/c-s.y,h.x=(window.innerWidth/2-window.innerWidth/2)/c-s.x,h.y=(window.innerHeight/2-window.innerHeight/2)/c-s.y,h.x=h.x<0?Math.abs(h.x):h.x*-1,h.y=h.y<0?Math.abs(h.y):h.y*-1,ot()});const[T,D]=En({width:me.WIDTH,height:me.HEIGHT,cellSize:u.SIZE}),Qn=new st(Be,{width:T/u.SIZE,height:D/u.SIZE,cellSize:1});Be.style.transform=`scale(${u.SIZE})`;const k=Qn.create(),Jn=new st($e,{width:T/(u.SIZE/x.SIZE),height:D/(u.SIZE/x.SIZE),cellSize:u.SIZE/x.SIZE});$e.style.transform=`scale(${u.SIZE/x.SIZE})`;const St=Jn.create(),ts=new st(xn,{width:T,height:D,cellSize:u.SIZE}),lt=ts.create(),es=new Ze({width:I.IMG_WIDTH,height:I.IMG_HEIGHT}),ns=new Ze({width:I.FOOD_SIZE,height:I.FOOD_SIZE}),ss=new st(bn,{width:T,height:D,cellSize:u.SIZE}),ie=ss.create(),is=new st(We,{width:T/u.SIZE,height:D/u.SIZE,cellSize:1});We.style.transform=`scale(${u.SIZE})`;const b=is.create(),os=new st(Et,{width:T/u.SIZE,height:D/u.SIZE,cellSize:1});Et.style.transform=`scale(${u.SIZE})`;const P=os.create(),as=new st(pt,{width:T/u.SIZE,height:D/u.SIZE,cellSize:1});pt.style.transform=`scale(${u.SIZE})`;const yt=as.create(),d=new Cn({width:T/u.SIZE,height:D/u.SIZE,cellSize:1}),oe=new In;nt({action:"SETUP",mapGeneratorOptions:{width:d.width,height:d.height,fillRatio:ft.FILL_RATIO,fillRatioFood:ft.FILL_RATIO_FOOD,threshold:ft.THRESHOLD,thresholdFood:ft.THRESHOLD_FOOD}},!0);const Rt=k==null?void 0:k.createImageData(d.width,d.height),bt=k==null?void 0:k.createImageData(d.width,d.height),m=new yn({id:1,pos:{x:T/2,y:D/2}});window.addEventListener("keydown",s=>{if(!de)switch(s.code){case"Space":s.preventDefault(),Nt();break;case"KeyM":nn();break;case"KeyN":ue();break;case"KeyA":an();break;case"KeyD":ds();break;case"KeyT":on();break;case"KeyC":F?rs():fe();break;case"KeyR":if(s.ctrlKey)break;m.ants.length>B.COLONY_STARTING_ANTS?(R=!0,Nt(),v=w(v,gt)):nt({action:"GENERATE",seed:dt(!1)});break;case"Delete":ln();break;case"Insert":for(let t=0;t<(s.ctrlKey?10:s.shiftKey?100:1);t++)us();break;case"KeyF":S.changeMode();break;case"KeyQ":F&&Je();break;case"KeyE":if(v){rn(),nt({action:"GENERATE",seed:dt(!1)}),v=w(v,gt);break}F?tn():ae();break;case"KeyS":F&&en();break;case"ArrowUp":Ft(0,Ot);break;case"ArrowDown":Ft(0,-Ot);break;case"ArrowLeft":Ft(Ot,0);break;case"ArrowRight":Ft(-Ot,0);break;case"Minus":qe(!1);break;case"Equal":qe(!0);break;case"Comma":Pt(-X.STEP);break;case"Period":Pt(X.STEP);break;case"Escape":v&&(v=w(v,gt)),q&&(q=w(q,Ht)),A&&(A=w(A,it)),F&&ae();break}});Q.addEventListener("mousemove",s=>{qt=s.pageX,Zt=s.pageY-N});Q.addEventListener("click",()=>{if(vt){vt=!1;return}hs(),tt&&sn()});Q.addEventListener("contextmenu",s=>{if(s.preventDefault(),F)return;const t=W(Math.floor((qt/c-y.x)/u.SIZE),Math.floor((Zt/c-y.y)/u.SIZE));tt&&console.log(`Placed food at: ${t.x}:${t.y}`),d.addFood(t.x,t.y,10)});Q.addEventListener("wheel",s=>{Es(s)});Sn.addEventListener("click",()=>{fe()});jt.addEventListener("click",()=>{on()});Fn.addEventListener("click",()=>{ln()});Ue.addEventListener("click",()=>{Nt()});Ge.addEventListener("click",()=>{Nt()});Tn.addEventListener("click",()=>{Pt(-X.STEP)});Dn.addEventListener("click",()=>{Pt(X.STEP)});Jt.addEventListener("click",()=>{Lt=w(Lt,Ve,Jt)});Lt=w(Lt,Ve,Jt);Qt.addEventListener("click",()=>{It=w(It,Ye,Qt)});Dt.addEventListener("click",()=>{K=w(K,re,Dt)});Ln.addEventListener("click",()=>{q=w(q,Ht),A=!0,A=w(A,it)});vn.addEventListener("click",()=>{q=!0,q=w(q,Ht)});zn.addEventListener("click",()=>{A=w(A,it),q=!0,q=w(q,Ht)});Pn.addEventListener("click",()=>{A=!0,A=w(A,it)});Nn.addEventListener("click",()=>{A=!0,A=w(A,it)});Hn.addEventListener("click",()=>{const s=Math.random().toString(36).slice(2,7);console.log(s),ht.value=s});$n.addEventListener("click",()=>{rn(),nt({action:"GENERATE",seed:dt(!1)}),v=w(v,gt)});Bn.addEventListener("click",()=>{v=w(v,gt)});wt.addEventListener("click",()=>{M(m.isDrawingAnts,wt),an()});Ct.addEventListener("click",()=>{M(m.isDrawingAnts,Ct),ue(!0,!1)});Mt.addEventListener("click",()=>{M(m.isDrawingAnts,Mt),ue(!1,!0)});At.addEventListener("click",()=>{M(m.isDrawingAnts,At),nn()});ht.addEventListener("focus",()=>{de=!0});ht.addEventListener("blur",()=>{de=!1});Zn.addEventListener("submit",s=>{console.log("submit",s),mt=ht.value,console.log(mt),A=!0,A=w(A,it),b&&mt&&nt({action:"GENERATE",seed:dt(!1,mt)}),s.preventDefault()});qn.addEventListener("click",()=>{A=!0,A=w(A,it),b&&nt({action:"GENERATE",seed:dt(!1)})});le.addEventListener("click",()=>{ae()});function ae(){F=w(F,Ke,le),F?(Et.style.display="block",pt.style.display="block"):(Et.style.display="none",pt.style.display="none")}zt.addEventListener("click",()=>{Je()});function Je(){H&&!U||(H=M(H,zt),H&&(U=!0,U=M(H,ce)))}ce.addEventListener("click",()=>{tn()});function tn(){U&&!H||(U=M(U,ce),U&&(H=!0,H=M(U,zt)))}_n.addEventListener("click",()=>{en()});function en(){if(P&&b){const s=P.getImageData(0,0,d.width,d.height);b.clearRect(0,0,d.width,d.height);for(let t=0;t<s.data.length;t+=4){const e=d.cells[t/4],n=s.data[t+0],i=s.data[t+1],o=s.data[t+2],r=s.data[t+3];i<=160&&i>0&&i>n&&i>o?e.wall!==1?(e.food.quantity=Math.min(100,Math.round(100*(r/255))+e.food.quantity),e.food.changed=!0):e.wall=1:n>10&&i>10&&o>10&&n===i&&i===o?(e.wall=1,e.food.quantity=0,e.food.changed=!0):r>0&&n<5&&i<5&&o<5&&(e.food.quantity=0,e.food.changed=!0,e.wall=0)}d.addBorderWalls(),oe.calculateDistances(d),d.drawWalls(b),P.clearRect(0,0,d.width,d.height),F=w(F,Ke,le),Et.style.display="none",pt.style.display="none"}}function rs(){P&&b&&P.clearRect(0,0,d.width,d.height)}J.addEventListener("input",()=>{Z=parseInt(J.value),he()});function ls(){J.min=X.MIN_SIZE.toString(),J.max=X.MAX_SIZE.toString(),J.step=X.STEP.toString(),J.value=Z.toString()}function he(){He.style.width=`${Z}px`,He.style.height=`${Z}px`,kn.textContent=`${Z} px`}function Pt(s){Z=Math.min(X.MAX_SIZE,Math.max(X.MIN_SIZE,Z+s)),J.value=Z.toString(),he()}ls();he();H=M(H,zt);cs();Is();fe();window.requestAnimationFrame(cn);function cs(){if(!(k==null||St==null||lt==null||ie==null||b==null||P==null||yt==null)){if(Rt&&(d.drawMarkers(k,Rt),d.drawFood(St)),pe){const s=new XMLSerializer().serializeToString(pe),t=btoa(s),n="data:image/svg+xml;base64,"+t,i=new Image;i.src=n,i.onload=()=>{const o=es.createInstance(l=>{l.drawImage(i,0,0)}),r=ns.createInstance(l=>{const f=I.FOOD_SIZE/2;l.fillStyle="hsl(120, 40%, 43%)",G(l,f,f,I.FOOD_SIZE/2)});m.initialize(i,o,r,lt,d)}}m.drawColony(ie),nt({action:"GENERATE",setup:!0,seed:dt(!0)}),M(!1,wt),M(!_,Ct),M(!L,Mt),M(!et,At)}}function Nt(){_t&&(m.isDrawingAnts=!0,_t=!1),ze&&(R=!R,m.isRunning=R,ze.style.display=R?"none":"block",Ue.style.display=R?"none":"flex",Ge.style.display=R?"flex":"none")}function nn(){et=M(et,At),et&&(_=!1,L=!1,kt=!1,M(!0,Ct),M(!0,Mt))}function ue(s,t){!s&&!t?(L=!!_,_=!(L||kt),kt=!_&&L):s?(_=!_,L=!1):t&&(L=!L,_=!1),(_||L)&&(et=!1,M(!0,At)),console.log(_,L,kt,et),M(!_,Ct),M(!L,Mt)}function ds(){tt=!tt,m.isDebugMode=tt,sn(),tt&&(It=!1),It=w(It,Ye,Qt)}function sn(){m.toggleAntDebug()}function on(){m.selectedAnt!=null&&(Tt=!Tt,Tt&&(c=3),jt.classList.toggle("border-green-500"),jt.classList.toggle("border-red-500"))}function Xt(){Yt=!Yt,Yt?document.body.classList.add("cursor-grabbing"):document.body.classList.remove("cursor-grabbing"),On.classList.toggle("bg-neutral-600")}function an(){if(_t){_t=!1,m.isDrawingAnts=!1,M(!m.isDrawingAnts,wt);return}m.isDrawingAnts=M(m.isDrawingAnts,wt)}function nt(s,t=!1){(!ne||t)&&(ne=!t,Xe.postMessage(s))}function rn(){d.reset(),m.reset(d)}function hs(){const s=W(qt/c-y.x,Zt/c-y.y);m.selectAnt(s),m.selectedAnt?K=!1:K=!0,K=w(K,re,Dt)}function ln(){m.removeAnt()&&(K=!0,K=w(K,re,Dt))}function us(){m.createAnt(!0)}function fs(){const s=m.selectedAnt;if(!s||!we||!Ce||!Me||!Ae||!Wt||!Se||!Oe||!xe)return;we.textContent=s.id.toString(),Ce.textContent=`${s.pos.x.toFixed(2)} : ${s.pos.y.toFixed(2)}`,Me.textContent=`${s.direction.vector.x.toFixed(2)} : ${s.direction.vector.y.toFixed(2)}`;let t="";switch(s.state){case p.TO_HOME:t="To Home";break;case p.TO_FOOD:t="To Food";break;case p.REFILL:t="Refill";break}Ae.textContent=t;const e=I.AUTONOMY_REFILL/s.maxAutonomy,n=s.internalClock/s.maxAutonomy;Wt.style.setProperty("--left",`${e*100}%`),Wt.style.setProperty("--width",`${n*100}%`),Se.textContent=`${s.internalClock.toFixed(2)} | ${s.maxAutonomy.toFixed(2)}`;const i=I.MARKER_DEFAULT_INTENSITY*Math.exp(-.15*s.markerIntensityClock);Oe.style.setProperty("--width",`${i/1*100}%`),xe.textContent=`${i.toFixed(2)} | ${1} | ${s.markerIntensityClock.toFixed(2)}`}function ms(s,t){const e=d.getCellFromCoordsSafe(s,t);if(!e||!ke||!Te||!De||!_e||!be||!Le||!ve||!Fe)return;Fe.textContent=`${s.toFixed(0)}-${t.toFixed(0)}`,ke.textContent=e.marker.getToHomeIntensity().toFixed(2),Te.textContent=e.marker.getToFoodIntensity().toFixed(2),De.textContent=e.food.quantity.toString(),_e.textContent=(e.density[0]+e.density[1]+e.density[2]).toFixed(2);const n=e.marker.getMixedColor();be.style.backgroundColor=`rgb(${n[0]}, ${n[1]}, ${n[2]})`,Le.textContent=e.dist.toFixed(2),ve.textContent=e.colony?"Yes":"No"}function ys(){if(!m||!Pe||!Ne||!Re)return;Pe.textContent=`${m.ants.length} | ${m.totalAnts}`,Ne.textContent=`${m.food.toFixed(2)} | ${m.totalFood}`;const s=m.colonyColor;Re.style.backgroundColor=`rgb(${s[0]}, ${s[1]}, ${s[2]})`}function gs(){const s=S.update();Wn.textContent=`${Math.round(s.get("fps")*100)/100} fps`,Ut.textContent=`${Math.round(s.get("ms")*100)/100} ms`,Yn.textContent=`${Math.round(s.get("clear")*100)/100} ms`,Vn.textContent=`${Math.round(s.get("grid")*100)/100} ms`,Un.textContent=`${Math.round(s.get("food")*100)/100} ms`,Gn.textContent=`${Math.round(s.get("ants")*100)/100} ms`,Kn.textContent=`${Math.round(s.get("panels")*100)/100} ms`,Xn.textContent=`${Math.round(s.get("all")*100)/100} ms`,s.get("ms")>16.7?Ut.classList.add("text-red-500"):Ut.classList.remove("text-red-500")}function Is(){Q.addEventListener("mousedown",s=>{if(clearTimeout(Gt),s.buttons==Bt&&F)ee=!0;else if(s.buttons==Bt)return;if(s.buttons==fn)rt=!0,vt=!1,Xt(),$.x=s.clientX/c-y.x,$.y=(s.clientY-N)/c-y.y;else{if(F){te=!0;return}rt=!1,Gt=setTimeout(()=>{rt=!0,vt=!0,Xt(),$.x=s.clientX/c-y.x,$.y=(s.clientY-N)/c-y.y},100)}}),Q.addEventListener("mousemove",s=>{!rt||s.buttons==Bt||ps(s)}),Q.addEventListener("mouseup",()=>{clearTimeout(Gt),te=!1,ee=!1,rt&&(rt=!1,Xt())})}function Es(s){const t={x:0,y:0};t.x=s.clientX/c-y.x,t.y=(s.clientY-N)/c-y.y,c*=.999**s.deltaY,c=Math.min(Math.max(.15,c),16),y.x=s.clientX/c-t.x,y.y=(s.clientY-N)/c-t.y,h.x=(s.clientX-window.innerWidth/2)/c-t.x,h.y=(s.clientY-N-window.innerHeight/2)/c-t.y,h.x=h.x<0?Math.abs(h.x):h.x*-1,h.y=h.y<0?Math.abs(h.y):h.y*-1,ot()}function ps(s){y.x=s.clientX/c-$.x,y.y=(s.clientY-N)/c-$.y;const t={x:window.innerWidth/2-T/2,y:window.innerHeight/2-D/2};(s.clientX-t.x)/c-$.x,(s.clientY-N-t.y)/c-$.y,s.clientX/c-y.x,(s.clientY-N)/c-y.y,h.x=(s.clientX-window.innerWidth/2)/c-$.x,h.y=(s.clientY-N-window.innerHeight/2)/c-$.y,h.x=h.x<0?Math.abs(h.x):h.x*-1,h.y=h.y<0?Math.abs(h.y):h.y*-1,ot()}function Ft(s,t){y.x+=s,y.y+=t,h.x-=s,h.y-=t,ot()}function qe(s){const t={x:0,y:0};t.x=window.innerWidth/2/c-y.x,t.y=window.innerHeight/2/c-y.y,c*=.999**(s?-100:100),c=Math.min(Math.max(.15,c),16),y.x=window.innerWidth/2/c-t.x,y.y=window.innerHeight/2/c-t.y,h.x=(window.innerWidth/2-window.innerWidth/2)/c-t.x,h.y=(window.innerHeight/2-window.innerHeight/2)/c-t.y,h.x=h.x<0?Math.abs(h.x):h.x*-1,h.y=h.y<0?Math.abs(h.y):h.y*-1,ot()}function fe(){const s={x:window.innerWidth/2-T/2,y:window.innerHeight/2-D/2};c=1,y.x=s.x,y.y=s.y,h.x=T/2,h.y=D/2,ot()}function ws(s,t){const e={x:window.innerWidth/2/c-s,y:window.innerHeight/2/c-t};y.x=e.x,y.y=e.y,h.x=window.innerWidth/2/c-e.x,h.y=window.innerHeight/2/c-e.y,ot()}function ot(){An.style.transform=`scale(${c}) translate(${y.x}px, ${y.y}px)`,se=!0}function cn(s){if(k==null||St==null||lt==null||ie==null||b==null||P==null||yt==null)return;window.requestAnimationFrame(cn),S.startMeasurement("all");const t=(s-Vt)/1e3;xt+=t;const e=(se||R)&&xt>Ie/c||xt>Ie*10/c;S.isMeasuring&&(S.setPerformance("fps",1/t),S.setPerformance("ms",s-Vt)),S.startMeasurement("clear"),e&&lt.clearRect(0,0,T,D),k.clearRect(0,0,d.width,d.height),S.endMeasurement("clear"),S.startMeasurement("grid"),et&&Rt?d.drawMarkers(k,Rt,R):_&&bt?d.drawDensity(k,bt,R):L&&bt?d.drawDensity(k,bt,R,!0):R&&d.update(),S.endMeasurement("grid"),S.startMeasurement("food"),d.drawFood(St),S.endMeasurement("food");const n=W(qt/c-y.x,Zt/c-y.y);if(F){yt.clearRect(0,0,d.width,d.height),yt.fillStyle="grey";const i=d.getCellCoords(n.x,n.y);G(yt,i[0],i[1],Z),ee?(P.fillStyle="black",G(P,i[0],i[1],Z)):te&&(H?P.fillStyle="rgb(163, 163, 163)":U&&(P.fillStyle="rgb(66, 153, 66, 0.25)"),G(P,i[0],i[1],Z))}m.updateColony(t),S.startMeasurement("ants"),e?m.updateAndDrawAnts(d,t):m.updateAndDrawAnts(d,t,!1),S.endMeasurement("ants"),S.startMeasurement("panels"),fs(),Tt&&m.selectedAnt&&ws(m.selectedAnt.pos.x,m.selectedAnt.pos.y),tt&&e&&(lt.fillStyle="red",G(lt,n.x,n.y,4),ms(n.x,n.y)),ys(),S.endMeasurement("panels"),S.isMeasuring&&(S.endMeasurement("all"),gs()),e&&(se=!1,xt=0),Vt=s}
