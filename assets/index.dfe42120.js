const zs=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerpolicy&&(o.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?o.credentials="include":i.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}};zs();const Be={WIDTH:1600*3,HEIGHT:1200*3},Pt={FILL_RATIO:.47,FILL_RATIO_FOOD:.37,THRESHOLD:50,THRESHOLD_FOOD:20,BORDER_SIZE:5};var et=(n=>(n[n.TO_HOME=0]="TO_HOME",n[n.TO_FOOD=1]="TO_FOOD",n))(et||{});const qe={TO_HOME:[255,0,0],TO_FOOD:[43,255,0]},I={WIDTH:16,HEIGHT:16,SIZE:16},We=2e-4/10,z={COLONY_RADIUS:3,COLONY_STARTING_ANTS:50,COLONY_MAX_ANTS:5e3,COLONY_MAX_FOOD:3e5,ANT_CREATION_PERIOD:.15,ANT_COST:30,ANT_REFILL_FOOD_AMOUNT:.25},ms={COLONY_ANTS:19e3,TEST_DURATION:10*1e3,HIDE_ANTS:!0};var Q=(n=>(n[n.ADVANCED=0]="ADVANCED",n[n.SIMPLE=1]="SIMPLE",n))(Q||{}),c=(n=>(n[n.TO_HOME=0]="TO_HOME",n[n.TO_FOOD=1]="TO_FOOD",n[n.REFILL=2]="REFILL",n))(c||{});const a={IMG_WIDTH:24,IMG_HEIGHT:34,DIRECTION_NOISE_RANGE:Math.PI*.05,WANDER_DISPLACE_RANGE:.5,WANDER_POINT_MAGNITUDE:100,WANDER_POINT_RADIUS:50,PERCEPTION_RADIUS:80,PERCEPTION_START_ANGLE:7/6*Math.PI,PERCEPTION_END_ANGLE:11/6*Math.PI,PERCEPTION_POINTS_HORIZONTAL:8,PERCEPTION_POINTS_VERTICAL:5,DIRECTION_PERIOD:.25,NUM_OF_RAYCASTS:16,MARKER_PERIOD:.15,MARKER_DEFAULT_INTENSITY:1,AUTONOMY_MAX:300,AUTONOMY_REFILL:150,FOOD_SIZE:16},$e=.005,x={SIZE:15,PICK_AMOUNT:2},re=2,Zs=4,at=I.SIZE,st={MIN_SIZE:1,MAX_SIZE:75,STEP:1};function F(n,t,e,s,i=!0,o=!1){n.beginPath(),n.arc(t,e,s,0,Math.PI*2),i&&n.fill(),o&&n.stroke()}function Ot(n,t,e,s,i){n.beginPath(),n.moveTo(t,e),n.lineTo(s,i),n.stroke(),n.closePath()}function _(n,t){return Math.random()*(t-n)+n}function T(n,t,e){return n=!n,n?(t.style.display="block",e==null||e.classList.add("border-green-500"),e==null||e.classList.remove("border-red-500")):(t.style.display="none",e==null||e.classList.add("border-red-500"),e==null||e.classList.remove("border-green-500")),n}function A(n,t){return n=!n,n?(t.classList.add("border-green-500"),t.classList.remove("border-red-500")):(t.classList.add("border-red-500"),t.classList.remove("border-green-500")),n}function dt(n=!1,t=""){const s=new URL(window.location.href).searchParams.get("seed");if(n&&s!=null)return s;if(n)return"";{const i=Math.random().toString(36).slice(2,7);return t!=""?t:i}}class J{constructor(t,e,s){this.x=t||0,this.y=e||0,this.z=s||0}set(t,e,s){return t instanceof J?(this.x=t.x||0,this.y=t.y||0,this.z=t.z||0,this):t instanceof Array?(this.x=t[0]||0,this.y=t[1]||0,this.z=t[2]||0,this):(this.x=t||0,this.y=e||0,this.z=s||0,this)}copy(){return new J(this.x,this.y,this.z)}add(t,e,s){return t instanceof J?(this.x+=t.x||0,this.y+=t.y||0,this.z+=t.z||0,this):t instanceof Array?(this.x+=t[0]||0,this.y+=t[1]||0,this.z+=t[2]||0,this):(this.x+=t||0,this.y+=e||0,this.z+=s||0,this)}sub(t,e,s){return t instanceof J?(this.x-=t.x||0,this.y-=t.y||0,this.z-=t.z||0,this):t instanceof Array?(this.x-=t[0]||0,this.y-=t[1]||0,this.z-=t[2]||0,this):(this.x-=t||0,this.y-=e||0,this.z-=s||0,this)}multSimple(t){return this.x*=t,this.y*=t,this.z*=t,this}mult(t,e,s){if(t instanceof J)return Number.isFinite(t.x)&&Number.isFinite(t.y)&&Number.isFinite(t.z)&&typeof t.x=="number"&&typeof t.y=="number"&&typeof t.z=="number"?(this.x*=t.x,this.y*=t.y,this.z*=t.z):console.warn("Vector.mult:","x contains components that are either undefined or not finite numbers"),this;if(t instanceof Array)return t.every(o=>Number.isFinite(o))&&t.every(o=>typeof o=="number")?t.length===1?(this.x*=t[0],this.y*=t[0],this.z*=t[0]):t.length===2?(this.x*=t[0],this.y*=t[1]):t.length===3&&(this.x*=t[0],this.y*=t[1],this.z*=t[2]):console.warn("Vector.mult:","x contains elements that are either undefined or not finite numbers"),this;const i=[...arguments];return i.every(o=>Number.isFinite(o))&&i.every(o=>typeof o=="number")?(arguments.length===1&&(this.x*=t,this.y*=t,this.z*=t),arguments.length===2&&(this.x*=t,this.y*=e||0),arguments.length===3&&(this.x*=t,this.y*=e||0,this.z*=s||0)):console.warn("Vector.mult:","x, y, or z arguments are either undefined or not a finite number"),this}div(t,e,s){if(t instanceof J){if(Number.isFinite(t.x)&&Number.isFinite(t.y)&&Number.isFinite(t.z)&&typeof t.x=="number"&&typeof t.y=="number"&&typeof t.z=="number"){if(t.x===0||t.y===0||t.z===0)return console.warn("Vector.div:","divide by 0"),this;this.x/=t.x,this.y/=t.y,this.z/=t.z}else console.warn("Vector.div:","x contains components that are either undefined or not finite numbers");return this}if(t instanceof Array){if(t.every(o=>Number.isFinite(o))&&t.every(o=>typeof o=="number")){if(t.some(o=>o===0))return console.warn("Vector.div:","divide by 0"),this;t.length===1?(this.x/=t[0],this.y/=t[0],this.z/=t[0]):t.length===2?(this.x/=t[0],this.y/=t[1]):t.length===3&&(this.x/=t[0],this.y/=t[1],this.z/=t[2])}else console.warn("Vector.div:","x contains components that are either undefined or not finite numbers");return this}const i=[...arguments];if(i.every(o=>Number.isFinite(o))&&i.every(o=>typeof o=="number")){if(i.some(o=>o===0))return console.warn("Vector.div:","divide by 0"),this;arguments.length===1&&(this.x/=t,this.y/=t,this.z/=t),arguments.length===2&&(this.x/=t,this.y/=e||0),arguments.length===3&&(this.x/=t,this.y/=e||0,this.z/=s||0)}else console.warn("Vector.div:","x, y, or z arguments are either undefined or not a finite number");return this}mag(){return Math.sqrt(this.magSq())}magSq(){const t=this.x,e=this.y,s=this.z;return t*t+e*e+s*s}dot(t,e,s){return this.x*(t||0)+this.y*(e||0)+this.z*(s||0)}dist(t){return t.copy().sub(this).mag()}normalize(){const t=this.mag();return t!==0&&(this.x*=1/t,this.y*=1/t,this.z*=1/t),this}limit(t){const e=this.magSq();return e>t*t&&(this.x/=Math.sqrt(e),this.y/=Math.sqrt(e),this.z/=Math.sqrt(e),this.x*=t,this.y*=t,this.z*=t),this}setMag(t){const e=this.normalize();return e.x*=t,e.y*=t,e.z*=t,e}heading(){return Math.atan2(this.y,this.x)}setHeading(t){let e=this.mag();return this.x=e*Math.cos(t),this.y=e*Math.sin(t),this}rotate(t){let e=this.heading()+t;const s=this.mag();return this.x=Math.cos(e)*s,this.y=Math.sin(e)*s,this}equals(t,e,s){let i,o,r;return t instanceof J?(i=t.x||0,o=t.y||0,r=t.z||0):t instanceof Array?(i=t[0]||0,o=t[1]||0,r=t[2]||0):(i=t||0,o=e||0,r=s||0),this.x===i&&this.y===o&&this.z===r}}function U(n,t,e){return new J(n,t,e)}class Yt{constructor(t,e,s,i,o){this.ctx=t,this.antImageInstance=e,this.antFoodImageInstance=s,this.antIcon=i,this.id=o.id,this.pos=U(o.pos.x,o.pos.y),this.vel=U(0,0),this.acc=U(0,0),this.maxSpeed=3,this.maxForce=.25,this.state=c.TO_FOOD,this.debug=o.debug||!1,this.wanderTheta=_(0,Math.PI*2),this.perceptionDraw=new Set,this.internalClock=0,this.markerClock=_(0,a.MARKER_PERIOD),this.directionClock=0,this.isDead=!1,this.freedomCoef=_(.01,.1),this.foodAmount=0,this.maxAutonomy=a.AUTONOMY_MAX-_(0,50)}seek(t){this.debug&&(this.ctx.strokeStyle="white",Ot(this.ctx,t.x,t.y,this.pos.x,this.pos.y));const e=t.copy().sub(this.pos);e.setMag(this.maxSpeed),e.sub(this.vel),e.limit(this.maxForce),this.applyForce(e)}wander(){const t=this.vel.copy();t.setMag(a.WANDER_POINT_MAGNITUDE),t.add(this.pos);const e=a.WANDER_POINT_RADIUS;this.debug&&(this.ctx.fillStyle="red",F(this.ctx,t.x,t.y,4),this.ctx.strokeStyle="white",F(this.ctx,t.x,t.y,e,!1,!0),Ot(this.ctx,this.pos.x,this.pos.y,t.x,t.y));const s=this.wanderTheta+this.vel.heading(),i=e*Math.cos(s),o=e*Math.sin(s);t.add(i,o),this.debug&&(this.ctx.fillStyle="green",F(this.ctx,t.x,t.y,8),Ot(this.ctx,this.pos.x,this.pos.y,t.x,t.y));const r=t.sub(this.pos);r.setMag(this.maxForce),r.limit(this.maxForce),this.applyForce(r);const l=a.WANDER_DISPLACE_RANGE;this.wanderTheta+=_(-l,l)}applyForce(t){this.acc.add(t)}update(t){this.internalClock+=t,this.directionClock+=t,this.internalClock>=a.AUTONOMY_REFILL&&this.state===c.TO_FOOD&&(this.state=c.REFILL),this.internalClock>=this.maxAutonomy&&(this.isDead=!0),this.vel.add(this.acc),this.vel.limit(this.maxSpeed),this.pos.add(this.vel),this.acc.set(0,0)}draw(){this.ctx.translate(this.pos.x,this.pos.y),this.ctx.rotate(this.vel.heading()+Math.PI/2);const t=-a.IMG_WIDTH/2,e=-a.IMG_HEIGHT/2;if(this.state===c.TO_HOME&&this.ctx.drawImage(this.antFoodImageInstance,-a.FOOD_SIZE/2,e-a.FOOD_SIZE/2),this.ctx.drawImage(this.antImageInstance,t,e),this.debug){this.ctx.strokeStyle="#FF0000",this.ctx.lineWidth=2,this.ctx.strokeRect(t,e,a.IMG_WIDTH,a.IMG_HEIGHT),this.ctx.fillStyle="red",F(this.ctx,0,0,4),this.ctx.beginPath(),this.ctx.arc(0,0,a.PERCEPTION_RADIUS,a.PERCEPTION_START_ANGLE,a.PERCEPTION_END_ANGLE),this.ctx.stroke(),this.ctx.strokeStyle="white",this.ctx.beginPath(),this.ctx.arc(0,0,a.PERCEPTION_RADIUS,a.PERCEPTION_END_ANGLE,a.PERCEPTION_START_ANGLE),this.ctx.stroke();const s=a.PERCEPTION_START_ANGLE,i=a.PERCEPTION_END_ANGLE,o=a.PERCEPTION_RADIUS*Math.cos(s),r=a.PERCEPTION_RADIUS*Math.sin(s),l=a.PERCEPTION_RADIUS*Math.cos(i),f=a.PERCEPTION_RADIUS*Math.sin(i);this.ctx.strokeStyle="red",Ot(this.ctx,0,0,o,r),Ot(this.ctx,0,0,l,f);const E=(a.PERCEPTION_END_ANGLE-a.PERCEPTION_START_ANGLE)/(a.PERCEPTION_POINTS_HORIZONTAL-1),h=a.PERCEPTION_RADIUS/a.PERCEPTION_POINTS_VERTICAL;for(let O=0;O<a.PERCEPTION_POINTS_HORIZONTAL;O++)for(let g=1;g<=a.PERCEPTION_POINTS_VERTICAL;g++){const w=E*O+a.PERCEPTION_START_ANGLE,C=h*g*Math.cos(w),K=h*g*Math.sin(w);this.perceptionDraw.has(g*a.PERCEPTION_POINTS_VERTICAL+O)?(this.ctx.strokeStyle="white",this.ctx.fillStyle="white"):(this.ctx.strokeStyle="red",this.ctx.fillStyle="green"),F(this.ctx,C,K,4),g===a.PERCEPTION_POINTS_VERTICAL&&Ot(this.ctx,0,0,C,K)}}this.debug&&(this.ctx.fillStyle="white",F(this.ctx,this.pos.x,this.pos.y,3)),this.ctx.resetTransform()}search(t,e){this.debug&&(this.perceptionDraw=new Set);const s=this.vel.copy();s.setMag(a.IMG_HEIGHT/2),s.add(this.pos);const i=t.getCellFromCoordsSafe(s.x,s.y),o=t.getCellFromCoordsSafe(this.pos.x,this.pos.y);if(o==null||o.addDensity(this.state===c.TO_HOME,this.state===c.REFILL),i&&i.food.quantity>0&&(this.state===c.TO_FOOD||this.state===c.REFILL)){this.state=c.TO_HOME,this.foodAmount=i.pick(),this.vel.setHeading(this.vel.heading()+Math.PI),this.internalClock=0;return}if(o&&o.colony&&(this.state===c.REFILL||this.state===c.TO_HOME)){if(this.state===c.TO_HOME&&(this.vel.setHeading(this.vel.heading()+Math.PI),e.addFood(this.foodAmount)),this.state===c.REFILL&&!e.useFood(z.ANT_REFILL_FOOD_AMOUNT))return;this.state=c.TO_FOOD,this.internalClock=0;return}if(Math.random()<this.freedomCoef)return;const r=(a.PERCEPTION_END_ANGLE-a.PERCEPTION_START_ANGLE)/(a.PERCEPTION_POINTS_HORIZONTAL-1),l=a.PERCEPTION_RADIUS/a.PERCEPTION_POINTS_VERTICAL;let f=a.PERCEPTION_POINTS_VERTICAL+1,E=null,h=0,O=null;const g=this.vel.heading(),w=-a.IMG_WIDTH/2,C=Math.PI/4+g+Math.PI,K=-Math.PI/4+g+Math.PI,_t=w*Math.cos(C),it=w*Math.sin(C),nt=w*Math.cos(K),yt=w*Math.sin(K),X=this.pos.copy().add(_t,it),gt=this.pos.copy().add(nt,yt),ae=t.getCellFromCoordsSafe(X.x,X.y),He=t.getCellFromCoordsSafe(gt.x,gt.y);if(ae&&ae.wall===1||He&&He.wall===1){const R=(ae?X:gt).sub(this.pos);R.sub(this.vel),R.mult(-1),this.applyForce(R);return}if(this.directionClock>=a.DIRECTION_PERIOD){for(let ot=0;ot<a.PERCEPTION_POINTS_HORIZONTAL;ot++)for(let R=1;R<=a.PERCEPTION_POINTS_VERTICAL;R++){const ze=r*ot+a.PERCEPTION_START_ANGLE+g+Math.PI/2,vs=l*R*Math.cos(ze),Hs=l*R*Math.sin(ze),It=this.pos.copy().add(vs,Hs),Et=t.getCellFromCoordsSafe(It.x,It.y);if(Et){if(Et.wall===1&&(R===1||R===2)){const pt=It.sub(this.pos),Ze=ot+1>a.PERCEPTION_POINTS_HORIZONTAL/2?a.PERCEPTION_POINTS_HORIZONTAL-ot:ot+1;pt.setMag(this.maxSpeed),pt.sub(this.vel),R===1?pt.limit(this.maxForce*Ze):R===2&&pt.limit(this.maxForce*.5*Ze),pt.mult(-1),this.applyForce(pt);break}if(Et.colony&&(this.state===c.REFILL||this.state===c.TO_HOME)){this.seek(It);return}if(Et.food.quantity>0&&(this.state===c.TO_FOOD||this.state===c.REFILL)){this.debug&&this.perceptionDraw.add(R*a.PERCEPTION_POINTS_VERTICAL+ot),R<f&&(f=R,E=It);break}let Wt=0;this.state===c.TO_HOME||this.state===c.REFILL?Wt=Et.marker.intensity[0]:(this.state===c.TO_FOOD||this.state===c.REFILL)&&(Wt=Et.marker.intensity[1]),Wt>h&&(h=Wt,O=It)}}if(E){this.seek(E);return}if(O){this.seek(O);return}this.directionClock=0}this.wander()}perception(t){const e=(a.PERCEPTION_END_ANGLE-a.PERCEPTION_START_ANGLE)/(a.PERCEPTION_POINTS_HORIZONTAL-1),s=a.PERCEPTION_RADIUS/a.PERCEPTION_POINTS_VERTICAL;let i=a.PERCEPTION_POINTS_VERTICAL+1,o=null,r=0,l=null;const f=this.vel.heading(),E=this.vel.copy().add(this.acc).limit(this.maxSpeed),h=this.pos.copy().add(E),O=t.getCellFromCoordsSafe(h.x,h.y);if((O==null?void 0:O.wall)===1){const g=h.sub(this.pos);this.debug&&console.log(g),g.x*=g.x!=0?-1:1,g.y*=g.y!=0?-1:1,g.sub(this.vel),this.applyForce(g);return}if(this.directionClock>=a.DIRECTION_PERIOD){for(let g=0;g<a.PERCEPTION_POINTS_HORIZONTAL;g++){const w=e*g+a.PERCEPTION_START_ANGLE+f+Math.PI/2;for(let C=1;C<=a.PERCEPTION_POINTS_VERTICAL;C++){const K=s*C*Math.cos(w),_t=s*C*Math.sin(w),it=this.pos.copy().add(K,_t),nt=t.getCellFromCoordsSafe(it.x,it.y);if(nt){if(nt.wall===1&&(C===1||C===2)){const X=it.sub(this.pos),gt=g+1>a.PERCEPTION_POINTS_HORIZONTAL/2?a.PERCEPTION_POINTS_HORIZONTAL-g:g+1;X.setMag(this.maxSpeed),X.sub(this.vel),C===1?X.limit(this.maxForce*gt):C===2&&X.limit(this.maxForce*.5*gt),X.mult(-1),this.applyForce(X);break}if(nt.colony&&(this.state===c.REFILL||this.state===c.TO_HOME)){this.seek(it);return}if(nt.food.quantity>0&&(this.state===c.TO_FOOD||this.state===c.REFILL)){this.debug&&this.perceptionDraw.add(C*a.PERCEPTION_POINTS_VERTICAL+g),C<i&&(i=C,o=it);break}let yt=0;this.state===c.TO_HOME||this.state===c.REFILL?yt=nt.marker.getToHomeIntensity():(this.state===c.TO_FOOD||this.state===c.REFILL)&&(yt=nt.marker.getToFoodIntensity()),yt>r&&(r=yt,l=it)}}}if(o){this.seek(o);return}if(l){this.seek(l);return}this.directionClock=0}}searchSimple(t,e){this.debug&&(this.perceptionDraw=new Set);const s=t.getCellFromCoordsSafe(this.pos.x,this.pos.y);if(s==null||s.addDensity(this.state===c.TO_HOME,this.state===c.REFILL),s&&s.food.quantity>0&&(this.state===c.TO_FOOD||this.state===c.REFILL)){this.state=c.TO_HOME,this.foodAmount=s.pick(),this.vel.setHeading(this.vel.heading()+Math.PI),this.internalClock=0;return}if(s&&s.colony&&(this.state===c.REFILL||this.state===c.TO_HOME)){if(this.state===c.TO_HOME&&(this.vel.setHeading(this.vel.heading()+Math.PI),e.addFood(this.foodAmount)),this.state===c.REFILL&&!e.useFood(z.ANT_REFILL_FOOD_AMOUNT))return;this.state=c.TO_FOOD,this.internalClock=0;return}Math.random()<this.freedomCoef||(this.perception(t),this.wander())}addMarker(t,e){if(this.markerClock+=e,this.markerClock>=a.MARKER_PERIOD){const s=t.getCellCoords(this.pos.x),i=t.getCellCoords(this.pos.y);if(!t.checkCoords(s,i))return;const o=a.MARKER_DEFAULT_INTENSITY*Math.exp(-.15*this.internalClock);let r=-1;switch(this.state){case c.TO_HOME:r=et.TO_FOOD;break;case c.TO_FOOD:r=et.TO_HOME;break;case c.REFILL:r=et.TO_HOME;break}t.addMarker(s,i,r,o),this.markerClock=0}}}class Bs{constructor(t,e=.1){this.angle=t,this.targetAngle=t,this.rotationSpeed=e,this.vector=U(),this.targetVector=U(),this.updateVector(),this.targetVector=this.vector.copy()}update(){this.updateVector();const t=-this.vector.y,e=this.vector.x,s=this.targetVector.x*t+this.targetVector.y*e;this.angle+=this.rotationSpeed*s}setDirectionImmediate(t){this.targetVector=t.copy(),this.vector=t.copy(),this.angle=t.heading(),this.targetAngle=this.angle}setDirectionAngle(t){this.targetAngle=t,this.updateTargetVector()}setAndAddDirectionAngle(t){this.targetAngle+=t,this.updateTargetVector()}addImmediate(t){this.setAndAddDirectionAngle(t),this.angle=this.targetAngle,this.updateVector()}getVec(){return this.vector}updateVector(){this.vector.x=Math.cos(this.angle),this.vector.y=Math.sin(this.angle)}updateTargetVector(){this.targetVector.x=Math.cos(this.targetAngle),this.targetVector.y=Math.sin(this.targetAngle)}}class Gt{constructor(t,e,s,i,o){this.ctx=t,this.antImageInstance=e,this.antFoodImageInstance=s,this.antIcon=i,this.id=o.id,this.pos=U(o.pos.x,o.pos.y),this.direction=new Bs(_(-Math.PI*2,Math.PI*2)),this.maxSpeed=2,this.state=c.TO_FOOD,this.debug=o.debug||!1,this.internalClock=0,this.markerPeriod=a.MARKER_PERIOD+_(-a.MARKER_PERIOD*.25,a.MARKER_PERIOD*.25),this.markerClock=_(0,a.MARKER_PERIOD),this.markerIntensityClock=0,this.directionPeriod=a.DIRECTION_PERIOD+_(-a.DIRECTION_PERIOD*.25,a.DIRECTION_PERIOD*.25),this.directionClock=_(0,a.DIRECTION_PERIOD),this.isDead=!1,this.freedomCoef=_(.01,.1),this.foodAmount=0,this.maxAutonomy=a.AUTONOMY_MAX-_(0,50),this.hits=0,this.foundCell=!1}updatePosition(t){const e=this.direction.getVec(),s=t.rayCast(this.pos.x,this.pos.y,this.direction.angle,a.IMG_HEIGHT/2+this.maxSpeed);if(s!=null&&s.cell){const i=e.copy();this.hits>16?i.setHeading(this.direction.angle+Math.PI/2):this.hits>8?(i.x*=s.normal.x!=0?1:-1,i.y*=s.normal.y!=0?1:-1):(i.x*=s.normal.x!=0?-1:1,i.y*=s.normal.y!=0?-1:1),this.hits+=4,this.direction.setDirectionImmediate(i)}else this.hits=Math.max(0,this.hits-1),this.pos.add(e.multSimple(this.maxSpeed))}find(t){if(this.directionClock>=this.directionPeriod){this.directionClock=0;let e=0,s=1,i=this.direction.angle,o=null;const r=i;for(let l=0;l<a.NUM_OF_RAYCASTS;l++){const f=_(-Math.PI*.3333333333333333,Math.PI*.3333333333333333),E=_(I.SIZE*3,I.SIZE*12),h=r+f,O=t.rayCast(this.pos.x,this.pos.y,h,E);if(O&&O.cell||!O.cellIndex)continue;const g=t.getCellFromIndex(O.cellIndex);if(!g)continue;if(this.debug&&(g.density=[g.density[0],g.density[1],100]),g.food.quantity>0&&this.state===c.TO_FOOD||this.state===c.TO_HOME&&g.colony){i=h,this.direction.setDirectionAngle(i),this.foundCell=!0;return}const w=g.dist*g.dist,C=g.getIntensity(this.state)*w;C>e&&(e=C,i=h,o=g),C<s&&(s=C)}if(e==s){this.foundCell=!1;return}e?(o&&this.debug&&(o.density=[0,100,0]),this.direction.setDirectionAngle(i),this.foundCell=!0):this.foundCell=!1}}update(t,e,s){this.internalClock+=e,this.markerIntensityClock+=e,this.directionClock+=e,this.internalClock>=this.maxAutonomy&&(this.isDead=!0),this.internalClock>=a.AUTONOMY_REFILL&&this.state===c.TO_FOOD&&(this.state=c.REFILL),this.direction.update(),this.foundCell?this.direction.setAndAddDirectionAngle(_(-a.DIRECTION_NOISE_RANGE/5,a.DIRECTION_NOISE_RANGE/5)):this.direction.setAndAddDirectionAngle(_(-a.DIRECTION_NOISE_RANGE,a.DIRECTION_NOISE_RANGE)),this.updatePosition(t);const i=t.getCellFromCoordsSafe(this.pos.x,this.pos.y);if(!!i){if(i.addDensity(this.state===c.TO_HOME,this.state===c.REFILL),i.food.quantity>0&&(this.state===c.TO_FOOD||this.state===c.REFILL)){this.state=c.TO_HOME,this.foodAmount=i.pick(),this.direction.addImmediate(Math.PI),this.internalClock=0,this.markerIntensityClock=0;return}if(i.food.quantity>0&&this.state===c.TO_HOME&&(this.markerIntensityClock=0),i.colony&&this.state===c.TO_FOOD&&(this.markerIntensityClock=0),i.colony&&(this.state===c.REFILL||this.state===c.TO_HOME)){if(this.state===c.TO_HOME&&(this.direction.addImmediate(Math.PI),s.addFood(this.foodAmount)),this.state===c.REFILL&&!s.useFood(z.ANT_REFILL_FOOD_AMOUNT))return;this.state=c.TO_FOOD,this.internalClock=0,this.markerIntensityClock=0;return}}}draw(){this.ctx.translate(this.pos.x,this.pos.y),this.ctx.rotate(this.direction.angle+Math.PI/2);const t=-a.IMG_WIDTH/2,e=-a.IMG_HEIGHT/2;this.state===c.TO_HOME&&this.ctx.drawImage(this.antFoodImageInstance,-a.FOOD_SIZE/2,e-a.FOOD_SIZE/2),this.ctx.drawImage(this.antImageInstance,t,e),this.debug&&(this.ctx.strokeStyle="#FF0000",this.ctx.lineWidth=2,this.ctx.strokeRect(t,e,a.IMG_WIDTH,a.IMG_HEIGHT),this.ctx.fillStyle="red",F(this.ctx,0,0,4)),this.debug&&(this.ctx.fillStyle="white",F(this.ctx,this.pos.x,this.pos.y,3)),this.ctx.resetTransform()}addMarker(t,e){if(this.markerClock+=e,this.markerClock>=this.markerPeriod){const s=t.getCellCoords(this.pos.x),i=t.getCellCoords(this.pos.y);if(!t.checkCoords(s,i))return;const o=a.MARKER_DEFAULT_INTENSITY*Math.exp(-.15*this.markerIntensityClock);if(o<.01){this.markerClock=0;return}let r=-1;switch(this.state){case c.TO_HOME:r=et.TO_FOOD;break;case c.TO_FOOD:r=et.TO_HOME;break;case c.REFILL:r=et.TO_HOME;break}t.addMarker(s,i,r,o),this.markerClock=0}}}class qs{constructor(t){this.id=t.id,this.x=t.pos.x,this.y=t.pos.y,this.startingAntsCount=z.COLONY_STARTING_ANTS,this.maxAntsCount=z.COLONY_MAX_ANTS,this.ants=[],this.totalAnts=0,this.colonyColor=t.colonyColor||[255,255,255],this.antIcon=null,this.antImageInstance=null,this.antFoodImageInstance=null,this.antId=0,this.isRunning=!1,this.isDrawingAnts=!1,this.isDebugMode=!1,this.colonyClock=0,this.antsCtx=null,this.selectedAnt=null,this.simulationType=Q.ADVANCED,this.food=0,this.totalFood=0,this.maxFood=z.COLONY_MAX_FOOD}initialize(t,e,s,i,o){this.antIcon=t,this.antImageInstance=e,this.antFoodImageInstance=s,this.antsCtx=i;for(let r=0;r<this.startingAntsCount;r++){if(this.simulationType===Q.ADVANCED){const l=new Gt(i,e,s,t,{id:this.antId+1,pos:{x:this.x,y:this.y}});this.ants.push(l)}else{const l=new Yt(i,e,s,t,{id:this.antId+1,pos:{x:this.x,y:this.y}});this.ants.push(l)}this.antId++,this.totalAnts++}this.drawAndFillMidpointCircle(o,this.x,this.y,z.COLONY_RADIUS)}reset(t){if(!(!this.antsCtx||!this.antImageInstance||!this.antFoodImageInstance||!this.antIcon)){this.ants=[],this.antId=0,this.totalAnts=0,this.colonyClock=0,this.food=0,this.totalFood=0,this.selectedAnt=null;for(let e=0;e<this.startingAntsCount;e++){if(this.simulationType===Q.ADVANCED){const s=new Gt(this.antsCtx,this.antImageInstance,this.antFoodImageInstance,this.antIcon,{id:this.antId+1,pos:{x:this.x,y:this.y}});this.ants.push(s)}else{const s=new Yt(this.antsCtx,this.antImageInstance,this.antFoodImageInstance,this.antIcon,{id:this.antId+1,pos:{x:this.x,y:this.y}});this.ants.push(s)}this.antId++,this.totalAnts++}this.drawAndFillMidpointCircle(t,this.x,this.y,z.COLONY_RADIUS)}}drawMidpointCircle(t,e,s,i){let o=i,r=0,l=1-i;if(this.drawSymmetricPoints(t,e,s,o,r),i>0)for(;o>r;)r++,l<=0?l=l+2*r+1:(o--,l=l+2*r-2*o+1),this.drawSymmetricPoints(t,e,s,o,r)}drawSymmetricPoints(t,e,s,i,o){i*=I.SIZE,o*=I.SIZE;const r=t.getCellFromCoordsSafe(e+i,s+o);r&&(r.colony=!0);const l=t.getCellFromCoordsSafe(e-i,s+o);l&&(l.colony=!0);const f=t.getCellFromCoordsSafe(e+i,s-o);f&&(f.colony=!0);const E=t.getCellFromCoordsSafe(e-i,s-o);E&&(E.colony=!0);const h=t.getCellFromCoordsSafe(e+o,s+i);h&&(h.colony=!0);const O=t.getCellFromCoordsSafe(e-o,s+i);O&&(O.colony=!0);const g=t.getCellFromCoordsSafe(e+o,s-i);g&&(g.colony=!0);const w=t.getCellFromCoordsSafe(e-o,s-i);w&&(w.colony=!0)}drawAndFillMidpointCircle(t,e,s,i){let o=i,r=0,l=1-i;if(this.drawAndFillSymmetricLines(t,e,s,o,r),i>0)for(;o>r;)r++,l<=0?l=l+2*r+1:(o--,l=l+2*r-2*o+1),this.drawAndFillSymmetricLines(t,e,s,o,r)}drawAndFillSymmetricLines(t,e,s,i,o){i*=I.SIZE,o*=I.SIZE,this.drawHorizontalLine(t,e-i,e+i,s+o),this.drawHorizontalLine(t,e-i,e+i,s-o),this.drawHorizontalLine(t,e-o,e+o,s+i),this.drawHorizontalLine(t,e-o,e+o,s-i)}drawHorizontalLine(t,e,s,i){for(let o=e;o<=s;o++){const r=t.getCellFromCoordsSafe(o,i);r&&(r.colony=!0)}}updateAndDrawAnts(t,e,s=!0){let i=!1;const o=a.IMG_HEIGHT*d,r=(ws+o)/d,l=(xs-P+o)/d,f=u.x-r/2,E=u.y-P/2/d-l/2;for(let h=0;h<this.ants.length;h++)this.isRunning&&(this.simulationType===Q.ADVANCED?(this.ants[h].find(t),this.ants[h].update(t,e,this),this.ants[h].addMarker(t,e)):(this.ants[h].searchSimple(t,this),this.ants[h].update(e),this.ants[h].addMarker(t,e)),this.ants[h].isDead&&(i=!0)),s&&this.isDrawingAnts&&this.ants[h].pos.x>=f&&this.ants[h].pos.x<=f+r&&this.ants[h].pos.y>=E&&this.ants[h].pos.y<=E+l&&this.ants[h].draw(),i&&(console.log("Removed ant: ",this.ants[h]),this.ants.splice(h,1),i=!1)}updateColony(t){!this.isRunning||(this.colonyClock+=t,this.colonyClock>=z.ANT_CREATION_PERIOD&&this.ants.length<this.maxAntsCount&&this.useFood(z.ANT_COST)&&(this.createAnt(),this.colonyClock=0))}createAnt(t=!1){if((this.ants.length<this.maxAntsCount||t)&&this.antIcon&&this.antImageInstance&&this.antFoodImageInstance&&this.antsCtx){if(this.simulationType===Q.ADVANCED){const e=new Gt(this.antsCtx,this.antImageInstance,this.antFoodImageInstance,this.antIcon,{id:this.antId+1,pos:{x:this.x,y:this.y}});this.ants.push(e),this.isDebugMode&&console.log("Created ant: ",e)}else{const e=new Yt(this.antsCtx,this.antImageInstance,this.antFoodImageInstance,this.antIcon,{id:this.antId+1,pos:{x:this.x,y:this.y}});this.ants.push(e),this.isDebugMode&&console.log("Created ant: ",e)}this.antId++,this.totalAnts++}else this.isDebugMode&&console.log("Can't create new ant - max count reached")}selectAnt(t){if(this.ants.length<=0)return null;let e=null,s=1/0;const i=a.IMG_HEIGHT/2;for(const o of this.ants){const r=o.pos.dist(t);r<s&&r<i&&(s=r,e=o)}return this.selectedAnt=e,e}removeAnt(){if(this.selectedAnt==null||this.ants.length<=0)return!1;const t=this.ants.findIndex(e=>{var s;return e.id===((s=this.selectedAnt)==null?void 0:s.id)});return t!=-1?(this.ants.splice(t,1),this.selectedAnt=null,!0):!1}toggleAntDebug(){if(this.ants.length>0)for(const t of this.ants)this.selectedAnt&&t.id===this.selectedAnt.id?t.debug=this.isDebugMode:t.debug=!1}drawColony(t){t.fillStyle=`rgb(${this.colonyColor[0]}, ${this.colonyColor[1]}, ${this.colonyColor[2]})`,F(t,this.x,this.y,z.COLONY_RADIUS*I.SIZE+I.SIZE/2)}addFood(t){this.food=Math.min(this.food+t,this.maxFood),this.totalFood+=t}useFood(t){return this.food>=t?(this.food-=t,!0):!1}}class ys{constructor(t){this.width=t.width,this.height=t.height}createInstance(t){const e=document.createElement("canvas");e.width=this.width,e.height=this.height,console.log(`Created canvas image instance with size: ${this.width} x ${this.height}`);const s=e.getContext("2d");return s&&t(s,e),e}}class Ws{constructor(t){this.measurementArray=new Map,this.sampleSize=60,this.isMeasuring=!0,this.modes=[],this.mode=0,this.performanceTest={lowestMap:new Map,avgMap:new Map,highestMap:new Map},this.isPerfTest=!1,this.getModes(t),this.createMeasurementArray(t)}getModes(t){for(const e of t)this.modes.push(e.mode)}changeMode(){this.mode==this.modes.length-1?(this.isMeasuring=!1,this.mode=-1):(this.isMeasuring=!0,this.mode++),this.toggleDisplayVisibility()}setMode(t){this.modes.find(e=>e===t)&&(this.mode=t,this.toggleDisplayVisibility())}toggleDisplayVisibility(){for(const t of this.measurementArray.values()){if(!t.element)return;this.isMeasuring&&t.mode<=this.mode?t.element.style.display="block":t.element.style.display="none"}}createMeasurementArray(t){for(const e of t)for(const s of e.stats)this.measurementArray.set(s.name,{performanceArray:[],title:s.title,mode:e.mode,index:0})}createPerformanceDisplay(t){const e=[];for(const[s,i]of this.measurementArray){const o=document.createElement("span");o.dataset[s.toString()]="",o.title=i.title,this.isMeasuring&&i.mode<=this.mode?o.style.display="block":o.style.display="none",i.element=t.appendChild(o),e.push(i.element)}return e}startMeasurement(t){const e=this.measurementArray.get(t);e&&e.mode<=this.mode&&(e.startTime=performance.now())}endMeasurement(t){const e=this.measurementArray.get(t);e&&e.startTime&&e.mode<=this.mode&&(e.performanceArray[e.index]=performance.now()-e.startTime)}setPerformance(t,e){const s=this.measurementArray.get(t);s&&s.mode<=this.mode&&(s.performanceArray[s.index]=e)}update(){const t=new Map,e=new Map,s=new Map;for(const i of this.measurementArray.keys())t.set(i,0),e.set(i,0),s.set(i,0);for(const[i,o]of this.measurementArray){if(o.performanceArray.length===0)break;let r=1/0,l=0,f=0;for(let E=0;E<o.performanceArray.length;E++){const h=o.performanceArray[E];h<r&&h!==0&&(r=h),f+=h,h>l&&(l=h)}t.set(i,r),e.set(i,l),s.set(i,f/o.performanceArray.length),this.isPerfTest&&this.add(t,e,s),o.mode<=this.mode&&(o.index++,o.index===this.sampleSize&&(o.index=0))}return s}startPerformanceTest(){for(const t of this.measurementArray.keys())this.performanceTest.lowestMap.set(t,1/0),this.performanceTest.highestMap.set(t,0),this.performanceTest.avgMap.set(t,0);this.isPerfTest=!0}endPerformanceTest(){this.isPerfTest=!1,console.log("--- Performance Test Results ---"),console.log("--- Average ---"),this.performanceTest.avgMap.forEach((t,e)=>console.log(e,parseFloat(t.toFixed(4)))),console.log("--- Highest ---"),this.performanceTest.highestMap.forEach((t,e)=>console.log(e,parseFloat(t.toFixed(4)))),console.log("--- Lowest ---"),this.performanceTest.lowestMap.forEach((t,e)=>console.log(e,parseFloat(t.toFixed(4))))}add(t,e,s){for(const i of this.measurementArray.keys()){const o=this.performanceTest.lowestMap.get(i),r=t.get(i);o!==void 0&&r!==void 0&&r<o&&r!==0&&this.performanceTest.lowestMap.set(i,r);const l=this.performanceTest.highestMap.get(i),f=e.get(i);l!==void 0&&f!==void 0&&f>l&&this.performanceTest.highestMap.set(i,f);const E=this.performanceTest.avgMap.get(i),h=s.get(i);E!==void 0&&h!==void 0&&this.performanceTest.avgMap.set(i,E===0?h:(E+h)/2)}}}class $s{calculateDistances(t){for(let e=0;e<t.width;e++)for(let s=0;s<t.height;s++){const i=t.cells[t.getIndexFromCoords(e,s)];i.wall?i.dist=this.getMinDistance(e,s,t,!1,10):i.dist=this.getMinDistance(e,s,t,!0,3)}}calculateFoodDistances(t){for(let e=0;e<t.width;e++)for(let s=0;s<t.height;s++){const i=t.cells[t.getIndexFromCoords(e,s)];if(i.food.quantity>0){const o=Math.round(this.getMinDistance(e,s,t,!1,3,!0)*100);i.food.quantity=o,i.food.changed=!0}}}getMinDistance(t,e,s,i,o,r=!1){let l=o;for(let f=-o;f<=o;f++)for(let E=-o;E<=o;E++){const h=s.cells[s.getIndexFromCoords(t+f,e+E)];if(h){if(r){if(h.food.quantity==0&&!h.wall){const O=U(f,E).mag();O<l&&(l=O)}}else if(h.wall&&i||!h.wall&&!i){const O=U(f,E).mag();O<l&&(l=O)}}}return l=Math.min(1,l/o)}}class ft{constructor(t,e){this.canvas=t,this.width=e.width,this.height=e.height,this.cellSize=e.cellSize}create(){return this.canvas.width=this.width,this.canvas.height=this.height,console.log(`Created canvas with size: ${this.width} x ${this.height}`),this.canvas.getContext("2d")}}function Vs(n){let t=Math.floor(n.width/n.cellSize),e=Math.floor(n.height/n.cellSize);t%2===0&&t--,e%2===0&&e--;const s=t*n.cellSize,i=e*n.cellSize;return console.log(`Calculate sizes:
${n.width==s?s:`${n.width} -> ${s}`} x ${n.height==i?i:`${n.height} -> ${i}`}`),[s,i]}class Us{constructor(t){this.quantity=t,this.changed=!0}draw(t,e,s){t.clearRect(e*x.SIZE,s*x.SIZE,x.SIZE,x.SIZE);const i=e*x.SIZE+x.SIZE/2,o=s*x.SIZE+x.SIZE/2;t.fillStyle=`hsl(120, 40%, 43%, ${this.quantity/100})`,F(t,i,o,x.SIZE/2,!0),this.changed=!1}pick(){if(this.changed=!0,this.quantity===0)return 0;let t=0;return this.quantity<x.PICK_AMOUNT?t=this.quantity:t=x.PICK_AMOUNT,this.quantity=Math.max(this.quantity-x.PICK_AMOUNT,0),t}}class Ys{constructor(t){this.intensity=t}getToHomeIntensity(){return this.intensity[0]}getToFoodIntensity(){return this.intensity[1]}getMixedColor(){if(this.intensity[0]===0&&this.intensity[1]===0)return[0,0,0];const[t,e,s]=qe.TO_HOME,[i,o,r]=qe.TO_FOOD,l=[this.intensity[0]*t,this.intensity[0]*e,this.intensity[0]*s];if(this.intensity[1]===0)return[Math.round(l[0]),Math.round(l[1]),Math.round(l[2])];const f=[this.intensity[1]*i,this.intensity[1]*o,this.intensity[1]*r];if(this.intensity[0]===0)return[Math.round(f[0]),Math.round(f[1]),Math.round(f[2])];let E=[l[0]+f[0],l[1]+f[1],l[2]+f[2]];return E=[Math.round(Math.min(E[0],255)),Math.round(Math.min(E[1],255)),Math.round(Math.min(E[2],255))],E}update(){this.intensity[0]>.01?this.intensity[0]-=We:this.intensity[0]=0,this.intensity[1]>.01?this.intensity[1]-=We:this.intensity[1]=0}}class Ve{constructor(){this.marker=new Ys([0,0]),this.food=new Us(0),this.wall=0,this.density=[0,0,0],this.colony=!1,this.dist=0,this.minIntensity=.1}update(){this.marker.update()}pick(){return this.food.pick()}drawWall(t,e,s,i){if(i){const o=Math.min(1,1-this.dist+.15);t.fillStyle=`rgb(${163*o}, ${163*o}, ${163*o})`}t.fillRect(e,s,1,1)}addDensity(t=!1,e=!1){!t&&!e?this.density[0]++:e?this.density[2]++:this.density[1]++}getIntensity(t){return Math.max(this.minIntensity,t===c.TO_FOOD?this.marker.getToFoodIntensity():t===c.TO_HOME?this.marker.getToHomeIntensity():Math.max(this.marker.getToFoodIntensity(),this.marker.getToHomeIntensity()))}}class Gs{constructor(t){this.width=t.width,this.height=t.height,this.cellSize=t.cellSize,this.cells=[];for(let e=0;e<this.width*this.height;e++)this.cells.push(new Ve);this.walls=new Uint8Array(this.width*this.height)}reset(){this.cells=[];for(let t=0;t<this.width*this.height;t++)this.cells.push(new Ve)}addBorderWalls(){const t=Pt.BORDER_SIZE;for(let e=0;e<this.width;e++)for(let s=0;s<t;s++){const i=this.cells[this.getIndexFromCoords(e,s)],o=this.cells[this.getIndexFromCoords(e,this.height-s-1)];i.wall=1,o.wall=1}for(let e=0;e<t;e++)for(let s=0;s<this.height;s++){const i=this.cells[this.getIndexFromCoords(e,s)],o=this.cells[this.getIndexFromCoords(this.width-e-1,s)];i.wall=1,o.wall=1}this.cells.forEach((e,s)=>this.walls[s]=e.wall)}generateWalls(t){for(let e=0;e<this.width;e++)for(let s=0;s<this.height;s++)this.cells[this.getIndexFromCoords(e,s)].wall=t[e][s]?1:0,this.walls[this.getIndexFromCoords(e,s)]=t[e][s]?1:0}generateFood(t){var e;for(let s=0;s<this.width;s++)for(let i=0;i<this.height;i++)this.cells[this.getIndexFromCoords(s,i)].food.quantity=(e=t[s][i])!=null?e:0,this.cells[this.getIndexFromCoords(s,i)].food.changed=!0}update(){for(const t of this.cells)this.updateCell(t)}updateCell(t){t.marker.update();for(let e=0;e<3;e++)t.density[e]>.01?t.density[e]*=.99:t.density[e]=0}addMarker(t,e,s,i){const o=this.cells[this.getIndexFromCoords(t,e)];s===et.TO_HOME?o.marker.intensity[0]=Math.min(1,Math.max(o.marker.getToHomeIntensity(),i)):s===et.TO_FOOD&&(o.marker.intensity[1]=Math.min(1,Math.max(o.marker.getToFoodIntensity(),i)))}addFood(t,e,s){const i=this.getIndexFromCoords(t,e);if(i>this.cells.length||i<0)return;const o=this.cells[i];o.food.quantity=Math.min(o.food.quantity+s,100),o.food.changed=!0}drawMarkers(t,e,s=!0){for(let i=0;i<e.data.length;i+=4){const o=this.cells[i/4];e.data[i+0]=o.marker.getToHomeIntensity()*255,e.data[i+1]=o.marker.getToFoodIntensity()*255,e.data[i+2]=0,e.data[i+3]=255,s&&this.updateCell(o)}t.putImageData(e,0,0)}drawFood(t){for(let e=0;e<this.cells.length;e++)if(this.cells[e].food.changed){const[s,i]=this.getCoordsFromIndex(e);this.cells[e].food.draw(t,s,i)}}drawWalls(t,e=!0){t.fillStyle="rgb(163, 163, 163)";for(let s=0;s<this.width;s++)for(let i=0;i<this.height;i++){const o=this.cells[this.getIndexFromCoords(s,i)];o.wall===1&&o.drawWall(t,s,i,e)}}drawDensity(t,e,s=!0,i=!1){for(let o=0;o<e.data.length;o+=4){const r=this.cells[o/4],l=r.density;if(i)e.data[o+0]=4*l[0],e.data[o+1]=4*l[1],e.data[o+2]=4*l[2],e.data[o+3]=255;else{const f=l[0]+l[1]+l[2];e.data[o+0]=4*f,e.data[o+1]=f,e.data[o+2]=f,e.data[o+3]=255}s&&this.updateCell(r)}t.putImageData(e,0,0)}isOnFood(t,e){return this.cells[this.getIndexFromCoords(t,e)].food.quantity>0}getIndexFromCoords(t,e){return t+e*this.width}getCoordsFromIndex(t){const e=t%this.width,s=Math.floor(t/this.width);return[e,s]}getCellCoords(t){return Math.floor(t/I.SIZE)}getCellFromCoords(t,e,s=!1){return s||(t=this.getCellCoords(t),e=this.getCellCoords(e)),this.cells[this.getIndexFromCoords(t,e)]}getCellFromCoordsSafe(t,e){const s=this.getCellCoords(t),i=this.getCellCoords(e);return this.checkCoords(s,i)?this.getCellFromCoords(s,i,!0):null}getCellFromIndex(t){return this.cells[t]}getWallFromIndex(t){return this.walls[t]}checkCoords(t,e){return t>-1&&t<this.width&&e>-1&&e<this.height}rayCast(t,e,s,i){const o=Math.cos(s),r=Math.sin(s),l={x:Math.sqrt(1+r/o*(r/o)),y:Math.sqrt(1+o/r*(o/r))},f={x:t,y:e};let E=0;const h={x:0,y:0},O={x:0,y:0};o<0?(O.x=-1,h.x=(t-Math.round(f.x))*l.x):(O.x=1,h.x=(Math.round(f.x+1)-t)*l.x),r<0?(O.y=-1,h.y=(e-Math.round(f.y))*l.y):(O.y=1,h.y=(Math.round(f.y+1)-e)*l.y);const g={maxWidth:this.width*I.SIZE,maxHeight:this.height*I.SIZE};let w=!1,C=0;for(;!w&&C<i&&(h.x<h.y?(f.x+=O.x,C=h.x,h.x+=l.x):(f.y+=O.y,C=h.y,h.y+=l.y),!(f.x<0||f.x>=g.maxWidth||f.y<0||f.y>=g.maxHeight));){E=this.getIndexFromCoords(this.getCellCoords(f.x),this.getCellCoords(f.y));const K=this.getWallFromIndex(E);if(K){w=!0;const _t={x:h.x<h.y?1:0,y:h.y<h.x?1:0};return{cell:K,distance:C,normal:_t}}}return{cellIndex:E}}}function Ks(){return new Worker("/Ants_Simulation/assets/mapWorker.78d7ee7f.js",{type:"module"})}const rt=document.getElementById("canvas-container"),Xs=document.getElementById("camera-container"),js=document.getElementById("btn-fullscreen"),Qs=document.getElementById("btn-pan"),Js=document.getElementById("btn-zoom-in"),ti=document.getElementById("btn-zoom-out"),ei=document.getElementById("canvas"),gs=document.getElementById("canvas-markers"),Is=document.getElementById("canvas-food"),si=document.getElementById("canvas-colony"),Es=document.getElementById("canvas-walls"),Lt=document.getElementById("canvas-edit"),kt=document.getElementById("canvas-edit-preview"),Ue=document.getElementById("antIcon"),bt=document.getElementById("btn-ant-panel"),ee=document.getElementById("antPanel"),Ye=document.querySelector("[data-id]"),Ge=document.querySelector("[data-pos]"),le=document.querySelector("[data-vel]"),Ke=document.querySelector("[data-state]"),ce=document.querySelector("[data-lifespan-preview]"),Xe=document.querySelector("[data-lifespan]"),je=document.querySelector("[data-marker-preview]"),Qe=document.querySelector("[data-marker]"),Ie=document.getElementById("btn-track"),ii=document.getElementById("btn-remove"),Ee=document.getElementById("btn-cell-panel"),ps=document.getElementById("cellPanel"),Je=document.querySelector("[data-cell-preview]"),ts=document.querySelector("[data-coords]"),es=document.querySelector("[data-intensity-home]"),ss=document.querySelector("[data-intensity-food]"),is=document.querySelector("[data-cell-food]"),ns=document.querySelector("[data-density]"),os=document.querySelector("[data-dist]"),as=document.querySelector("[data-colony]"),pe=document.getElementById("btn-colony-panel"),Os=document.getElementById("colonyPanel"),rs=document.querySelector("[data-colony-preview]"),ls=document.querySelector("[data-colony-pop]"),cs=document.querySelector("[data-colony-food]"),hs=document.querySelector("[data-colony-total-food]"),ds=document.querySelector("[data-pause]"),Ts=document.getElementById("btn-play"),Cs=document.getElementById("btn-pause"),Re=document.getElementById("btn-edit-mode"),As=document.getElementById("editPanel"),fs=document.querySelector("[data-brush-preview]"),ni=document.querySelector("[data-brush-size]"),oi=document.getElementById("brush-size-minus"),ai=document.getElementById("brush-size-plus"),ct=document.getElementById("brushSizeInput"),se=document.getElementById("btn-wall-brush"),Fe=document.getElementById("btn-food-brush"),ri=document.getElementById("btn-save"),li=document.getElementById("btn-clear"),ci=document.getElementById("btn-controls"),hi=document.getElementById("btn-close-controls"),ie=document.getElementById("controlsPanel"),di=document.querySelector("[data-performance-display]"),ut=document.getElementById("mapPanel"),fi=document.getElementById("btn-close-map"),ui=document.getElementById("btn-cancel-map"),mi=document.getElementById("btn-map-panel"),yi=document.getElementById("btn-generate-seed"),gi=document.getElementById("btn-generate-save-map"),Ii=document.getElementById("map-form"),wt=document.getElementById("map-seed"),vt=document.getElementById("btn-ants-layer"),Ht=document.getElementById("btn-density-layer"),zt=document.getElementById("btn-density-all-layer"),Zt=document.getElementById("btn-markers-layer"),Dt=document.getElementById("confirmDialog"),Ei=document.getElementById("btn-cancel"),pi=document.getElementById("btn-confirm"),Oi=document.getElementById("btn-simulation-panel"),St=document.getElementById("simulationTypeDialog"),Oe=document.getElementById("btn-simulation-advanced"),Te=document.getElementById("btn-simulation-simple"),Ti=document.getElementById("btn-close-simulation-type-dialog"),Ms=new Ks;Ms.onmessage=n=>{var t;if(console.log(`Worker said : ${n.data.action}`),n.data.action=="GENERATE_PARTIAL"&&D&&(D.clearRect(0,0,y.width,y.height),y.generateWalls(n.data.map),y.drawWalls(D,!1)),n.data.action=="GENERATE"){const e=n.data.seed,s=new URL(window.location.href);e&&(s.searchParams.set("seed",e),window.history.pushState({path:s.href},"",s.href)),wt.value=(t=new URL(window.location.href).searchParams.get("seed"))!=null?t:"",D&&Bt&&(D.clearRect(0,0,y.width,y.height),y.generateWalls(n.data.map),console.log("calculate"),_e.calculateDistances(y),console.log("draw"),y.drawWalls(D),y.generateFood(n.data.foodMap),_e.calculateFoodDistances(y)),Se=!1}};let L=!1,At=!0,W=!1,$=!1,Ce=!1,ht=!1,Mt=!1,N=!1,Ae=!1,Me=!1,V=!1,tt=!1,he=!1,Kt=!0,De=!1,Se=!1,Xt=!1,Nt=!1,q=!1,Y=!1,S=!1,Z=!1,b=!1,de=0;const M=new Ws([{mode:0,stats:[{name:"fps",title:"Frames per second"},{name:"ms",title:"Milliseconds to render a frame"}]},{mode:1,stats:[{name:"clear",title:"Milliseconds to clear the screen"},{name:"grid",title:"Milliseconds to draw markers/density and update cells"},{name:"food",title:"Milliseconds to draw food"},{name:"ants",title:"Milliseconds to draw and update ants"},{name:"panels",title:"Milliseconds to update info panels"},{name:"all",title:"Milliseconds needed for main loop"}]}]),[Ci,fe,Ai,Mi,Si,wi,xi,_i]=M.createPerformanceDisplay(di),P=rt.getBoundingClientRect().top;let ne=0,oe=0,d=1,Tt=!1,jt=!1,ue=0;const j={x:0,y:0},p={x:0,y:0},u={x:0,y:0};let $t=0,we=!1,G=5;const Ss=new URL(window.location.href),me=Ss.searchParams.get("seed");let Rt=me!=null?me:"";wt.value=Rt;const ye=Ss.searchParams.has("perf-test"),Ne=ye!=null?ye:!1;let ws=window.innerWidth,xs=window.innerHeight;window.addEventListener("resize",()=>{ws=window.innerWidth,xs=window.innerHeight;const n={x:0,y:0};n.x=window.innerWidth/2/d-p.x,n.y=window.innerHeight/2/d-p.y,p.x=window.innerWidth/2/d-n.x,p.y=window.innerHeight/2/d-n.y,u.x=(window.innerWidth/2-window.innerWidth/2)/d-n.x,u.y=(window.innerHeight/2-window.innerHeight/2)/d-n.y,u.x=u.x<0?Math.abs(u.x):u.x*-1,u.y=u.y<0?Math.abs(u.y):u.y*-1,mt()});const[v,H]=Vs({width:Be.WIDTH,height:Be.HEIGHT,cellSize:I.SIZE}),Pi=new ft(gs,{width:v/I.SIZE,height:H/I.SIZE,cellSize:1});gs.style.transform=`scale(${I.SIZE})`;const k=Pi.create(),Ri=new ft(Is,{width:v/(I.SIZE/x.SIZE),height:H/(I.SIZE/x.SIZE),cellSize:I.SIZE/x.SIZE});Is.style.transform=`scale(${I.SIZE/x.SIZE})`;const Bt=Ri.create(),Fi=new ft(ei,{width:v,height:H,cellSize:I.SIZE}),Ct=Fi.create(),Di=new ys({width:a.IMG_WIDTH,height:a.IMG_HEIGHT}),Ni=new ys({width:a.FOOD_SIZE,height:a.FOOD_SIZE}),Li=new ft(si,{width:v,height:H,cellSize:I.SIZE}),xe=Li.create(),ki=new ft(Es,{width:v/I.SIZE,height:H/I.SIZE,cellSize:1});Es.style.transform=`scale(${I.SIZE})`;const D=ki.create(),bi=new ft(Lt,{width:v/I.SIZE,height:H/I.SIZE,cellSize:1});Lt.style.transform=`scale(${I.SIZE})`;const B=bi.create(),vi=new ft(kt,{width:v/I.SIZE,height:H/I.SIZE,cellSize:1});kt.style.transform=`scale(${I.SIZE})`;const Ft=vi.create(),y=new Gs({width:v/I.SIZE,height:H/I.SIZE,cellSize:1}),_e=new $s;lt({action:"SETUP",mapGeneratorOptions:{width:y.width,height:y.height,fillRatio:Pt.FILL_RATIO,fillRatioFood:Pt.FILL_RATIO_FOOD,threshold:Pt.THRESHOLD,thresholdFood:Pt.THRESHOLD_FOOD}},!0);const Qt=k==null?void 0:k.createImageData(y.width,y.height),Vt=k==null?void 0:k.createImageData(y.width,y.height),m=new qs({id:1,pos:{x:v/2,y:H/2}});window.addEventListener("keydown",n=>{if(!De)switch(n.code){case"Space":n.preventDefault(),qt();break;case"KeyM":Ds();break;case"KeyN":ke();break;case"KeyA":be();break;case"KeyD":Zi();break;case"KeyT":Ls();break;case"KeyC":N?Fs():ve();break;case"KeyR":if(n.ctrlKey)break;L=!0,qt(),Z=T(Z,Dt);break;case"Delete":ks();break;case"Insert":for(let t=0;t<(n.ctrlKey?10:n.shiftKey?100:1);t++)qi();break;case"KeyF":M.changeMode();break;case"KeyQ":N&&_s();break;case"KeyE":if(Z){xt(),lt({action:"GENERATE",seed:dt(!1)}),Z=T(Z,Dt);break}N?Ps():Pe();break;case"KeyS":N&&Rs();break;case"ArrowUp":Ut(0,n.ctrlKey?at*5:at,!!n.shiftKey);break;case"ArrowDown":Ut(0,n.ctrlKey?-at*5:-at,!!n.shiftKey);break;case"ArrowLeft":if(Mt&&m.selectedAnt){const t=m.selectedAnt.id,e=m.ants.findIndex(i=>i.id===t),s=m.ants.length;m.selectedAnt=m.ants[e-1>=0?e-1:s-1]}else Ut(n.ctrlKey?at*5:at,0,!!n.shiftKey);break;case"ArrowRight":if(Mt&&m.selectedAnt){const t=m.selectedAnt.id,e=m.ants.findIndex(i=>i.id===t),s=m.ants.length;m.selectedAnt=m.ants[e+1<s?e+1:0]}else Ut(n.ctrlKey?-at*5:-at,0,!!n.shiftKey);break;case"Minus":te(!1);break;case"Equal":te(!0);break;case"Comma":Jt(-st.STEP);break;case"Period":Jt(st.STEP);break;case"Escape":Z&&(Z=T(Z,Dt)),Y&&(Y=T(Y,ie)),S&&(S=T(S,ut)),N&&Pe();break}});rt.addEventListener("mousemove",n=>{ne=n.pageX,oe=n.pageY-P});rt.addEventListener("click",()=>{if(jt){jt=!1;return}Bi(),ht&&Ns()});rt.addEventListener("contextmenu",n=>{if(n.preventDefault(),N)return;const t=U(Math.floor((ne/d-p.x)/I.SIZE),Math.floor((oe/d-p.y)/I.SIZE));ht&&console.log(`Placed food at: ${t.x}:${t.y}`),y.addFood(t.x,t.y,10)});rt.addEventListener("wheel",n=>{Gi(n)});js.addEventListener("click",()=>{ve()});Js.addEventListener("click",()=>{te(!0)});ti.addEventListener("click",()=>{te(!1)});Ie.addEventListener("click",()=>{Ls()});ii.addEventListener("click",()=>{ks()});Ts.addEventListener("click",()=>{qt()});Cs.addEventListener("click",()=>{qt()});oi.addEventListener("click",()=>{Jt(-st.STEP)});ai.addEventListener("click",()=>{Jt(st.STEP)});pe.addEventListener("click",()=>{Xt=T(Xt,Os,pe)});Xt=T(Xt,Os,pe);Ee.addEventListener("click",()=>{Nt=T(Nt,ps,Ee)});bt.addEventListener("click",()=>{q=T(q,ee,bt)});ci.addEventListener("click",()=>{Y=T(Y,ie),S=!0,S=T(S,ut)});hi.addEventListener("click",()=>{Y=!0,Y=T(Y,ie)});mi.addEventListener("click",()=>{S=T(S,ut),Y=!0,Y=T(Y,ie)});fi.addEventListener("click",()=>{S=!0,S=T(S,ut)});ui.addEventListener("click",()=>{S=!0,S=T(S,ut)});yi.addEventListener("click",()=>{const n=Math.random().toString(36).slice(2,7);console.log(n),wt.value=n});pi.addEventListener("click",()=>{xt(),lt({action:"GENERATE",seed:dt(!1)}),Z=T(Z,Dt)});Ei.addEventListener("click",()=>{Z=T(Z,Dt)});vt.addEventListener("click",()=>{A(m.isDrawingAnts,vt),be()});Ht.addEventListener("click",()=>{A(m.isDrawingAnts,Ht),ke(!0,!1)});zt.addEventListener("click",()=>{A(m.isDrawingAnts,zt),ke(!1,!0)});Zt.addEventListener("click",()=>{A(m.isDrawingAnts,Zt),Ds()});wt.addEventListener("focus",()=>{De=!0});wt.addEventListener("blur",()=>{De=!1});Ii.addEventListener("submit",n=>{console.log("submit",n),Rt=wt.value,console.log(Rt),S=!0,S=T(S,ut),D&&Rt&&(xt(),lt({action:"GENERATE",seed:dt(!1,Rt)})),n.preventDefault()});gi.addEventListener("click",()=>{S=!0,S=T(S,ut),D&&(xt(),lt({action:"GENERATE",seed:dt(!1)}))});Re.addEventListener("click",()=>{Pe()});function Pe(){N=T(N,As,Re),N?(Lt.style.display="block",kt.style.display="block"):(Lt.style.display="none",kt.style.display="none")}se.addEventListener("click",()=>{_s()});function _s(){V&&!tt||(V=A(V,se),V&&(tt=!0,tt=A(V,Fe)))}Fe.addEventListener("click",()=>{Ps()});function Ps(){tt&&!V||(tt=A(tt,Fe),tt&&(V=!0,V=A(tt,se)))}ri.addEventListener("click",()=>{Rs()});li.addEventListener("click",()=>{Fs()});function Rs(){if(B&&D){const n=B.getImageData(0,0,y.width,y.height);D.clearRect(0,0,y.width,y.height);for(let t=0;t<n.data.length;t+=4){const e=y.cells[t/4],s=n.data[t+0],i=n.data[t+1],o=n.data[t+2],r=n.data[t+3];i<=160&&i>0&&i>s&&i>o?e.wall!==1?(e.food.quantity=Math.min(100,Math.round(100*(r/255))+e.food.quantity),e.food.changed=!0):e.wall=1:s>10&&i>10&&o>10&&s===i&&i===o?(e.wall=1,e.food.quantity=0,e.food.changed=!0):r>0&&s<5&&i<5&&o<5&&(e.food.quantity=0,e.food.changed=!0,e.wall=0)}y.addBorderWalls(),_e.calculateDistances(y),y.drawWalls(D),B.clearRect(0,0,y.width,y.height),N=T(N,As,Re),Lt.style.display="none",kt.style.display="none"}}function Fs(){B&&D&&B.clearRect(0,0,y.width,y.height)}ct.addEventListener("input",()=>{G=parseInt(ct.value),Le()});function Hi(){ct.min=st.MIN_SIZE.toString(),ct.max=st.MAX_SIZE.toString(),ct.step=st.STEP.toString(),ct.value=G.toString()}function Le(){fs.style.width=`${G}px`,fs.style.height=`${G}px`,ni.textContent=`${G} px`}function Jt(n){G=Math.min(st.MAX_SIZE,Math.max(st.MIN_SIZE,G+n)),ct.value=G.toString(),Le()}Hi();Le();V=A(V,se);zi();Yi();ve();window.requestAnimationFrame(bs);function zi(){if(!(k==null||Bt==null||Ct==null||xe==null||D==null||B==null||Ft==null)){if(Qt&&(y.drawMarkers(k,Qt),y.drawFood(Bt)),Ue){const n=new XMLSerializer().serializeToString(Ue),t=btoa(n),s="data:image/svg+xml;base64,"+t,i=new Image;i.src=s,i.onload=()=>{const o=Di.createInstance(l=>{l.drawImage(i,0,0)}),r=Ni.createInstance(l=>{const f=a.FOOD_SIZE/2;l.fillStyle="hsl(120, 40%, 43%)",F(l,f,f,a.FOOD_SIZE/2)});if(m.initialize(i,o,r,Ct,y),Ne){M.setMode(1),be();for(let l=0;l<ms.COLONY_ANTS-z.COLONY_STARTING_ANTS;l++)m.createAnt(!0)}}}m.drawColony(xe),lt({action:"GENERATE",setup:!0,seed:dt(!0)}),A(!1,vt),A(!W,Ht),A(!$,zt),A(!At,Zt)}}function qt(){Kt&&(m.isDrawingAnts=!0,Kt=!1),ds&&(L||Ne&&M.startPerformanceTest(),L=!L,m.isRunning=L,ds.style.display=L?"none":"block",Ts.style.display=L?"none":"flex",Cs.style.display=L?"flex":"none")}function Ds(){At=A(At,Zt),At&&(W=!1,$=!1,Ce=!1,A(!0,Ht),A(!0,zt))}function ke(n,t){!n&&!t?($=!!W,W=!($||Ce),Ce=!W&&$):n?(W=!W,$=!1):t&&($=!$,W=!1),(W||$)&&(At=!1,A(!0,Zt)),A(!W,Ht),A(!$,zt)}function Zi(){ht=!ht,m.isDebugMode=ht,Ns(),ht&&(Nt=!1),Nt=T(Nt,ps,Ee)}function Ns(){m.toggleAntDebug()}function Ls(){m.selectedAnt!=null&&(Mt=!Mt,Mt&&(d=3),Ie.classList.toggle("border-green-500"),Ie.classList.toggle("border-red-500"))}function ge(){he=!he,he?document.body.classList.add("cursor-grabbing"):document.body.classList.remove("cursor-grabbing"),Qs.classList.toggle("bg-neutral-600")}function be(){if(Kt){Kt=!1,m.isDrawingAnts=!1,A(!m.isDrawingAnts,vt);return}m.isDrawingAnts=A(m.isDrawingAnts,vt)}function lt(n,t=!1){(!Se||t)&&(Se=!t,Ms.postMessage(n))}function xt(){y.reset(),m.reset(y),m.selectedAnt||(q=!0,q=T(q,ee,bt))}Oi.addEventListener("click",()=>{b=T(b,St)});Oe.addEventListener("click",()=>{if(m.simulationType===Q.ADVANCED){b=T(b,St);return}m.simulationType=Q.ADVANCED,A(!1,Oe),A(!0,Te),b=T(b,St),xt(),lt({action:"GENERATE",seed:dt(!0)})});Te.addEventListener("click",()=>{if(m.simulationType===Q.SIMPLE){b=T(b,St);return}m.simulationType=Q.SIMPLE,A(!0,Oe),A(!1,Te),b=T(b,St),xt(),lt({action:"GENERATE",seed:dt(!0)})});Ti.addEventListener("click",()=>{b=!0,b=T(b,St)});function Bi(){const n=U(ne/d-p.x,oe/d-p.y);m.selectAnt(n),m.selectedAnt?q=!1:q=!0,q=T(q,ee,bt)}function ks(){m.removeAnt()&&(q=!0,q=T(q,ee,bt))}function qi(){m.createAnt(!0)}function Wi(){const n=m.selectedAnt;if(!n||!Ye||!Ge||!le||!Ke||!ce||!Xe||!je||!Qe)return;Ye.textContent=n.id.toString(),Ge.textContent=`${n.pos.x.toFixed(2)} : ${n.pos.y.toFixed(2)}`,n instanceof Yt?le.textContent=`${n.vel.x.toFixed(2)} : ${n.vel.y.toFixed(2)}`:le.textContent=`${n.direction.vector.x.toFixed(2)} : ${n.direction.vector.y.toFixed(2)}`;let t="";switch(n.state){case c.TO_HOME:t="To Home";break;case c.TO_FOOD:t="To Food";break;case c.REFILL:t="Refill";break}Ke.textContent=t;const e=a.AUTONOMY_REFILL/n.maxAutonomy,s=n.internalClock/n.maxAutonomy;if(ce.style.setProperty("--left",`${e*100}%`),ce.style.setProperty("--width",`${s*100}%`),Xe.textContent=`${n.internalClock.toFixed(2)} | ${n.maxAutonomy.toFixed(2)}`,n instanceof Gt){const i=a.MARKER_DEFAULT_INTENSITY*Math.exp(-.15*n.markerIntensityClock);je.style.setProperty("--width",`${i/1*100}%`),Qe.textContent=`${i.toFixed(2)} | ${1} | ${n.markerIntensityClock.toFixed(2)}`}}function $i(n,t){const e=y.getCellFromCoordsSafe(n,t);if(!e||!es||!ss||!is||!ns||!Je||!os||!as||!ts)return;ts.textContent=`${n.toFixed(0)}-${t.toFixed(0)}`,es.textContent=e.marker.getToHomeIntensity().toFixed(2),ss.textContent=e.marker.getToFoodIntensity().toFixed(2),is.textContent=e.food.quantity.toString(),ns.textContent=(e.density[0]+e.density[1]+e.density[2]).toFixed(2);const s=e.marker.getMixedColor();Je.style.backgroundColor=`rgb(${s[0]}, ${s[1]}, ${s[2]})`,os.textContent=e.dist.toFixed(2),as.textContent=e.colony?"Yes":"No"}function Vi(){if(!m||!ls||!cs||!hs||!rs)return;ls.textContent=`${m.ants.length} | ${m.totalAnts}`,cs.textContent=m.food.toFixed(2),hs.textContent=m.totalFood.toFixed(2);const n=m.colonyColor;rs.style.backgroundColor=`rgb(${n[0]}, ${n[1]}, ${n[2]})`}function Ui(){const n=M.update();Ci.textContent=`${Math.round(n.get("fps")*100)/100} fps`,fe.textContent=`${Math.round(n.get("ms")*100)/100} ms`,Ai.textContent=`${Math.round(n.get("clear")*100)/100} ms`,Mi.textContent=`${Math.round(n.get("grid")*100)/100} ms`,Si.textContent=`${Math.round(n.get("food")*100)/100} ms`,wi.textContent=`${Math.round(n.get("ants")*100)/100} ms`,xi.textContent=`${Math.round(n.get("panels")*100)/100} ms`,_i.textContent=`${Math.round(n.get("all")*100)/100} ms`,n.get("ms")>16.7?fe.classList.add("text-red-500"):fe.classList.remove("text-red-500")}function Yi(){rt.addEventListener("mousedown",n=>{if(clearTimeout(ue),n.buttons==re&&N)Me=!0;else if(n.buttons==re)return;if(n.buttons==Zs)Tt=!0,jt=!1,ge(),j.x=n.clientX/d-p.x,j.y=(n.clientY-P)/d-p.y;else{if(N){Ae=!0;return}Tt=!1,ue=setTimeout(()=>{Tt=!0,jt=!0,ge(),j.x=n.clientX/d-p.x,j.y=(n.clientY-P)/d-p.y},100)}}),rt.addEventListener("mousemove",n=>{!Tt||n.buttons==re||Ki(n)}),rt.addEventListener("mouseup",()=>{clearTimeout(ue),Ae=!1,Me=!1,Tt&&(Tt=!1,ge())})}function Gi(n){const t={x:0,y:0};t.x=n.clientX/d-p.x,t.y=(n.clientY-P)/d-p.y,d*=.999**n.deltaY,d=Math.min(Math.max(.15,d),16),p.x=n.clientX/d-t.x,p.y=(n.clientY-P)/d-t.y,u.x=(n.clientX-window.innerWidth/2)/d-t.x,u.y=(n.clientY-P-window.innerHeight/2)/d-t.y,u.x=u.x<0?Math.abs(u.x):u.x*-1,u.y=u.y<0?Math.abs(u.y):u.y*-1,mt()}function Ki(n){p.x=n.clientX/d-j.x,p.y=(n.clientY-P)/d-j.y;const t={x:window.innerWidth/2-v/2,y:window.innerHeight/2-H/2};(n.clientX-t.x)/d-j.x,(n.clientY-P-t.y)/d-j.y,n.clientX/d-p.x,(n.clientY-P)/d-p.y,u.x=(n.clientX-window.innerWidth/2)/d-j.x,u.y=(n.clientY-P-window.innerHeight/2)/d-j.y,u.x=u.x<0?Math.abs(u.x):u.x*-1,u.y=u.y<0?Math.abs(u.y):u.y*-1,mt()}function Ut(n,t,e=!1){e&&(p.x=Math.round(p.x/I.SIZE)*I.SIZE,p.y=Math.round(p.y/I.SIZE)*I.SIZE,u.x=Math.round(u.x/I.SIZE)*I.SIZE,u.y=Math.round(u.y/I.SIZE)*I.SIZE),p.x+=n,p.y+=t,u.x-=n,u.y-=t,mt()}function te(n){const t={x:0,y:0};t.x=window.innerWidth/2/d-p.x,t.y=(window.innerHeight-P)/2/d-p.y,d*=.999**(n?-100:100),d=Math.min(Math.max(.15,d),16),p.x=window.innerWidth/2/d-t.x,p.y=(window.innerHeight-P)/2/d-t.y,u.x=(window.innerWidth/2-window.innerWidth/2)/d-t.x,u.y=((window.innerHeight-P)/2-window.innerHeight/2)/d-t.y,u.x=u.x<0?Math.abs(u.x):u.x*-1,u.y=u.y<0?Math.abs(u.y):u.y*-1,mt()}function ve(){const n={x:window.innerWidth/2-v/2,y:(window.innerHeight-P)/2-H/2};d=1,p.x=n.x,p.y=n.y,u.x=v/2,u.y=H/2,mt()}function Xi(n,t){const e={x:window.innerWidth/2/d-n,y:window.innerHeight/2/d-t};p.x=e.x,p.y=e.y,u.x=window.innerWidth/2/d-e.x,u.y=window.innerHeight/2/d-e.y,mt()}function mt(){Xs.style.transform=`scale(${d}) translate(${p.x}px, ${p.y}px)`,we=!0}let us=null;function bs(n){if(k==null||Bt==null||Ct==null||xe==null||D==null||B==null||Ft==null)return;window.requestAnimationFrame(bs),Ne&&M.isPerfTest&&!us&&(us=performance.now(),setTimeout(()=>{M.endPerformanceTest(),qt()},ms.TEST_DURATION)),M.startMeasurement("all");const t=(n-de)/1e3;$t+=t;const e=(we||L)&&$t>$e/d||$t>$e*10/d;M.isMeasuring&&(M.setPerformance("fps",1/t),M.setPerformance("ms",n-de)),M.startMeasurement("clear"),e&&Ct.clearRect(0,0,v,H),k.clearRect(0,0,y.width,y.height),M.endMeasurement("clear"),M.startMeasurement("grid"),At&&Qt?y.drawMarkers(k,Qt,L):W&&Vt?y.drawDensity(k,Vt,L):$&&Vt?y.drawDensity(k,Vt,L,!0):L&&y.update(),M.endMeasurement("grid"),M.startMeasurement("food"),y.drawFood(Bt),M.endMeasurement("food");const s=U(ne/d-p.x,oe/d-p.y);if(N){Ft.clearRect(0,0,y.width,y.height),Ft.fillStyle="grey";const i=y.getCellCoords(s.x),o=y.getCellCoords(s.y);F(Ft,i,o,G),Me?(B.fillStyle="black",F(B,i,o,G)):Ae&&(V?B.fillStyle="rgb(163, 163, 163)":tt&&(B.fillStyle="rgb(66, 153, 66, 0.25)"),F(B,i,o,G))}m.updateColony(t),M.startMeasurement("ants"),e?m.updateAndDrawAnts(y,t):m.updateAndDrawAnts(y,t,!1),M.endMeasurement("ants"),M.startMeasurement("panels"),Wi(),Mt&&m.selectedAnt&&Xi(m.selectedAnt.pos.x,m.selectedAnt.pos.y),ht&&e&&(Ct.fillStyle="red",F(Ct,s.x,s.y,4),$i(s.x,s.y)),Vi(),M.endMeasurement("panels"),M.isMeasuring&&(M.endMeasurement("all"),Ui()),e&&(we=!1,$t=0),de=n}
