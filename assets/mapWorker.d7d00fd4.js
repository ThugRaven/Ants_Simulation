var ot=Object.defineProperty;var et=(v,O,I)=>O in v?ot(v,O,{enumerable:!0,configurable:!0,writable:!0,value:I}):v[O]=I;var M=(v,O,I)=>(et(v,typeof O!="symbol"?O+"":O,I),I);(function(){"use strict";var v=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},O={exports:{}};(function(p){(function(a,e,s){function c(t){var n=this,f=i();n.next=function(){var o=2091639*n.s0+n.c*23283064365386963e-26;return n.s0=n.s1,n.s1=n.s2,n.s2=o-(n.c=o|0)},n.c=1,n.s0=f(" "),n.s1=f(" "),n.s2=f(" "),n.s0-=f(t),n.s0<0&&(n.s0+=1),n.s1-=f(t),n.s1<0&&(n.s1+=1),n.s2-=f(t),n.s2<0&&(n.s2+=1),f=null}function l(t,n){return n.c=t.c,n.s0=t.s0,n.s1=t.s1,n.s2=t.s2,n}function r(t,n){var f=new c(t),o=n&&n.state,h=f.next;return h.int32=function(){return f.next()*4294967296|0},h.double=function(){return h()+(h()*2097152|0)*11102230246251565e-32},h.quick=h,o&&(typeof o=="object"&&l(o,f),h.state=function(){return l(f,{})}),h}function i(){var t=4022871197,n=function(f){f=String(f);for(var o=0;o<f.length;o++){t+=f.charCodeAt(o);var h=.02519603282416938*t;t=h>>>0,h-=t,h*=t,t=h>>>0,h-=t,t+=h*4294967296}return(t>>>0)*23283064365386963e-26};return n}e&&e.exports?e.exports=r:s&&s.amd?s(function(){return r}):this.alea=r})(v,p,!1)})(O);var I={exports:{}};(function(p){(function(a,e,s){function c(i){var t=this,n="";t.x=0,t.y=0,t.z=0,t.w=0,t.next=function(){var o=t.x^t.x<<11;return t.x=t.y,t.y=t.z,t.z=t.w,t.w^=t.w>>>19^o^o>>>8},i===(i|0)?t.x=i:n+=i;for(var f=0;f<n.length+64;f++)t.x^=n.charCodeAt(f)|0,t.next()}function l(i,t){return t.x=i.x,t.y=i.y,t.z=i.z,t.w=i.w,t}function r(i,t){var n=new c(i),f=t&&t.state,o=function(){return(n.next()>>>0)/4294967296};return o.double=function(){do var h=n.next()>>>11,u=(n.next()>>>0)/4294967296,d=(h+u)/(1<<21);while(d===0);return d},o.int32=n.next,o.quick=o,f&&(typeof f=="object"&&l(f,n),o.state=function(){return l(n,{})}),o}e&&e.exports?e.exports=r:s&&s.amd?s(function(){return r}):this.xor128=r})(v,p,!1)})(I);var G={exports:{}};(function(p){(function(a,e,s){function c(i){var t=this,n="";t.next=function(){var o=t.x^t.x>>>2;return t.x=t.y,t.y=t.z,t.z=t.w,t.w=t.v,(t.d=t.d+362437|0)+(t.v=t.v^t.v<<4^(o^o<<1))|0},t.x=0,t.y=0,t.z=0,t.w=0,t.v=0,i===(i|0)?t.x=i:n+=i;for(var f=0;f<n.length+64;f++)t.x^=n.charCodeAt(f)|0,f==n.length&&(t.d=t.x<<10^t.x>>>4),t.next()}function l(i,t){return t.x=i.x,t.y=i.y,t.z=i.z,t.w=i.w,t.v=i.v,t.d=i.d,t}function r(i,t){var n=new c(i),f=t&&t.state,o=function(){return(n.next()>>>0)/4294967296};return o.double=function(){do var h=n.next()>>>11,u=(n.next()>>>0)/4294967296,d=(h+u)/(1<<21);while(d===0);return d},o.int32=n.next,o.quick=o,f&&(typeof f=="object"&&l(f,n),o.state=function(){return l(n,{})}),o}e&&e.exports?e.exports=r:s&&s.amd?s(function(){return r}):this.xorwow=r})(v,p,!1)})(G);var $={exports:{}};(function(p){(function(a,e,s){function c(i){var t=this;t.next=function(){var f=t.x,o=t.i,h,u;return h=f[o],h^=h>>>7,u=h^h<<24,h=f[o+1&7],u^=h^h>>>10,h=f[o+3&7],u^=h^h>>>3,h=f[o+4&7],u^=h^h<<7,h=f[o+7&7],h=h^h<<13,u^=h^h<<9,f[o]=u,t.i=o+1&7,u};function n(f,o){var h,u=[];if(o===(o|0))u[0]=o;else for(o=""+o,h=0;h<o.length;++h)u[h&7]=u[h&7]<<15^o.charCodeAt(h)+u[h+1&7]<<13;for(;u.length<8;)u.push(0);for(h=0;h<8&&u[h]===0;++h);for(h==8&&(u[7]=-1),f.x=u,f.i=0,h=256;h>0;--h)f.next()}n(t,i)}function l(i,t){return t.x=i.x.slice(),t.i=i.i,t}function r(i,t){i==null&&(i=+new Date);var n=new c(i),f=t&&t.state,o=function(){return(n.next()>>>0)/4294967296};return o.double=function(){do var h=n.next()>>>11,u=(n.next()>>>0)/4294967296,d=(h+u)/(1<<21);while(d===0);return d},o.int32=n.next,o.quick=o,f&&(f.x&&l(f,n),o.state=function(){return l(n,{})}),o}e&&e.exports?e.exports=r:s&&s.amd?s(function(){return r}):this.xorshift7=r})(v,p,!1)})($);var P={exports:{}};(function(p){(function(a,e,s){function c(i){var t=this;t.next=function(){var f=t.w,o=t.X,h=t.i,u,d;return t.w=f=f+1640531527|0,d=o[h+34&127],u=o[h=h+1&127],d^=d<<13,u^=u<<17,d^=d>>>15,u^=u>>>12,d=o[h]=d^u,t.i=h,d+(f^f>>>16)|0};function n(f,o){var h,u,d,y,F,A=[],D=128;for(o===(o|0)?(u=o,o=null):(o=o+"\0",u=0,D=Math.max(D,o.length)),d=0,y=-32;y<D;++y)o&&(u^=o.charCodeAt((y+32)%o.length)),y===0&&(F=u),u^=u<<10,u^=u>>>15,u^=u<<4,u^=u>>>13,y>=0&&(F=F+1640531527|0,h=A[y&127]^=u+F,d=h==0?d+1:0);for(d>=128&&(A[(o&&o.length||0)&127]=-1),d=127,y=4*128;y>0;--y)u=A[d+34&127],h=A[d=d+1&127],u^=u<<13,h^=h<<17,u^=u>>>15,h^=h>>>12,A[d]=u^h;f.w=F,f.X=A,f.i=d}n(t,i)}function l(i,t){return t.i=i.i,t.w=i.w,t.X=i.X.slice(),t}function r(i,t){i==null&&(i=+new Date);var n=new c(i),f=t&&t.state,o=function(){return(n.next()>>>0)/4294967296};return o.double=function(){do var h=n.next()>>>11,u=(n.next()>>>0)/4294967296,d=(h+u)/(1<<21);while(d===0);return d},o.int32=n.next,o.quick=o,f&&(f.X&&l(f,n),o.state=function(){return l(n,{})}),o}e&&e.exports?e.exports=r:s&&s.amd?s(function(){return r}):this.xor4096=r})(v,p,!1)})(P);var Z={exports:{}};(function(p){(function(a,e,s){function c(i){var t=this,n="";t.next=function(){var o=t.b,h=t.c,u=t.d,d=t.a;return o=o<<25^o>>>7^h,h=h-u|0,u=u<<24^u>>>8^d,d=d-o|0,t.b=o=o<<20^o>>>12^h,t.c=h=h-u|0,t.d=u<<16^h>>>16^d,t.a=d-o|0},t.a=0,t.b=0,t.c=-1640531527,t.d=1367130551,i===Math.floor(i)?(t.a=i/4294967296|0,t.b=i|0):n+=i;for(var f=0;f<n.length+20;f++)t.b^=n.charCodeAt(f)|0,t.next()}function l(i,t){return t.a=i.a,t.b=i.b,t.c=i.c,t.d=i.d,t}function r(i,t){var n=new c(i),f=t&&t.state,o=function(){return(n.next()>>>0)/4294967296};return o.double=function(){do var h=n.next()>>>11,u=(n.next()>>>0)/4294967296,d=(h+u)/(1<<21);while(d===0);return d},o.int32=n.next,o.quick=o,f&&(typeof f=="object"&&l(f,n),o.state=function(){return l(n,{})}),o}e&&e.exports?e.exports=r:s&&s.amd?s(function(){return r}):this.tychei=r})(v,p,!1)})(Z);var U={exports:{}};(function(p){(function(a,e,s){var c=256,l=6,r=52,i="random",t=s.pow(c,l),n=s.pow(2,r),f=n*2,o=c-1,h;function u(x,g,R){var w=[];g=g==!0?{entropy:!0}:g||{};var m=A(F(g.entropy?[x,N(e)]:x==null?D():x,3),w),b=new d(w),C=function(){for(var S=b.g(l),_=t,E=0;S<n;)S=(S+E)*c,_*=c,E=b.g(1);for(;S>=f;)S/=2,_/=2,E>>>=1;return(S+E)/_};return C.int32=function(){return b.g(4)|0},C.quick=function(){return b.g(4)/4294967296},C.double=C,A(N(b.S),e),(g.pass||R||function(S,_,E,L){return L&&(L.S&&y(L,b),S.state=function(){return y(b,{})}),E?(s[i]=S,_):S})(C,m,"global"in g?g.global:this==s,g.state)}function d(x){var g,R=x.length,w=this,m=0,b=w.i=w.j=0,C=w.S=[];for(R||(x=[R++]);m<c;)C[m]=m++;for(m=0;m<c;m++)C[m]=C[b=o&b+x[m%R]+(g=C[m])],C[b]=g;(w.g=function(S){for(var _,E=0,L=w.i,X=w.j,B=w.S;S--;)_=B[L=o&L+1],E=E*c+B[o&(B[L]=B[X=o&X+_])+(B[X]=_)];return w.i=L,w.j=X,E})(c)}function y(x,g){return g.i=x.i,g.j=x.j,g.S=x.S.slice(),g}function F(x,g){var R=[],w=typeof x,m;if(g&&w=="object")for(m in x)try{R.push(F(x[m],g-1))}catch{}return R.length?R:w=="string"?x:x+"\0"}function A(x,g){for(var R=x+"",w,m=0;m<R.length;)g[o&m]=o&(w^=g[o&m]*19)+R.charCodeAt(m++);return N(g)}function D(){try{var x;return h&&(x=h.randomBytes)?x=x(c):(x=new Uint8Array(c),(a.crypto||a.msCrypto).getRandomValues(x)),N(x)}catch{var g=a.navigator,R=g&&g.plugins;return[+new Date,a,R,a.screen,N(e)]}}function N(x){return String.fromCharCode.apply(0,x)}if(A(s.random(),e),p.exports){p.exports=u;try{h=require("crypto")}catch{}}else s["seed"+i]=u})(typeof self!="undefined"?self:v,[],Math)})(U);var k=O.exports,Y=I.exports,V=G.exports,J=$.exports,K=P.exports,Q=Z.exports,z=U.exports;z.alea=k,z.xor128=Y,z.xorwow=V,z.xorshift7=J,z.xor4096=K,z.tychei=Q;var j=z;const T={FILL_RATIO:.47,FILL_RATIO_FOOD:.37,THRESHOLD:50,THRESHOLD_FOOD:20,BORDER_SIZE:5},tt={COLONY_RADIUS:3,COLONY_STARTING_ANTS:1,COLONY_MAX_ANTS:5e3,COLONY_MAX_FOOD:3e5,ANT_CREATION_PERIOD:.15,ANT_COST:30,ANT_REFILL_FOOD_AMOUNT:.25};function W(p,a,e){return e()*(a-p)+p}class it{constructor(a){M(this,"width");M(this,"height");M(this,"map");M(this,"foodMap");M(this,"fillRatio");M(this,"fillRatioFood");M(this,"threshold");M(this,"thresholdFood");this.width=a.width,this.height=a.height,this.map=Array.from(Array(this.width),()=>new Array(this.height)),this.foodMap=Array.from(Array(this.width),()=>new Array(this.height)),this.fillRatio=a.fillRatio,this.fillRatioFood=a.fillRatioFood,this.threshold=a.threshold,this.thresholdFood=a.thresholdFood}initialize(a){this.width=a.width,this.height=a.height,this.map=Array.from(Array(this.width),()=>new Array(this.height)),this.foodMap=Array.from(Array(this.width),()=>new Array(this.height)),this.fillRatio=a.fillRatio,this.fillRatioFood=a.fillRatioFood,this.threshold=a.threshold,this.thresholdFood=a.thresholdFood}generateMap(a){if(console.log("Generate Map"),console.log(a),!a)return this.addBorderWalls(),{map:this.map,foodMap:this.foodMap};const e=j(a);this.map=this.randomFillMap(e,this.fillRatio,1),this.clearColonySpace();for(let c=0;c<20;c++)this.map=this.smoothMap(this.map,1);this.addBorderWalls();const s=this.processMap();for(let c=0;c<5;c++)this.map=this.smoothMap(this.map,1);return this.foodMap=this.generateFoodMap(a,s),{map:this.map,foodMap:this.foodMap}}generateMapSteps(a,e){console.log("Generate Map Steps");let s=0;const c=j(a);let l;const r=()=>{if(s==0&&(this.map=this.randomFillMap(c,this.fillRatio,1),e(this.map,this.foodMap,!1)),s==1&&(this.clearColonySpace(),e(this.map,this.foodMap,!1)),s==2)for(let i=0;i<20;i++)this.map=this.smoothMap(this.map,1),e(this.map,this.foodMap,!1);if(s==3&&(this.addBorderWalls(),e(this.map,this.foodMap,!1)),s==4&&(l=this.processMap(),e(this.map,this.foodMap,!1)),s==5)for(let i=0;i<5;i++)this.map=this.smoothMap(this.map,1),e(this.map,this.foodMap,!1);s==6&&(this.foodMap=this.generateFoodMap(a,l),e(this.map,this.foodMap,!0)),s!=7&&(s++,r())};r()}generateFoodMap(a,e){if(console.log("Generate Food Map"),console.log(a),!a)return this.foodMap;for(let r=0;r<this.foodMap.length;r++)for(let i=0;i<this.foodMap[r].length;i++)this.foodMap[r][i]=0;const s=j(a);this.randomFillRegions(s,.5,100,e);for(let r=0;r<5;r++)this.foodMap=this.smoothMap(this.foodMap,100,!0);this.foodMap=this.randomFillMap(s,this.fillRatioFood,100,this.foodMap);for(let r=0;r<20;r++)this.foodMap=this.smoothMap(this.foodMap,100,!1);const c=this.getRegions(this.foodMap,100);if(!c)return this.foodMap;const l=this.thresholdFood;for(const r of c)if(r.length<l)for(const i of r)this.foodMap[i.x][i.y]=0;return this.foodMap}randomFillMap(a,e,s,c){const l=c||Array.from(Array(this.width),()=>new Array(this.height));for(let r=0;r<this.width;r++)for(let i=0;i<this.height;i++){if(s===1&&(r>=0&&r<=T.BORDER_SIZE||r>=this.width-T.BORDER_SIZE&&r<=this.width||i>=0&&i<=T.BORDER_SIZE||i>=this.height-T.BORDER_SIZE&&i<=this.height)){l[r][i]=1;continue}s===100&&this.map[r][i]?l[r][i]=0:s===100&&l[r][i]===100?l[r][i]=100:l[r][i]=W(0,1,a)<e?s===100?100:1:0}return l}randomFillRegions(a,e,s,c){if(!!c){for(const l of c)if(l.roomSize<1e3)for(let r=0;r<l.tiles.length;r++){const i=l.tiles[r];this.foodMap[i.x][i.y]=W(0,1,a)<(l.roomSize<500?1:l.roomSize<1e3?.75:e)?s===100?100:1:0}}}smoothMap(a,e,s=!1){const c=[];for(let l=0;l<a.length;l++)c[l]=a[l].slice();for(let l=0;l<this.width;l++)for(let r=0;r<this.height;r++){const i=this.getNeighbourCount(a,l,r,s);i>4?s?this.map[l][r]||(c[l][r]=100):c[l][r]=e===100?100:1:i<4&&(c[l][r]=0)}return a=c,a}getNeighbourCount(a,e,s,c=!1){let l=0;for(let r=e-1;r<=e+1;r++)for(let i=s-1;i<=s+1;i++)r>=0&&r<this.width&&i>=0&&i<this.height?(r!==e||i!==s)&&(c?l+=this.map[r][i]==1||a[r][i]==100?1:0:l+=a[r][i]==1||a[r][i]==100?1:0):l++;return l}addBorderWalls(){const a=T.BORDER_SIZE;for(let e=0;e<this.width;e++)for(let s=0;s<a;s++)this.map[e][s]=1,this.map[e][this.height-s-1]=1;for(let e=0;e<a;e++)for(let s=0;s<this.height;s++)this.map[e][s]=1,this.map[this.width-e-1][s]=1}processMap(){const a=this.getRegions(this.map,1);if(!a)return;const e=this.threshold;for(const i of a)if(i.length<e)for(const t of i)this.map[t.x][t.y]=0;const s=this.getRegions(this.map,0);if(!s)return;const c=this.threshold,l=[];for(const i of s)if(i.length<c)for(const t of i)this.map[t.x][t.y]=1;else l.push(new q(i,this.map));const r=l;return l.sort((i,t)=>t.roomSize-i.roomSize),l[0].isMainRoom=!0,l[0].isAccessibleFromMainRoom=!0,this.connectClosestRooms(l),r}connectClosestRooms(a,e=!1){let s=[],c=[];if(e)for(const o of a)o.isAccessibleFromMainRoom?c.push(o):s.push(o);else s=a,c=a;let l=0,r={x:0,y:0},i={x:0,y:0},t=new q,n=new q,f=!1;for(const o of s)if(!(!e&&(f=!1,o.connectedRooms.length>0))){for(const h of c)if(!(o==h||o.isConnected(h)))for(let u=0;u<o.edgeTiles.length;u++)for(let d=0;d<h.edgeTiles.length;d++){const y=o.edgeTiles[u],F=h.edgeTiles[d],A=Math.pow(y.x-F.x,2)+Math.pow(y.y-F.y,2);(A<l||!f)&&(l=A,f=!0,r=y,i=F,t=o,n=h)}f&&!e&&this.createPassage(t,n,r,i)}f&&e&&(this.createPassage(t,n,r,i),this.connectClosestRooms(a,!0)),e||this.connectClosestRooms(a,!0)}createPassage(a,e,s,c){a.connectRooms(a,e);const l=this.getLine(s,c);for(const r of l)this.drawCircle(r,2)}drawCircle(a,e){for(let s=-e;s<=e;s++)for(let c=-e;c<=e;c++)if(s*s+c*c<=e*e){const l=a.x+s,r=a.y+c;this.isInMapRange(l,r)&&(this.map[l][r]=0)}}clearColonySpace(){this.drawCircle({x:Math.round(this.width/2),y:Math.round(this.height/2)},tt.COLONY_RADIUS*3)}getLine(a,e){const s=[];let c=a.x,l=a.y;const r=e.x-a.x,i=e.y-a.y;let t=!1,n=Math.sign(r),f=Math.sign(i),o=Math.abs(r),h=Math.abs(i);o<h&&(t=!0,o=Math.abs(i),h=Math.abs(r),n=Math.sign(i),f=Math.sign(r));let u=o/2;for(let d=0;d<o;d++)s.push({x:c,y:l}),t?l+=n:c+=n,u+=h,u>=o&&(t?c+=f:l+=f,u-=o);return s}getRegions(a,e){const s=[],c=Array.from(Array(this.width),()=>new Array(this.height).fill(0));for(let l=0;l<this.width;l++)for(let r=0;r<this.height;r++)if(c[l][r]===0&&a[l][r]===e){const i=this.getRegionCells(a,l,r,e===100);if(!i)return;s.push(i);for(const t of i)c[t.x][t.y]=e===100?100:1}return s}getRegionCells(a,e,s,c){const l=[],r=Array.from(Array(this.width),()=>new Array(this.height).fill(0)),i=a[e][s],t=[];for(t.push({x:e,y:s}),r[e][s]=c?100:1;t.length>0;){const n=t.shift();if(!n)return;l.push(n);for(let f=n.x-1;f<=n.x+1;f++)for(let o=n.y-1;o<=n.y+1;o++)this.isInMapRange(f,o)&&(o===n.y||f===n.x)&&r[f][o]===0&&a[f][o]===i&&(r[f][o]=c?100:1,t.push({x:f,y:o}))}return l}isInMapRange(a,e){return a>=0&&a<this.width&&e>=0&&e<this.height}}class q{constructor(a,e){M(this,"tiles");M(this,"edgeTiles");M(this,"connectedRooms");M(this,"roomSize");M(this,"isAccessibleFromMainRoom",!1);M(this,"isMainRoom",!1);if(this.tiles=a!=null?a:[],this.roomSize=this.tiles.length,this.connectedRooms=[],this.edgeTiles=[],!!e)for(const s of this.tiles)for(let c=s.x-1;c<=s.x+1;c++)for(let l=s.y-1;l<=s.y+1;l++)(c==s.x||l==s.y)&&e[c][l]==1&&this.edgeTiles.push(s)}setAccessibleFromMainRoom(){if(!this.isAccessibleFromMainRoom){this.isAccessibleFromMainRoom=!0;for(const a of this.connectedRooms)a.setAccessibleFromMainRoom()}}connectRooms(a,e){a.isAccessibleFromMainRoom?e.setAccessibleFromMainRoom():e.isAccessibleFromMainRoom&&a.setAccessibleFromMainRoom(),a.connectedRooms.push(e),e.connectedRooms.push(a)}isConnected(a){return this.connectedRooms.find(e=>e==a)}}const H=new it({width:0,height:0,fillRatio:T.FILL_RATIO,fillRatioFood:T.FILL_RATIO_FOOD,threshold:T.THRESHOLD,thresholdFood:T.THRESHOLD_FOOD});self.onmessage=p=>{if(console.log("MapWorker message",p.data),p.data.action==="SETUP"&&H.initialize(p.data.mapGeneratorOptions),p.data.action==="GENERATE")if(console.log("generate map"),p.data.setup){console.log("setup");const{map:a,foodMap:e}=H.generateMap(p.data.seed);postMessage({action:"GENERATE",map:a,foodMap:e,seed:p.data.seed})}else console.log("normal"),H.generateMapSteps(p.data.seed,(a,e,s)=>{postMessage({action:s?"GENERATE":"GENERATE_PARTIAL",map:a,foodMap:e,seed:p.data.seed})})}})();
