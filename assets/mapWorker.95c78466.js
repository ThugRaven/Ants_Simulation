(function(){"use strict";var T=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},j={exports:{}};(function(p){(function(a,o,s){function c(t){var n=this,f=i();n.next=function(){var e=2091639*n.s0+n.c*23283064365386963e-26;return n.s0=n.s1,n.s1=n.s2,n.s2=e-(n.c=e|0)},n.c=1,n.s0=f(" "),n.s1=f(" "),n.s2=f(" "),n.s0-=f(t),n.s0<0&&(n.s0+=1),n.s1-=f(t),n.s1<0&&(n.s1+=1),n.s2-=f(t),n.s2<0&&(n.s2+=1),f=null}function l(t,n){return n.c=t.c,n.s0=t.s0,n.s1=t.s1,n.s2=t.s2,n}function r(t,n){var f=new c(t),e=n&&n.state,h=f.next;return h.int32=function(){return f.next()*4294967296|0},h.double=function(){return h()+(h()*2097152|0)*11102230246251565e-32},h.quick=h,e&&(typeof e=="object"&&l(e,f),h.state=function(){return l(f,{})}),h}function i(){var t=4022871197,n=function(f){f=String(f);for(var e=0;e<f.length;e++){t+=f.charCodeAt(e);var h=.02519603282416938*t;t=h>>>0,h-=t,h*=t,t=h>>>0,h-=t,t+=h*4294967296}return(t>>>0)*23283064365386963e-26};return n}o&&o.exports?o.exports=r:s&&s.amd?s(function(){return r}):this.alea=r})(T,p,!1)})(j);var q={exports:{}};(function(p){(function(a,o,s){function c(i){var t=this,n="";t.x=0,t.y=0,t.z=0,t.w=0,t.next=function(){var e=t.x^t.x<<11;return t.x=t.y,t.y=t.z,t.z=t.w,t.w^=t.w>>>19^e^e>>>8},i===(i|0)?t.x=i:n+=i;for(var f=0;f<n.length+64;f++)t.x^=n.charCodeAt(f)|0,t.next()}function l(i,t){return t.x=i.x,t.y=i.y,t.z=i.z,t.w=i.w,t}function r(i,t){var n=new c(i),f=t&&t.state,e=function(){return(n.next()>>>0)/4294967296};return e.double=function(){do var h=n.next()>>>11,u=(n.next()>>>0)/4294967296,d=(h+u)/(1<<21);while(d===0);return d},e.int32=n.next,e.quick=e,f&&(typeof f=="object"&&l(f,n),e.state=function(){return l(n,{})}),e}o&&o.exports?o.exports=r:s&&s.amd?s(function(){return r}):this.xor128=r})(T,p,!1)})(q);var H={exports:{}};(function(p){(function(a,o,s){function c(i){var t=this,n="";t.next=function(){var e=t.x^t.x>>>2;return t.x=t.y,t.y=t.z,t.z=t.w,t.w=t.v,(t.d=t.d+362437|0)+(t.v=t.v^t.v<<4^(e^e<<1))|0},t.x=0,t.y=0,t.z=0,t.w=0,t.v=0,i===(i|0)?t.x=i:n+=i;for(var f=0;f<n.length+64;f++)t.x^=n.charCodeAt(f)|0,f==n.length&&(t.d=t.x<<10^t.x>>>4),t.next()}function l(i,t){return t.x=i.x,t.y=i.y,t.z=i.z,t.w=i.w,t.v=i.v,t.d=i.d,t}function r(i,t){var n=new c(i),f=t&&t.state,e=function(){return(n.next()>>>0)/4294967296};return e.double=function(){do var h=n.next()>>>11,u=(n.next()>>>0)/4294967296,d=(h+u)/(1<<21);while(d===0);return d},e.int32=n.next,e.quick=e,f&&(typeof f=="object"&&l(f,n),e.state=function(){return l(n,{})}),e}o&&o.exports?o.exports=r:s&&s.amd?s(function(){return r}):this.xorwow=r})(T,p,!1)})(H);var G={exports:{}};(function(p){(function(a,o,s){function c(i){var t=this;t.next=function(){var f=t.x,e=t.i,h,u;return h=f[e],h^=h>>>7,u=h^h<<24,h=f[e+1&7],u^=h^h>>>10,h=f[e+3&7],u^=h^h>>>3,h=f[e+4&7],u^=h^h<<7,h=f[e+7&7],h=h^h<<13,u^=h^h<<9,f[e]=u,t.i=e+1&7,u};function n(f,e){var h,u=[];if(e===(e|0))u[0]=e;else for(e=""+e,h=0;h<e.length;++h)u[h&7]=u[h&7]<<15^e.charCodeAt(h)+u[h+1&7]<<13;for(;u.length<8;)u.push(0);for(h=0;h<8&&u[h]===0;++h);for(h==8&&(u[7]=-1),f.x=u,f.i=0,h=256;h>0;--h)f.next()}n(t,i)}function l(i,t){return t.x=i.x.slice(),t.i=i.i,t}function r(i,t){i==null&&(i=+new Date);var n=new c(i),f=t&&t.state,e=function(){return(n.next()>>>0)/4294967296};return e.double=function(){do var h=n.next()>>>11,u=(n.next()>>>0)/4294967296,d=(h+u)/(1<<21);while(d===0);return d},e.int32=n.next,e.quick=e,f&&(f.x&&l(f,n),e.state=function(){return l(n,{})}),e}o&&o.exports?o.exports=r:s&&s.amd?s(function(){return r}):this.xorshift7=r})(T,p,!1)})(G);var $={exports:{}};(function(p){(function(a,o,s){function c(i){var t=this;t.next=function(){var f=t.w,e=t.X,h=t.i,u,d;return t.w=f=f+1640531527|0,d=e[h+34&127],u=e[h=h+1&127],d^=d<<13,u^=u<<17,d^=d>>>15,u^=u>>>12,d=e[h]=d^u,t.i=h,d+(f^f>>>16)|0};function n(f,e){var h,u,d,y,v,R=[],I=128;for(e===(e|0)?(u=e,e=null):(e=e+"\0",u=0,I=Math.max(I,e.length)),d=0,y=-32;y<I;++y)e&&(u^=e.charCodeAt((y+32)%e.length)),y===0&&(v=u),u^=u<<10,u^=u>>>15,u^=u<<4,u^=u>>>13,y>=0&&(v=v+1640531527|0,h=R[y&127]^=u+v,d=h==0?d+1:0);for(d>=128&&(R[(e&&e.length||0)&127]=-1),d=127,y=4*128;y>0;--y)u=R[d+34&127],h=R[d=d+1&127],u^=u<<13,h^=h<<17,u^=u>>>15,h^=h>>>12,R[d]=u^h;f.w=v,f.X=R,f.i=d}n(t,i)}function l(i,t){return t.i=i.i,t.w=i.w,t.X=i.X.slice(),t}function r(i,t){i==null&&(i=+new Date);var n=new c(i),f=t&&t.state,e=function(){return(n.next()>>>0)/4294967296};return e.double=function(){do var h=n.next()>>>11,u=(n.next()>>>0)/4294967296,d=(h+u)/(1<<21);while(d===0);return d},e.int32=n.next,e.quick=e,f&&(f.X&&l(f,n),e.state=function(){return l(n,{})}),e}o&&o.exports?o.exports=r:s&&s.amd?s(function(){return r}):this.xor4096=r})(T,p,!1)})($);var P={exports:{}};(function(p){(function(a,o,s){function c(i){var t=this,n="";t.next=function(){var e=t.b,h=t.c,u=t.d,d=t.a;return e=e<<25^e>>>7^h,h=h-u|0,u=u<<24^u>>>8^d,d=d-e|0,t.b=e=e<<20^e>>>12^h,t.c=h=h-u|0,t.d=u<<16^h>>>16^d,t.a=d-e|0},t.a=0,t.b=0,t.c=-1640531527,t.d=1367130551,i===Math.floor(i)?(t.a=i/4294967296|0,t.b=i|0):n+=i;for(var f=0;f<n.length+20;f++)t.b^=n.charCodeAt(f)|0,t.next()}function l(i,t){return t.a=i.a,t.b=i.b,t.c=i.c,t.d=i.d,t}function r(i,t){var n=new c(i),f=t&&t.state,e=function(){return(n.next()>>>0)/4294967296};return e.double=function(){do var h=n.next()>>>11,u=(n.next()>>>0)/4294967296,d=(h+u)/(1<<21);while(d===0);return d},e.int32=n.next,e.quick=e,f&&(typeof f=="object"&&l(f,n),e.state=function(){return l(n,{})}),e}o&&o.exports?o.exports=r:s&&s.amd?s(function(){return r}):this.tychei=r})(T,p,!1)})(P);var Z={exports:{}};(function(p){(function(a,o,s){var c=256,l=6,r=52,i="random",t=s.pow(c,l),n=s.pow(2,r),f=n*2,e=c-1,h;function u(x,g,M){var m=[];g=g==!0?{entropy:!0}:g||{};var w=R(v(g.entropy?[x,L(o)]:x==null?I():x,3),m),A=new d(m),F=function(){for(var b=A.g(l),O=t,S=0;b<n;)b=(b+S)*c,O*=c,S=A.g(1);for(;b>=f;)b/=2,O/=2,S>>>=1;return(b+S)/O};return F.int32=function(){return A.g(4)|0},F.quick=function(){return A.g(4)/4294967296},F.double=F,R(L(A.S),o),(g.pass||M||function(b,O,S,E){return E&&(E.S&&y(E,A),b.state=function(){return y(A,{})}),S?(s[i]=b,O):b})(F,w,"global"in g?g.global:this==s,g.state)}function d(x){var g,M=x.length,m=this,w=0,A=m.i=m.j=0,F=m.S=[];for(M||(x=[M++]);w<c;)F[w]=w++;for(w=0;w<c;w++)F[w]=F[A=e&A+x[w%M]+(g=F[w])],F[A]=g;(m.g=function(b){for(var O,S=0,E=m.i,z=m.j,D=m.S;b--;)O=D[E=e&E+1],S=S*c+D[e&(D[E]=D[z=e&z+O])+(D[z]=O)];return m.i=E,m.j=z,S})(c)}function y(x,g){return g.i=x.i,g.j=x.j,g.S=x.S.slice(),g}function v(x,g){var M=[],m=typeof x,w;if(g&&m=="object")for(w in x)try{M.push(v(x[w],g-1))}catch{}return M.length?M:m=="string"?x:x+"\0"}function R(x,g){for(var M=x+"",m,w=0;w<M.length;)g[e&w]=e&(m^=g[e&w]*19)+M.charCodeAt(w++);return L(g)}function I(){try{var x;return h&&(x=h.randomBytes)?x=x(c):(x=new Uint8Array(c),(a.crypto||a.msCrypto).getRandomValues(x)),L(x)}catch{var g=a.navigator,M=g&&g.plugins;return[+new Date,a,M,a.screen,L(o)]}}function L(x){return String.fromCharCode.apply(0,x)}if(R(s.random(),o),p.exports){p.exports=u;try{h=require("crypto")}catch{}}else s["seed"+i]=u})(typeof self!="undefined"?self:T,[],Math)})(Z);var W=j.exports,k=q.exports,Y=H.exports,V=G.exports,J=$.exports,K=P.exports,_=Z.exports;_.alea=W,_.xor128=k,_.xorwow=Y,_.xorshift7=V,_.xor4096=J,_.tychei=K;var N=_;const C={FILL_RATIO:.47,FILL_RATIO_FOOD:.37,THRESHOLD:50,THRESHOLD_FOOD:20,BORDER_SIZE:5},Q={COLONY_RADIUS:3,COLONY_STARTING_ANTS:50,COLONY_MAX_ANTS:5e3,COLONY_MAX_FOOD:3e5,ANT_CREATION_PERIOD:.15,ANT_COST:30,ANT_REFILL_FOOD_AMOUNT:.25};function U(p,a,o){return o()*(a-p)+p}class tt{constructor(a){this.width=a.width,this.height=a.height,this.map=Array.from(Array(this.width),()=>new Array(this.height)),this.foodMap=Array.from(Array(this.width),()=>new Array(this.height)),this.fillRatio=a.fillRatio,this.fillRatioFood=a.fillRatioFood,this.threshold=a.threshold,this.thresholdFood=a.thresholdFood}initialize(a){this.width=a.width,this.height=a.height,this.map=Array.from(Array(this.width),()=>new Array(this.height)),this.foodMap=Array.from(Array(this.width),()=>new Array(this.height)),this.fillRatio=a.fillRatio,this.fillRatioFood=a.fillRatioFood,this.threshold=a.threshold,this.thresholdFood=a.thresholdFood}generateMap(a){if(console.log("Generate Map"),console.log(a),!a)return this.addBorderWalls(),{map:this.map,foodMap:this.foodMap};const o=N(a);this.map=this.randomFillMap(o,this.fillRatio,1),this.clearColonySpace();for(let c=0;c<20;c++)this.map=this.smoothMap(this.map,1);this.addBorderWalls();const s=this.processMap();for(let c=0;c<5;c++)this.map=this.smoothMap(this.map,1);return this.foodMap=this.generateFoodMap(a,s),{map:this.map,foodMap:this.foodMap}}generateMapSteps(a,o){console.log("Generate Map Steps");let s=0;const c=N(a);let l;const r=()=>{if(s==0&&(this.map=this.randomFillMap(c,this.fillRatio,1),o(this.map,this.foodMap,!1)),s==1&&(this.clearColonySpace(),o(this.map,this.foodMap,!1)),s==2)for(let i=0;i<20;i++)this.map=this.smoothMap(this.map,1),o(this.map,this.foodMap,!1);if(s==3&&(this.addBorderWalls(),o(this.map,this.foodMap,!1)),s==4&&(l=this.processMap(),o(this.map,this.foodMap,!1)),s==5)for(let i=0;i<5;i++)this.map=this.smoothMap(this.map,1),o(this.map,this.foodMap,!1);s==6&&(this.foodMap=this.generateFoodMap(a,l),o(this.map,this.foodMap,!0)),s!=7&&(s++,r())};r()}generateFoodMap(a,o){if(console.log("Generate Food Map"),console.log(a),!a)return this.foodMap;for(let r=0;r<this.foodMap.length;r++)for(let i=0;i<this.foodMap[r].length;i++)this.foodMap[r][i]=0;const s=N(a);this.randomFillRegions(s,.5,100,o);for(let r=0;r<5;r++)this.foodMap=this.smoothMap(this.foodMap,100,!0);this.foodMap=this.randomFillMap(s,this.fillRatioFood,100,this.foodMap);for(let r=0;r<20;r++)this.foodMap=this.smoothMap(this.foodMap,100,!1);const c=this.getRegions(this.foodMap,100);if(!c)return this.foodMap;const l=this.thresholdFood;for(const r of c)if(r.length<l)for(const i of r)this.foodMap[i.x][i.y]=0;return this.foodMap}randomFillMap(a,o,s,c){const l=c||Array.from(Array(this.width),()=>new Array(this.height));for(let r=0;r<this.width;r++)for(let i=0;i<this.height;i++){if(s===1&&(r>=0&&r<=C.BORDER_SIZE||r>=this.width-C.BORDER_SIZE&&r<=this.width||i>=0&&i<=C.BORDER_SIZE||i>=this.height-C.BORDER_SIZE&&i<=this.height)){l[r][i]=1;continue}s===100&&this.map[r][i]?l[r][i]=0:s===100&&l[r][i]===100?l[r][i]=100:l[r][i]=U(0,1,a)<o?s===100?100:1:0}return l}randomFillRegions(a,o,s,c){if(!!c){for(const l of c)if(l.roomSize<1e3)for(let r=0;r<l.tiles.length;r++){const i=l.tiles[r];this.foodMap[i.x][i.y]=U(0,1,a)<(l.roomSize<500?1:l.roomSize<1e3?.75:o)?s===100?100:1:0}}}smoothMap(a,o,s=!1){const c=[];for(let l=0;l<a.length;l++)c[l]=a[l].slice();for(let l=0;l<this.width;l++)for(let r=0;r<this.height;r++){const i=this.getNeighbourCount(a,l,r,s);i>4?s?this.map[l][r]||(c[l][r]=100):c[l][r]=o===100?100:1:i<4&&(c[l][r]=0)}return a=c,a}getNeighbourCount(a,o,s,c=!1){let l=0;for(let r=o-1;r<=o+1;r++)for(let i=s-1;i<=s+1;i++)r>=0&&r<this.width&&i>=0&&i<this.height?(r!==o||i!==s)&&(c?l+=this.map[r][i]==1||a[r][i]==100?1:0:l+=a[r][i]==1||a[r][i]==100?1:0):l++;return l}addBorderWalls(){const a=C.BORDER_SIZE;for(let o=0;o<this.width;o++)for(let s=0;s<a;s++)this.map[o][s]=1,this.map[o][this.height-s-1]=1;for(let o=0;o<a;o++)for(let s=0;s<this.height;s++)this.map[o][s]=1,this.map[this.width-o-1][s]=1}processMap(){const a=this.getRegions(this.map,1);if(!a)return;const o=this.threshold;for(const i of a)if(i.length<o)for(const t of i)this.map[t.x][t.y]=0;const s=this.getRegions(this.map,0);if(!s)return;const c=this.threshold,l=[];for(const i of s)if(i.length<c)for(const t of i)this.map[t.x][t.y]=1;else l.push(new B(i,this.map));const r=l;return l.sort((i,t)=>t.roomSize-i.roomSize),l[0].isMainRoom=!0,l[0].isAccessibleFromMainRoom=!0,this.connectClosestRooms(l),r}connectClosestRooms(a,o=!1){let s=[],c=[];if(o)for(const e of a)e.isAccessibleFromMainRoom?c.push(e):s.push(e);else s=a,c=a;let l=0,r={x:0,y:0},i={x:0,y:0},t=new B,n=new B,f=!1;for(const e of s)if(!(!o&&(f=!1,e.connectedRooms.length>0))){for(const h of c)if(!(e==h||e.isConnected(h)))for(let u=0;u<e.edgeTiles.length;u++)for(let d=0;d<h.edgeTiles.length;d++){const y=e.edgeTiles[u],v=h.edgeTiles[d],R=Math.pow(y.x-v.x,2)+Math.pow(y.y-v.y,2);(R<l||!f)&&(l=R,f=!0,r=y,i=v,t=e,n=h)}f&&!o&&this.createPassage(t,n,r,i)}f&&o&&(this.createPassage(t,n,r,i),this.connectClosestRooms(a,!0)),o||this.connectClosestRooms(a,!0)}createPassage(a,o,s,c){a.connectRooms(a,o);const l=this.getLine(s,c);for(const r of l)this.drawCircle(r,2)}drawCircle(a,o){for(let s=-o;s<=o;s++)for(let c=-o;c<=o;c++)if(s*s+c*c<=o*o){const l=a.x+s,r=a.y+c;this.isInMapRange(l,r)&&(this.map[l][r]=0)}}clearColonySpace(){this.drawCircle({x:Math.round(this.width/2),y:Math.round(this.height/2)},Q.COLONY_RADIUS*3)}getLine(a,o){const s=[];let c=a.x,l=a.y;const r=o.x-a.x,i=o.y-a.y;let t=!1,n=Math.sign(r),f=Math.sign(i),e=Math.abs(r),h=Math.abs(i);e<h&&(t=!0,e=Math.abs(i),h=Math.abs(r),n=Math.sign(i),f=Math.sign(r));let u=e/2;for(let d=0;d<e;d++)s.push({x:c,y:l}),t?l+=n:c+=n,u+=h,u>=e&&(t?c+=f:l+=f,u-=e);return s}getRegions(a,o){const s=[],c=Array.from(Array(this.width),()=>new Array(this.height).fill(0));for(let l=0;l<this.width;l++)for(let r=0;r<this.height;r++)if(c[l][r]===0&&a[l][r]===o){const i=this.getRegionCells(a,l,r,o===100);if(!i)return;s.push(i);for(const t of i)c[t.x][t.y]=o===100?100:1}return s}getRegionCells(a,o,s,c){const l=[],r=Array.from(Array(this.width),()=>new Array(this.height).fill(0)),i=a[o][s],t=[];for(t.push({x:o,y:s}),r[o][s]=c?100:1;t.length>0;){const n=t.shift();if(!n)return;l.push(n);for(let f=n.x-1;f<=n.x+1;f++)for(let e=n.y-1;e<=n.y+1;e++)this.isInMapRange(f,e)&&(e===n.y||f===n.x)&&r[f][e]===0&&a[f][e]===i&&(r[f][e]=c?100:1,t.push({x:f,y:e}))}return l}isInMapRange(a,o){return a>=0&&a<this.width&&o>=0&&o<this.height}}class B{constructor(a,o){if(this.isAccessibleFromMainRoom=!1,this.isMainRoom=!1,this.tiles=a!=null?a:[],this.roomSize=this.tiles.length,this.connectedRooms=[],this.edgeTiles=[],!!o)for(const s of this.tiles)for(let c=s.x-1;c<=s.x+1;c++)for(let l=s.y-1;l<=s.y+1;l++)(c==s.x||l==s.y)&&o[c][l]==1&&this.edgeTiles.push(s)}setAccessibleFromMainRoom(){if(!this.isAccessibleFromMainRoom){this.isAccessibleFromMainRoom=!0;for(const a of this.connectedRooms)a.setAccessibleFromMainRoom()}}connectRooms(a,o){a.isAccessibleFromMainRoom?o.setAccessibleFromMainRoom():o.isAccessibleFromMainRoom&&a.setAccessibleFromMainRoom(),a.connectedRooms.push(o),o.connectedRooms.push(a)}isConnected(a){return this.connectedRooms.find(o=>o==a)}}const X=new tt({width:0,height:0,fillRatio:C.FILL_RATIO,fillRatioFood:C.FILL_RATIO_FOOD,threshold:C.THRESHOLD,thresholdFood:C.THRESHOLD_FOOD});self.onmessage=p=>{if(console.log("MapWorker message",p.data),p.data.action==="SETUP"&&X.initialize(p.data.mapGeneratorOptions),p.data.action==="GENERATE")if(console.log("generate map"),p.data.setup){console.log("setup");const{map:a,foodMap:o}=X.generateMap(p.data.seed);postMessage({action:"GENERATE",map:a,foodMap:o,seed:p.data.seed})}else console.log("normal"),X.generateMapSteps(p.data.seed,(a,o,s)=>{postMessage({action:s?"GENERATE":"GENERATE_PARTIAL",map:a,foodMap:o,seed:p.data.seed})})}})();
