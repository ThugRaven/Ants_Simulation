(function(){"use strict";var T=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{},j={exports:{}};(function(p){(function(r,e,s){function c(t){var n=this,f=i();n.next=function(){var o=2091639*n.s0+n.c*23283064365386963e-26;return n.s0=n.s1,n.s1=n.s2,n.s2=o-(n.c=o|0)},n.c=1,n.s0=f(" "),n.s1=f(" "),n.s2=f(" "),n.s0-=f(t),n.s0<0&&(n.s0+=1),n.s1-=f(t),n.s1<0&&(n.s1+=1),n.s2-=f(t),n.s2<0&&(n.s2+=1),f=null}function l(t,n){return n.c=t.c,n.s0=t.s0,n.s1=t.s1,n.s2=t.s2,n}function a(t,n){var f=new c(t),o=n&&n.state,h=f.next;return h.int32=function(){return f.next()*4294967296|0},h.double=function(){return h()+(h()*2097152|0)*11102230246251565e-32},h.quick=h,o&&(typeof o=="object"&&l(o,f),h.state=function(){return l(f,{})}),h}function i(){var t=4022871197,n=function(f){f=String(f);for(var o=0;o<f.length;o++){t+=f.charCodeAt(o);var h=.02519603282416938*t;t=h>>>0,h-=t,h*=t,t=h>>>0,h-=t,t+=h*4294967296}return(t>>>0)*23283064365386963e-26};return n}e&&e.exports?e.exports=a:s&&s.amd?s(function(){return a}):this.alea=a})(T,p,!1)})(j);var q={exports:{}};(function(p){(function(r,e,s){function c(i){var t=this,n="";t.x=0,t.y=0,t.z=0,t.w=0,t.next=function(){var o=t.x^t.x<<11;return t.x=t.y,t.y=t.z,t.z=t.w,t.w^=t.w>>>19^o^o>>>8},i===(i|0)?t.x=i:n+=i;for(var f=0;f<n.length+64;f++)t.x^=n.charCodeAt(f)|0,t.next()}function l(i,t){return t.x=i.x,t.y=i.y,t.z=i.z,t.w=i.w,t}function a(i,t){var n=new c(i),f=t&&t.state,o=function(){return(n.next()>>>0)/4294967296};return o.double=function(){do var h=n.next()>>>11,u=(n.next()>>>0)/4294967296,d=(h+u)/(1<<21);while(d===0);return d},o.int32=n.next,o.quick=o,f&&(typeof f=="object"&&l(f,n),o.state=function(){return l(n,{})}),o}e&&e.exports?e.exports=a:s&&s.amd?s(function(){return a}):this.xor128=a})(T,p,!1)})(q);var H={exports:{}};(function(p){(function(r,e,s){function c(i){var t=this,n="";t.next=function(){var o=t.x^t.x>>>2;return t.x=t.y,t.y=t.z,t.z=t.w,t.w=t.v,(t.d=t.d+362437|0)+(t.v=t.v^t.v<<4^(o^o<<1))|0},t.x=0,t.y=0,t.z=0,t.w=0,t.v=0,i===(i|0)?t.x=i:n+=i;for(var f=0;f<n.length+64;f++)t.x^=n.charCodeAt(f)|0,f==n.length&&(t.d=t.x<<10^t.x>>>4),t.next()}function l(i,t){return t.x=i.x,t.y=i.y,t.z=i.z,t.w=i.w,t.v=i.v,t.d=i.d,t}function a(i,t){var n=new c(i),f=t&&t.state,o=function(){return(n.next()>>>0)/4294967296};return o.double=function(){do var h=n.next()>>>11,u=(n.next()>>>0)/4294967296,d=(h+u)/(1<<21);while(d===0);return d},o.int32=n.next,o.quick=o,f&&(typeof f=="object"&&l(f,n),o.state=function(){return l(n,{})}),o}e&&e.exports?e.exports=a:s&&s.amd?s(function(){return a}):this.xorwow=a})(T,p,!1)})(H);var G={exports:{}};(function(p){(function(r,e,s){function c(i){var t=this;t.next=function(){var f=t.x,o=t.i,h,u;return h=f[o],h^=h>>>7,u=h^h<<24,h=f[o+1&7],u^=h^h>>>10,h=f[o+3&7],u^=h^h>>>3,h=f[o+4&7],u^=h^h<<7,h=f[o+7&7],h=h^h<<13,u^=h^h<<9,f[o]=u,t.i=o+1&7,u};function n(f,o){var h,u=[];if(o===(o|0))u[0]=o;else for(o=""+o,h=0;h<o.length;++h)u[h&7]=u[h&7]<<15^o.charCodeAt(h)+u[h+1&7]<<13;for(;u.length<8;)u.push(0);for(h=0;h<8&&u[h]===0;++h);for(h==8&&(u[7]=-1),f.x=u,f.i=0,h=256;h>0;--h)f.next()}n(t,i)}function l(i,t){return t.x=i.x.slice(),t.i=i.i,t}function a(i,t){i==null&&(i=+new Date);var n=new c(i),f=t&&t.state,o=function(){return(n.next()>>>0)/4294967296};return o.double=function(){do var h=n.next()>>>11,u=(n.next()>>>0)/4294967296,d=(h+u)/(1<<21);while(d===0);return d},o.int32=n.next,o.quick=o,f&&(f.x&&l(f,n),o.state=function(){return l(n,{})}),o}e&&e.exports?e.exports=a:s&&s.amd?s(function(){return a}):this.xorshift7=a})(T,p,!1)})(G);var $={exports:{}};(function(p){(function(r,e,s){function c(i){var t=this;t.next=function(){var f=t.w,o=t.X,h=t.i,u,d;return t.w=f=f+1640531527|0,d=o[h+34&127],u=o[h=h+1&127],d^=d<<13,u^=u<<17,d^=d>>>15,u^=u>>>12,d=o[h]=d^u,t.i=h,d+(f^f>>>16)|0};function n(f,o){var h,u,d,y,v,R=[],I=128;for(o===(o|0)?(u=o,o=null):(o=o+"\0",u=0,I=Math.max(I,o.length)),d=0,y=-32;y<I;++y)o&&(u^=o.charCodeAt((y+32)%o.length)),y===0&&(v=u),u^=u<<10,u^=u>>>15,u^=u<<4,u^=u>>>13,y>=0&&(v=v+1640531527|0,h=R[y&127]^=u+v,d=h==0?d+1:0);for(d>=128&&(R[(o&&o.length||0)&127]=-1),d=127,y=4*128;y>0;--y)u=R[d+34&127],h=R[d=d+1&127],u^=u<<13,h^=h<<17,u^=u>>>15,h^=h>>>12,R[d]=u^h;f.w=v,f.X=R,f.i=d}n(t,i)}function l(i,t){return t.i=i.i,t.w=i.w,t.X=i.X.slice(),t}function a(i,t){i==null&&(i=+new Date);var n=new c(i),f=t&&t.state,o=function(){return(n.next()>>>0)/4294967296};return o.double=function(){do var h=n.next()>>>11,u=(n.next()>>>0)/4294967296,d=(h+u)/(1<<21);while(d===0);return d},o.int32=n.next,o.quick=o,f&&(f.X&&l(f,n),o.state=function(){return l(n,{})}),o}e&&e.exports?e.exports=a:s&&s.amd?s(function(){return a}):this.xor4096=a})(T,p,!1)})($);var P={exports:{}};(function(p){(function(r,e,s){function c(i){var t=this,n="";t.next=function(){var o=t.b,h=t.c,u=t.d,d=t.a;return o=o<<25^o>>>7^h,h=h-u|0,u=u<<24^u>>>8^d,d=d-o|0,t.b=o=o<<20^o>>>12^h,t.c=h=h-u|0,t.d=u<<16^h>>>16^d,t.a=d-o|0},t.a=0,t.b=0,t.c=-1640531527,t.d=1367130551,i===Math.floor(i)?(t.a=i/4294967296|0,t.b=i|0):n+=i;for(var f=0;f<n.length+20;f++)t.b^=n.charCodeAt(f)|0,t.next()}function l(i,t){return t.a=i.a,t.b=i.b,t.c=i.c,t.d=i.d,t}function a(i,t){var n=new c(i),f=t&&t.state,o=function(){return(n.next()>>>0)/4294967296};return o.double=function(){do var h=n.next()>>>11,u=(n.next()>>>0)/4294967296,d=(h+u)/(1<<21);while(d===0);return d},o.int32=n.next,o.quick=o,f&&(typeof f=="object"&&l(f,n),o.state=function(){return l(n,{})}),o}e&&e.exports?e.exports=a:s&&s.amd?s(function(){return a}):this.tychei=a})(T,p,!1)})(P);var W={exports:{}};(function(p){(function(r,e,s){var c=256,l=6,a=52,i="random",t=s.pow(c,l),n=s.pow(2,a),f=n*2,o=c-1,h;function u(x,g,M){var m=[];g=g==!0?{entropy:!0}:g||{};var w=R(v(g.entropy?[x,L(e)]:x==null?I():x,3),m),A=new d(m),F=function(){for(var b=A.g(l),O=t,S=0;b<n;)b=(b+S)*c,O*=c,S=A.g(1);for(;b>=f;)b/=2,O/=2,S>>>=1;return(b+S)/O};return F.int32=function(){return A.g(4)|0},F.quick=function(){return A.g(4)/4294967296},F.double=F,R(L(A.S),e),(g.pass||M||function(b,O,S,E){return E&&(E.S&&y(E,A),b.state=function(){return y(A,{})}),S?(s[i]=b,O):b})(F,w,"global"in g?g.global:this==s,g.state)}function d(x){var g,M=x.length,m=this,w=0,A=m.i=m.j=0,F=m.S=[];for(M||(x=[M++]);w<c;)F[w]=w++;for(w=0;w<c;w++)F[w]=F[A=o&A+x[w%M]+(g=F[w])],F[A]=g;(m.g=function(b){for(var O,S=0,E=m.i,z=m.j,D=m.S;b--;)O=D[E=o&E+1],S=S*c+D[o&(D[E]=D[z=o&z+O])+(D[z]=O)];return m.i=E,m.j=z,S})(c)}function y(x,g){return g.i=x.i,g.j=x.j,g.S=x.S.slice(),g}function v(x,g){var M=[],m=typeof x,w;if(g&&m=="object")for(w in x)try{M.push(v(x[w],g-1))}catch{}return M.length?M:m=="string"?x:x+"\0"}function R(x,g){for(var M=x+"",m,w=0;w<M.length;)g[o&w]=o&(m^=g[o&w]*19)+M.charCodeAt(w++);return L(g)}function I(){try{var x;return h&&(x=h.randomBytes)?x=x(c):(x=new Uint8Array(c),(r.crypto||r.msCrypto).getRandomValues(x)),L(x)}catch{var g=r.navigator,M=g&&g.plugins;return[+new Date,r,M,r.screen,L(e)]}}function L(x){return String.fromCharCode.apply(0,x)}if(R(s.random(),e),p.exports){p.exports=u;try{h=require("crypto")}catch{}}else s["seed"+i]=u})(typeof self!="undefined"?self:T,[],Math)})(W);var U=j.exports,k=q.exports,Y=H.exports,V=G.exports,J=$.exports,K=P.exports,_=W.exports;_.alea=U,_.xor128=k,_.xorwow=Y,_.xorshift7=V,_.xor4096=J,_.tychei=K;var N=_;const C={FILL_RATIO:.47,FILL_RATIO_FOOD:.37,THRESHOLD:50,THRESHOLD_FOOD:20,BORDER_SIZE:5},Q={COLONY_RADIUS:3,COLONY_STARTING_ANTS:50,COLONY_MAX_ANTS:5e3,COLONY_MAX_FOOD:3e5,ANT_CREATION_PERIOD:.15,ANT_COST:30,ANT_REFILL_FOOD_AMOUNT:.25};function Z(p,r,e){return e()*(r-p)+p}class tt{constructor(r){this.width=r.width,this.height=r.height,this.map=Array.from(Array(this.width),()=>new Array(this.height)),this.foodMap=Array.from(Array(this.width),()=>new Array(this.height)),this.fillRatio=r.fillRatio,this.fillRatioFood=r.fillRatioFood,this.threshold=r.threshold,this.thresholdFood=r.thresholdFood}initialize(r){this.width=r.width,this.height=r.height,this.map=Array.from(Array(this.width),()=>new Array(this.height)),this.foodMap=Array.from(Array(this.width),()=>new Array(this.height)),this.fillRatio=r.fillRatio,this.fillRatioFood=r.fillRatioFood,this.threshold=r.threshold,this.thresholdFood=r.thresholdFood}generateMap(r){if(console.log("Generate Map"),console.log(r),!r)return this.addBorderWalls(),{map:this.map,foodMap:this.foodMap};const e=N(r);this.map=this.randomFillMap(e,this.fillRatio,1),this.clearColonySpace();for(let c=0;c<20;c++)this.map=this.smoothMap(this.map,1);this.addBorderWalls();const s=this.processMap();for(let c=0;c<5;c++)this.map=this.smoothMap(this.map,1);return this.foodMap=this.generateFoodMap(r,s),{map:this.map,foodMap:this.foodMap}}generateMapSteps(r,e){console.log("Generate Map Steps");let s=0;const c=N(r);let l;if(!r)return this.addBorderWalls(),e(this.map,this.foodMap,!0);const a=()=>{if(s==0&&(this.map=this.randomFillMap(c,this.fillRatio,1),e(this.map,this.foodMap,!1)),s==1&&(this.clearColonySpace(),e(this.map,this.foodMap,!1)),s==2)for(let i=0;i<20;i++)this.map=this.smoothMap(this.map,1),e(this.map,this.foodMap,!1);if(s==3&&(this.addBorderWalls(),e(this.map,this.foodMap,!1)),s==4&&(l=this.processMap(),e(this.map,this.foodMap,!1)),s==5)for(let i=0;i<5;i++)this.map=this.smoothMap(this.map,1),e(this.map,this.foodMap,!1);s==6&&(this.foodMap=this.generateFoodMap(r,l),e(this.map,this.foodMap,!0)),s!=7&&(s++,a())};a()}generateFoodMap(r,e){if(console.log("Generate Food Map"),console.log(r),!r)return this.foodMap;for(let a=0;a<this.foodMap.length;a++)for(let i=0;i<this.foodMap[a].length;i++)this.foodMap[a][i]=0;const s=N(r);this.randomFillRegions(s,.5,100,e);for(let a=0;a<5;a++)this.foodMap=this.smoothMap(this.foodMap,100,!0);this.foodMap=this.randomFillMap(s,this.fillRatioFood,100,this.foodMap);for(let a=0;a<20;a++)this.foodMap=this.smoothMap(this.foodMap,100,!1);const c=this.getRegions(this.foodMap,100);if(!c)return this.foodMap;const l=this.thresholdFood;for(const a of c)if(a.length<l)for(const i of a)this.foodMap[i.x][i.y]=0;return this.foodMap}randomFillMap(r,e,s,c){const l=c||Array.from(Array(this.width),()=>new Array(this.height));for(let a=0;a<this.width;a++)for(let i=0;i<this.height;i++){if(s===1&&(a>=0&&a<=C.BORDER_SIZE||a>=this.width-C.BORDER_SIZE&&a<=this.width||i>=0&&i<=C.BORDER_SIZE||i>=this.height-C.BORDER_SIZE&&i<=this.height)){l[a][i]=1;continue}s===100&&this.map[a][i]?l[a][i]=0:s===100&&l[a][i]===100?l[a][i]=100:l[a][i]=Z(0,1,r)<e?s===100?100:1:0}return l}randomFillRegions(r,e,s,c){if(!!c){for(const l of c)if(l.roomSize<1e3)for(let a=0;a<l.tiles.length;a++){const i=l.tiles[a];this.foodMap[i.x][i.y]=Z(0,1,r)<(l.roomSize<500?1:l.roomSize<1e3?.75:e)?s===100?100:1:0}}}smoothMap(r,e,s=!1){const c=[];for(let l=0;l<r.length;l++)c[l]=r[l].slice();for(let l=0;l<this.width;l++)for(let a=0;a<this.height;a++){const i=this.getNeighbourCount(r,l,a,s);i>4?s?this.map[l][a]||(c[l][a]=100):c[l][a]=e===100?100:1:i<4&&(c[l][a]=0)}return r=c,r}getNeighbourCount(r,e,s,c=!1){let l=0;for(let a=e-1;a<=e+1;a++)for(let i=s-1;i<=s+1;i++)a>=0&&a<this.width&&i>=0&&i<this.height?(a!==e||i!==s)&&(c?l+=this.map[a][i]==1||r[a][i]==100?1:0:l+=r[a][i]==1||r[a][i]==100?1:0):l++;return l}addBorderWalls(){const r=C.BORDER_SIZE;for(let e=0;e<this.width;e++)for(let s=0;s<r;s++)this.map[e][s]=1,this.map[e][this.height-s-1]=1;for(let e=0;e<r;e++)for(let s=0;s<this.height;s++)this.map[e][s]=1,this.map[this.width-e-1][s]=1}processMap(){const r=this.getRegions(this.map,1);if(!r)return;const e=this.threshold;for(const i of r)if(i.length<e)for(const t of i)this.map[t.x][t.y]=0;const s=this.getRegions(this.map,0);if(!s)return;const c=this.threshold,l=[];for(const i of s)if(i.length<c)for(const t of i)this.map[t.x][t.y]=1;else l.push(new B(i,this.map));const a=l;return l.sort((i,t)=>t.roomSize-i.roomSize),l[0].isMainRoom=!0,l[0].isAccessibleFromMainRoom=!0,this.connectClosestRooms(l),a}connectClosestRooms(r,e=!1){let s=[],c=[];if(e)for(const o of r)o.isAccessibleFromMainRoom?c.push(o):s.push(o);else s=r,c=r;let l=0,a={x:0,y:0},i={x:0,y:0},t=new B,n=new B,f=!1;for(const o of s)if(!(!e&&(f=!1,o.connectedRooms.length>0))){for(const h of c)if(!(o==h||o.isConnected(h)))for(let u=0;u<o.edgeTiles.length;u++)for(let d=0;d<h.edgeTiles.length;d++){const y=o.edgeTiles[u],v=h.edgeTiles[d],R=Math.pow(y.x-v.x,2)+Math.pow(y.y-v.y,2);(R<l||!f)&&(l=R,f=!0,a=y,i=v,t=o,n=h)}f&&!e&&this.createPassage(t,n,a,i)}f&&e&&(this.createPassage(t,n,a,i),this.connectClosestRooms(r,!0)),e||this.connectClosestRooms(r,!0)}createPassage(r,e,s,c){r.connectRooms(r,e);const l=this.getLine(s,c);for(const a of l)this.drawCircle(a,2)}drawCircle(r,e){for(let s=-e;s<=e;s++)for(let c=-e;c<=e;c++)if(s*s+c*c<=e*e){const l=r.x+s,a=r.y+c;this.isInMapRange(l,a)&&(this.map[l][a]=0)}}clearColonySpace(){this.drawCircle({x:Math.round(this.width/2),y:Math.round(this.height/2)},Q.COLONY_RADIUS*3)}getLine(r,e){const s=[];let c=r.x,l=r.y;const a=e.x-r.x,i=e.y-r.y;let t=!1,n=Math.sign(a),f=Math.sign(i),o=Math.abs(a),h=Math.abs(i);o<h&&(t=!0,o=Math.abs(i),h=Math.abs(a),n=Math.sign(i),f=Math.sign(a));let u=o/2;for(let d=0;d<o;d++)s.push({x:c,y:l}),t?l+=n:c+=n,u+=h,u>=o&&(t?c+=f:l+=f,u-=o);return s}getRegions(r,e){const s=[],c=Array.from(Array(this.width),()=>new Array(this.height).fill(0));for(let l=0;l<this.width;l++)for(let a=0;a<this.height;a++)if(c[l][a]===0&&r[l][a]===e){const i=this.getRegionCells(r,l,a,e===100);if(!i)return;s.push(i);for(const t of i)c[t.x][t.y]=e===100?100:1}return s}getRegionCells(r,e,s,c){const l=[],a=Array.from(Array(this.width),()=>new Array(this.height).fill(0)),i=r[e][s],t=[];for(t.push({x:e,y:s}),a[e][s]=c?100:1;t.length>0;){const n=t.shift();if(!n)return;l.push(n);for(let f=n.x-1;f<=n.x+1;f++)for(let o=n.y-1;o<=n.y+1;o++)this.isInMapRange(f,o)&&(o===n.y||f===n.x)&&a[f][o]===0&&r[f][o]===i&&(a[f][o]=c?100:1,t.push({x:f,y:o}))}return l}isInMapRange(r,e){return r>=0&&r<this.width&&e>=0&&e<this.height}}class B{constructor(r,e){if(this.isAccessibleFromMainRoom=!1,this.isMainRoom=!1,this.tiles=r!=null?r:[],this.roomSize=this.tiles.length,this.connectedRooms=[],this.edgeTiles=[],!!e)for(const s of this.tiles)for(let c=s.x-1;c<=s.x+1;c++)for(let l=s.y-1;l<=s.y+1;l++)(c==s.x||l==s.y)&&e[c][l]==1&&this.edgeTiles.push(s)}setAccessibleFromMainRoom(){if(!this.isAccessibleFromMainRoom){this.isAccessibleFromMainRoom=!0;for(const r of this.connectedRooms)r.setAccessibleFromMainRoom()}}connectRooms(r,e){r.isAccessibleFromMainRoom?e.setAccessibleFromMainRoom():e.isAccessibleFromMainRoom&&r.setAccessibleFromMainRoom(),r.connectedRooms.push(e),e.connectedRooms.push(r)}isConnected(r){return this.connectedRooms.find(e=>e==r)}}const X=new tt({width:0,height:0,fillRatio:C.FILL_RATIO,fillRatioFood:C.FILL_RATIO_FOOD,threshold:C.THRESHOLD,thresholdFood:C.THRESHOLD_FOOD});self.onmessage=p=>{if(console.log("MapWorker message",p.data),p.data.action==="SETUP"&&X.initialize(p.data.mapGeneratorOptions),p.data.action==="GENERATE")if(console.log("generate map"),p.data.setup){console.log("setup");const{map:r,foodMap:e}=X.generateMap(p.data.seed);postMessage({action:"GENERATE",map:r,foodMap:e,seed:p.data.seed})}else console.log("normal"),X.generateMapSteps(p.data.seed,(r,e,s)=>{postMessage({action:s?"GENERATE":"GENERATE_PARTIAL",map:r,foodMap:e,seed:p.data.seed})})}})();
